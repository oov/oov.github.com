!function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t,n){"use strict";function r(){return a}function i(e,t){t||(t=a);for(var n=new Uint8Array(e),r=-1,i=0;i<n.length;i++)r=r>>>8^t[255&(r^n[i])];return(-1^r)>>>0}Object.defineProperty(t,"__esModule",{value:!0});var a=new Uint32Array([0,1996959894,-301047508,-1727442502,124634137,1886057615,-379345611,-1637575261,249268274,2044508324,-522852066,-1747789432,162941995,2125561021,-407360249,-1866523247,498536548,1789927666,-205950648,-2067906082,450548861,1843258603,-187386543,-2083289657,325883990,1684777152,-43845254,-1973040660,335633487,1661365465,-99664541,-1928851979,997073096,1281953886,-715111964,-1570279054,1006888145,1258607687,-770865667,-1526024853,901097722,1119000684,-608450090,-1396901568,853044451,1172266101,-589951537,-1412350631,651767980,1373503546,-925412992,-1076862698,565507253,1454621731,-809855591,-1195530993,671266974,1594198024,-972236366,-1324619484,795835527,1483230225,-1050600021,-1234817731,1994146192,31158534,-1731059524,-271249366,1907459465,112637215,-1614814043,-390540237,2013776290,251722036,-1777751922,-519137256,2137656763,141376813,-1855689577,-429695999,1802195444,476864866,-2056965928,-228458418,1812370925,453092731,-2113342271,-183516073,1706088902,314042704,-1950435094,-54949764,1658658271,366619977,-1932296973,-69972891,1303535960,984961486,-1547960204,-725929758,1256170817,1037604311,-1529756563,-740887301,1131014506,879679996,-1385723834,-631195440,1141124467,855842277,-1442165665,-586318647,1342533948,654459306,-1106571248,-921952122,1466479909,544179635,-1184443383,-832445281,1591671054,702138776,-1328506846,-942167884,1504918807,783551873,-1212326853,-1061524307,-306674912,-1698712650,62317068,1957810842,-355121351,-1647151185,81470997,1943803523,-480048366,-1805370492,225274430,2053790376,-468791541,-1828061283,167816743,2097651377,-267414716,-2029476910,503444072,1762050814,-144550051,-2140837941,426522225,1852507879,-19653770,-1982649376,282753626,1742555852,-105259153,-1900089351,397917763,1622183637,-690576408,-1580100738,953729732,1340076626,-776247311,-1497606297,1068828381,1219638859,-670225446,-1358292148,906185462,1090812512,-547295293,-1469587627,829329135,1181335161,-882789492,-1134132454,628085408,1382605366,-871598187,-1156888829,570562233,1426400815,-977650754,-1296233688,733239954,1555261956,-1026031705,-1244606671,752459403,1541320221,-1687895376,-328994266,1969922972,40735498,-1677130071,-351390145,1913087877,83908371,-1782625662,-491226604,2075208622,213261112,-1831694693,-438977011,2094854071,198958881,-2032938284,-237706686,1759359992,534414190,-2118248755,-155638181,1873836001,414664567,-2012718362,-15766928,1711684554,285281116,-1889165569,-127750551,1634467795,376229701,-1609899400,-686959890,1308918612,956543938,-1486412191,-799009033,1231636301,1047427035,-1362007478,-640263460,1088359270,936918e3,-1447252397,-558129467,1202900863,817233897,-1111625188,-893730166,1404277552,615818150,-1160759803,-841546093,1423857449,601450431,-1285129682,-1000256840,1567103746,711928724,-1274298825,-1022587231,1510334235,755167117]);t.getCRCTable=r,t.crc32=i},function(e,t,n){"use strict";function r(e){return e&&3===e.length&&"number"==typeof e[0]&&"string"==typeof e[1]}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){var t=this;this.callbacks=[],this.taskIdCounter=0,this.tasks=new Map,this.worker=new Worker(e),this.worker.onmessage=function(e){if(e.data&&r(e.data)){var n=e.data,i=n[0],a=n[1],o=n[2],s=t.tasks.get(i);if(s){var l=s[a];l&&l(o)}}else{var c=t.callbacks.shift();c&&(c[0](e.data),isNaN(c[2])||t.tasks.delete(c[2]))}},this.worker.onerror=function(e){var n=t.callbacks.shift();n&&(n[1](e),isNaN(n[2])||t.tasks.delete(n[2]))}}return e.prototype.postMessage=function(e,t){var n=this;return new Promise(function(r,i){n.callbacks.push([r,i,NaN]),n.worker.postMessage([NaN,e],t)})},e.prototype.postMessageWithEvent=function(e,t,n){var r=this;return new Promise(function(i,a){var o=++r.taskIdCounter;r.callbacks.push([i,a,o]),r.tasks.set(o,t),r.worker.postMessage([o,e],n)})},Object.defineProperty(e.prototype,"waits",{get:function(){return this.callbacks.length},enumerable:!0,configurable:!0}),e}();t.PromiseWorker=i;var a=function(){function e(e,t,n){this.queueMax=n,this.workers=[];for(var r=0;r<t;++r)this.workers.push(new i(e))}return e.prototype.postMessage=function(e,t){var n=this;return new Promise(function(r,i){var a=function(){for(var o=-1,s=n.queueMax,l=0;l<n.workers.length;++l)n.workers[l].waits<s&&(o=l,s=n.workers[l].waits);if(s<n.queueMax)return void n.workers[o].postMessage(e,t).then(r,i);setTimeout(a,40)};a()})},Object.defineProperty(e.prototype,"waits",{get:function(){return this.workers.map(function(e){return e.waits}).reduce(function(e,t){return e+t})},enumerable:!0,configurable:!0}),e}();t.ThrottlePromiseWorker=a},function(e,t,n){"use strict";function r(e){return e+31>>>5}function i(e,t,n){var r=t>>>5,i=t-(r<<5);n?e[r]|=1<<i:e[r]&=~(1<<i)}function a(e,t){var n=t>>>5,r=t-(n<<5);return 0!=(e[n]&1<<r)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){if(e instanceof ArrayBuffer)return this.buffer=new Uint32Array(e),void(this.length=t||this.buffer.length<<5);this.buffer=new Uint32Array(r(e)),this.length=e}return e.prototype.set=function(e,t){var n=e>>>5,r=e-(n<<5);t?this.buffer[n]|=1<<r:this.buffer[n]&=~(1<<r)},e.prototype.get=function(e){var t=e>>>5,n=e-(t<<5);return 0!=(this.buffer[t]&1<<n)},e}();t.BitArray=o,t.bufferLength=r,t.set=i,t.get=a},function(e,t,n){"use strict";function r(e){var t=new Array(33),n=e.length/32|0;t[0]=0;for(var r=0,i=0,a=0,o=0;r<e.length;++r)a+=e[r],++i===n&&(t[++o]=a,i=0,a=0);for(var s=0,r=1;r<t.length;++r)s=s<<1|(t[r]>t[r-1]?1:0);return s}function i(e){function t(e){return e=(1431655765&e)+(e>>>1&1431655765),e=(858993459&e)+(e>>>2&858993459),e=(252645135&e)+(e>>>4&252645135),(65535&(e=(16711935&e)+(e>>>8&16711935)))+(e>>>16&65535)}return function(n,r){return n===r?0:t(n^e)>t(r^e)?1:-1}}Object.defineProperty(t,"__esModule",{value:!0}),t.calcHash=r,t.getComparer=i},function(e,t,n){"use strict";function r(e,t){var n=e.getElementById(t);if(!n)throw new Error("#"+t+" not found");return n}Object.defineProperty(t,"__esModule",{value:!0}),n(5).polyfill();var i=n(9),a=n(13),o=n(14),s=n(15),l=n(16),c=n(17),u=function(){function e(e,t){this.bar=r(document,"progress-dialog-progress-bar"),this.text=document.createTextNode("");var n=r(document,"progress-dialog-label");n.innerHTML="",n.appendChild(document.createTextNode(e));var i=r(document,"progress-dialog-progress-caption");i.innerHTML="",i.appendChild(this.text),this.update(0,t),this.dialog=jQuery("#progress-dialog"),this.dialog.data("bs.modal")?this.dialog.modal("show"):this.dialog.modal()}return e.prototype.close=function(){this.dialog.modal("hide")},e.prototype.update=function(e,t){var n=Math.min(100,Math.max(0,100*e));this.bar.style.width=n+"%",this.bar.setAttribute("aria-valuenow",n.toFixed(0)+"%"),this.text.data=n.toFixed(0)+"% "+t},e}(),h=function(){function e(e){this.favorite=e}return e.prototype.init=function(){var e=this,t=r(document,"filter-tree");if(!(t instanceof HTMLUListElement))throw new Error("#filter-tree is not an UL element");this.treeRoot=t,this.treeRoot.innerHTML="",this.treeRoot.addEventListener("click",function(t){var n=t.target;if(n instanceof HTMLInputElement){for(var r=n.parentElement;!(r instanceof HTMLLIElement);){if(!r)throw new Error("li tag is not found");r=r.parentElement}for(var i=n.checked,a=r.querySelectorAll("input"),o=0;o<a.length;++o){var s=a[o];s instanceof HTMLInputElement&&(s.checked=i)}if(i)for(var l=r.parentElement;l!==e.treeRoot&&l;l=l.parentElement)if(l instanceof HTMLLIElement){var c=l.querySelector("input");c instanceof HTMLInputElement&&(c.checked=!0)}e.updateClass(),e.update()}},!1);var n=r(document,"use-filter");if(!(n instanceof HTMLInputElement))throw new Error("#filter-tree is not an INPUT element");this.useFilter=n,this.useFilter.addEventListener("click",function(t){e.updateClass(),e.update()},!1);var i=r(document,"filter-dialog");if(!(i instanceof HTMLDivElement))throw new Error("#filter-dialog is not an DIV element");this.dialog=i,jQuery(this.dialog).on("shown.bs.modal",function(t){var n=e.favorite.getAncestorFilters(e.node);"filter"===e.node.type?(e.useFilter.checked=!0,e.root.deserialize(e.node.data?e.node.data.value:"",n)):(e.useFilter.checked=!1,e.root.deserialize("",n)),e.updateClass()})},e.prototype.load=function(e){this.treeRoot||this.init(),this.root=new o.Filter(this.treeRoot,e)},e.prototype.updateClass=function(){this.useFilter.checked?this.treeRoot.classList.remove("disabled"):this.treeRoot.classList.add("disabled");for(var e=this.treeRoot.querySelectorAll("input"),t=0,n=void 0,r=void 0;t<e.length;++t)if((n=e[t])instanceof HTMLInputElement&&n.parentElement){for(r=n.parentElement;r&&r.parentElement&&"LI"!==r.tagName;)r=r.parentElement;n.disabled?r.classList.add("disabled"):r.classList.remove("disabled"),n.checked?r.classList.add("checked"):r.classList.remove("checked")}},e.prototype.update=function(){if(this.useFilter.checked){var e=this.root.serialize();if(e)return void(this.onUpdate&&this.onUpdate(this.node.id||"","filter",e))}this.onUpdate&&this.onUpdate(this.node.id||"","folder","")},e.prototype.show=function(e){this.node=e;var t=jQuery(this.dialog);t.data("bs.modal")?t.modal("show"):t.modal()},e}(),f=function(){function e(e){var t=this;this.favorite=e;var n=r(document,"faview-mode");if(!(n instanceof HTMLSelectElement))throw new Error("#faview-mode is not a SELECT element");this.faviewMode=n,this.faviewMode.addEventListener("change",function(e){return t.update()});var i=r(document,"faview-setting-dialog");if(!(i instanceof HTMLDivElement))throw new Error("#faview-setting-dialog is not an DIV element");this.dialog=i,jQuery(this.dialog).on("shown.bs.modal",function(e){t.faviewMode.selectedIndex=t.favorite.faviewMode})}return e.prototype.update=function(){this.favorite.faviewMode=this.faviewMode.selectedIndex,this.onUpdate&&this.onUpdate()},e}(),d=function(){function e(){this.sideBodyScrollPos={},this.normalModeState=""}return e.prototype.init=function(){var t=this;e.initDropZone("dropzone",function(e){var n;for(n=0;n<e.length;++n)if(".pfv"===e[n].name.substring(e[n].name.length-4).toLowerCase()){t.droppedPFV=e[n];break}for(n=0;n<e.length;++n)if(".pfv"!==e[n].name.substring(e[n].name.length-4).toLowerCase())return void t.loadAndParse(e[n])}),this.initUI(),r(document,"samplefile").addEventListener("click",function(e){var n=r(document,"samplefile").getAttribute("data-filename");n&&t.loadAndParse(n)},!1),window.addEventListener("resize",function(e){return t.resized()},!1),window.addEventListener("hashchange",function(e){return t.hashchanged()},!1),this.hashchanged();for(var n=document.querySelectorAll(".psdtool-loading"),i=0;i<n.length;++i)n[i].classList.add("psdtool-loaded"),n[i].classList.remove("psdtool-loading")},e.prototype.hashchanged=function(){var e=decodeURIComponent(location.hash.substring(1));"load:"===e.substring(0,5)&&this.loadAndParse(e.substring(5))},e.prototype.resized=function(){var e=r(document,"main-container"),t=r(document,"misc-ui"),n=r(document,"preview-container"),i=n.style.display;n.style.display="none",n.style.width=e.clientWidth+"px",n.style.height=e.clientHeight-t.offsetHeight+"px",n.style.display=i;var a=r(document,"side-container"),o=r(document,"side-head"),s=r(document,"side-body");i=s.style.display,s.style.display="none",s.style.width=a.clientWidth+"px",s.style.height=a.clientHeight-o.offsetHeight+"px",s.style.display=i;for(var l=document.querySelectorAll(".psdtool-tab-toolbar"),c=0;c<l.length;++c){var u=l[c];if(u instanceof HTMLElement){for(var h=u.parentElement;h&&!h.classList.contains("psdtool-tab-pane");)h=h.parentElement;h&&(h.style.paddingTop=u.clientHeight+"px")}}},e.prototype.loadAndParse=function(t){var n=this,i=r(document,"file-open-ui"),a=r(document,"error-report-ui"),o=r(document,"main");i.style.display="block",a.style.display="none",o.style.display="none",Mousetrap.pause();var s=r(document,"error-message"),l=document.createTextNode("");s.innerHTML="",s.appendChild(l);var c=new u("Loading...","Getting ready...");e.loadAsBlob(function(e){return c.update(e,"Receiving file...")},t).then(function(e){return n.parse(function(e){return c.update(e,"Loading file...")},e)}).then(function(){c.close(),i.style.display="none",a.style.display="none",o.style.display="block",Mousetrap.unpause(),n.resized()},function(e){c.close(),i.style.display="block",a.style.display="block",o.style.display="none",Mousetrap.pause(),l.data=e.toString(),console.error(e)})},e.prototype.parse=function(e,t){var n=this;return new Promise(function(i,a){PSD.parseWorker(t.buffer,e,function(e){try{n.psdRoot=e,n.loadLayerTree(e),n.filterDialog.load(e),n.loadRenderer(e),n.maxPixels.value=(n.optionAutoTrim.checked?n.renderer.Height:n.renderer.CanvasHeight).toString(),n.seqDlPrefix.value=t.name,n.seqDlNum.value="0";for(var o=document.querySelectorAll(".psdtool-show-readme"),s=0,l=void 0;s<o.length;++s)(l=o[s])instanceof HTMLElement&&(""!==e.Readme?l.classList.remove("hidden"):l.classList.add("hidden"));if(r(document,"readme").textContent=e.Readme,n.favorite.psdHash=e.Hash,n.droppedPFV){var c=new FileReader;c.onload=function(){n.favorite.loadFromArrayBuffer(c.result)},c.readAsArrayBuffer(n.droppedPFV)}else{var u=n.favorite.getPFVFromLocalStorage(e.Hash);u&&u.time/1e3>e.PFVModDate?n.favorite.loadFromString(u.data,u.id):e.PFV&&n.favorite.loadFromString(e.PFV)}n.redraw(),i()}catch(e){a(e)}},function(e){return a(e)})})},e.prototype.pfvOnDrop=function(e){var t=this;this.leaveReaderMode();var n,r;for(n=0;n<e.length;++n){var i=function(){if(".pfv"===(r=e[n].name.substring(e[n].name.length-4).toLowerCase())){var i=new FileReader;return i.onload=function(e){t.favorite.loadFromArrayBuffer(i.result)&&jQuery("#import-dialog").modal("hide")},i.readAsArrayBuffer(e[n]),{value:void 0}}}();if("object"==typeof i)return i.value}},e.prototype.initFavoriteUI=function(){var t=this,n=r(document,"favorite-tree");this.favorite=new a.Favorite(n,n.getAttribute("data-root-name")||"My Favorites"),this.favorite.onModified=function(){t.needRefreshFaview=!0},this.favorite.onLoaded=function(){switch(t.startFaview(),t.favorite.faviewMode){case 0:t.toggleTreeFaview(!1);break;case 1:t.faview.closed||t.toggleTreeFaview(!0);break;case 2:t.faview.closed||(t.toggleTreeFaview(!0),""!==t.psdRoot.Readme&&jQuery("#readme-dialog").modal("show"))}},this.favorite.onClearSelection=function(){return t.leaveReaderMode()},this.favorite.onSelect=function(e){if("item"!==e.type||!e.data)return void t.leaveReaderMode();try{t.enterReaderMode(e.data.value,t.favorite.getFirstFilter(e),e.text+".png")}catch(e){console.error(e),alert(e)}},this.favorite.onDoubleClick=function(e){try{switch(e.type){case"item":e.data&&t.leaveReaderMode(e.data.value,t.favorite.getFirstFilter(e));break;case"folder":case"filter":t.filterDialog.show(e)}}catch(e){console.error(e),alert(e)}},this.filterDialog=new h(this.favorite),this.filterDialog.onUpdate=function(e,n,r){t.favorite.update(e,{type:n,data:{value:r}}),t.favorite.updateLocalStorage(),t.needRefreshFaview=!0},jQuery("button[data-psdtool-tree-add-item]").on("click",function(e){t.leaveReaderMode(),t.favorite.addItem(t.layerRoot.serialize(!1),void 0,!0)}),Mousetrap.bind("mod+b",function(e){e.preventDefault();var n=document.querySelector("button[data-psdtool-tree-add-item]"),r=n?n.getAttribute("data-caption"):null,i=prompt(r||"item name",t.lastCheckedNode?t.lastCheckedNode.displayName:"New Item");null!==i&&(t.leaveReaderMode(),t.favorite.addItem(t.layerRoot.serialize(!1),i,!1))}),jQuery("button[data-psdtool-tree-add-folder]").on("click",function(e){t.favorite.addFolder(void 0,!0)}),Mousetrap.bind("mod+d",function(e){e.preventDefault();var n=document.querySelector("button[data-psdtool-tree-add-folder]"),r=n?n.getAttribute("data-caption"):null,i=prompt(r||"item name","New Folder");null!==i&&(t.favorite.clearSelection(),t.favorite.addFolder(i,!0))}),jQuery("button[data-psdtool-tree-rename]").on("click",function(e){return t.favorite.edit()}),Mousetrap.bind("f2",function(e){e.preventDefault(),t.favorite.edit()}),jQuery("button[data-psdtool-tree-remove]").on("click",function(e){return t.favorite.remove()}),Mousetrap.bind("shift+mod+g",function(e){var n=e.target;if(n instanceof HTMLElement&&n.classList.contains("psdtool-layer-visible")){if(e.preventDefault(),!n.classList.contains("psdtool-layer-radio"))return;if(n instanceof HTMLInputElement){for(var r=t.layerRoot.serialize(!0),i=[],a=void 0,o=document.querySelectorAll('input[name="'+n.name+'"].psdtool-layer-radio'),s=0;s<o.length;++s)a=t.layerRoot.nodes[parseInt(o[s].getAttribute("data-seq")||"0",10)],a.li.classList.contains("psdtool-item-flip-x")||a.li.classList.contains("psdtool-item-flip-y")||a.li.classList.contains("psdtool-item-flip-xy")||(a.checked=!0,t.favorite.addItem(t.layerRoot.serialize(!1),a.displayName,!1),i.push(a.displayName));t.layerRoot.deserialize(r),t.redraw(),alert(i.length+" favorite item(s) has been added.\n\n"+i.join("\n"))}}}),e.initDropZone("pfv-dropzone",function(e){return t.pfvOnDrop(e)}),e.initDropZone("pfv-dropzone2",function(e){return t.pfvOnDrop(e)}),jQuery("#import-dialog").on("shown.bs.modal",function(n){var i=r(document,"pfv-recents");i.innerHTML="";for(var o,s=t.favorite.getPFVListFromLocalStorage(),l=s.length-1;l>=0;--l)o=document.createElement("button"),o.type="button",o.className="list-group-item",s[l].hash===t.psdRoot.Hash&&(o.className+=" list-group-item-info"),o.setAttribute("data-dismiss","modal"),function(e,n,r){e.addEventListener("click",function(e){t.leaveReaderMode(),t.favorite.loadFromString(n,r)},!1)}(o,s[l].data,s[l].id),o.appendChild(document.createTextNode(a.countEntries(s[l].data)+" item(s) / Created at "+e.formateDate(new Date(s[l].time)))),i.appendChild(o)}),jQuery("#bulk-create-folder-dialog").on("shown.bs.modal",function(e){return t.bulkCreateFolderTextarea.focus()});var i=r(document,"bulk-create-folder-textarea");if(!(i instanceof HTMLTextAreaElement))throw new Error("element not found: #bulk-create-folder-textarea");this.bulkCreateFolderTextarea=i,r(document,"bulk-create-folder").addEventListener("click",function(e){for(var n=[],r=0,i=t.bulkCreateFolderTextarea.value.replace(/\r/g,"").split("\n");r<i.length;r++){var a=i[r];a=a.trim(),""!==a&&n.push(a)}t.favorite.addFolders(n),t.bulkCreateFolderTextarea.value=""},!1);var o=new Map;jQuery("#bulk-rename-dialog").on("shown.bs.modal",function(e){o.clear();var n=function(e,t){for(var r=0,i=t;r<i.length;r++){var a=i[r],s=document.createElement("input");o.set(s,a),s.className="form-control",s.value=a.text,function(e){e.onblur=function(t){var n=o.get(e);n&&(n.text=e.value.trim())}}(s);var l=document.createElement("li");l.appendChild(s);var c=document.createElement("ul");l.appendChild(c),n(c,a.children),e.appendChild(l)}},i=r(document,"bulk-rename-tree");t.bulkRenameData=t.favorite.renameNodes,i.innerHTML="",n(i,t.bulkRenameData)}),r(document,"bulk-rename").addEventListener("click",function(e){var n=1,i=r(document,"rename-digits");i instanceof HTMLSelectElement&&(n=parseInt(i.value,10));var a=0,i=r(document,"rename-start-number");i instanceof HTMLInputElement&&(a=parseInt(i.value,10));for(var s=r(document,"bulk-rename-tree").querySelectorAll("input"),l=0;l<s.length;++l){var i=s[l];if(i instanceof HTMLInputElement&&""===i.value){i.value=("0000"+a.toString()).slice(-n);var c=o.get(i);c&&(c.text=i.value),++a}}t.favorite.bulkRename(t.bulkRenameData)},!1),r(document,"export-favorites-pfv").addEventListener("click",function(n){saveAs(new Blob([t.favorite.pfv],{type:"text/plain"}),e.cleanForFilename(t.favorite.rootName)+".pfv")},!1),r(document,"export-favorites-zip").addEventListener("click",function(e){t.exportZIP(!1)},!1),r(document,"export-favorites-zip-filter-solo").addEventListener("click",function(e){t.exportZIP(!0)},!1);for(var s=document.querySelectorAll("[data-export-faview]"),l=0;l<s.length;++l)!function(e){e.addEventListener("click",function(n){if("prima2"===e.getAttribute("data-export-faview"))return void t.exportFaviewPRIMA2();t.exportFaview("standard"===e.getAttribute("data-export-faview"),"flat"===e.getAttribute("data-structure"))})}(s[l]);r(document,"export-tiled").addEventListener("click",function(e){var n=r(document,"tiled-export-naming-rule");if(!(n instanceof HTMLSelectElement))throw new Error("#tiled-export-naming-rule is not SELECT");var i=r(document,"tiled-export-format");if(!(i instanceof HTMLSelectElement))throw new Error("#tiled-export-format is not SELECT");var a=r(document,"tiled-export-usetsx");if(!(a instanceof HTMLSelectElement))throw new Error("#tiled-export-usetsx is not SELECT");var o=r(document,"tiled-export-compress");if(!(o instanceof HTMLSelectElement))throw new Error("#tiled-export-compress is not SELECT");var s=n.value.split(","),l=i.value.split(","),c="yes"===a.value,u="deflate"===o.value;if(2!==s.length||2!==l.length)throw new Error("tiled export form data is invalid");t.exportFaviewTiled(s[0],"flat"===s[1],l[0],l[1],u,c)},!1),r(document,"export-layer-structure").addEventListener("click",function(e){saveAs(new Blob([t.layerRoot.text],{type:"text/plain"}),"layer.txt")},!1);for(var c=document.querySelectorAll(".psdtool-toggle-tree-faview"),l=0;l<c.length;++l)c[l].addEventListener("click",function(e){return t.toggleTreeFaview()},!1);this.faviewSettingDialog=new f(this.favorite),this.faviewSettingDialog.onUpdate=function(){return t.favorite.updateLocalStorage()}},e.prototype.toggleTreeFaview=function(e){var t=r(document,"layer-tree-pane");void 0===e&&(e=!t.classList.contains("faview-active")),e?(t.classList.add("faview-active"),this.faviewOnRootChanged()):t.classList.remove("faview-active")},e.prototype.startFaview=function(){var e=this;if(this.resized(),!this.faview){var t=void 0,n=void 0,i=r(document,"faview-root-node");if(!(i instanceof HTMLSelectElement))throw new Error("element not found: #faview-root-node");t=i;var i=r(document,"faview-tree");if(!(i instanceof HTMLUListElement))throw new Error("element not found: #faview-tree");n=i,this.faview=new a.Faview(this.favorite,t,n),this.faview.onRootChanged=function(){return e.faviewOnRootChanged()},this.faview.onChange=function(t){return e.faviewOnChange(t)}}r(document,"layer-tree-toolbar").classList.remove("hidden"),this.faview.start(),this.needRefreshFaview=!1,0===this.faview.roots?this.endFaview():this.resized()},e.prototype.refreshFaview=function(){this.faview&&!this.faview.closed||this.startFaview(),this.needRefreshFaview&&(this.faview.refresh(),this.needRefreshFaview=!1,0===this.faview.roots&&this.endFaview())},e.prototype.faviewOnRootChanged=function(){this.leaveReaderMode();for(var e=0,t=this.faview.getActive();e<t.length;e++){var n=t[e];n.data&&this.layerRoot.deserializePartial(void 0,n.data.value,this.favorite.getFirstFilter(n))}this.redraw()},e.prototype.faviewOnChange=function(e){e.data&&this.leaveReaderMode(e.data.value,this.favorite.getFirstFilter(e))},e.prototype.endFaview=function(){r(document,"layer-tree-toolbar").classList.add("hidden"),this.toggleTreeFaview(!1),this.resized(),this.faview.close()},e.prototype.exportZIP=function(t){var n=this,r=[],i=[],a=[],o=function(t){for(var s=0,l=t;s<l.length;s++){var c=l[s];switch("string"==typeof c&&(c=n.favorite.get(c)),i.push(e.cleanForFilename(c.text.replace(/^\*/,""))),c.type){case"root":i.pop(),c.children&&c.children.length&&o(c.children),i.push("");break;case"folder":case"filter":r.unshift(c),c.children&&c.children.length&&o(c.children),r.shift();break;case"item":for(var u=void 0,h=0,f=r;h<f.length;h++){var d=f[h];if("filter"===d.type){u=d.data?d.data.value:"";break}}u?a.push({name:i.join("\\")+".png",value:c.data?c.data.value:"",filter:u}):a.push({name:i.join("\\")+".png",value:c.data?c.data.value:""});break;default:throw new Error("unknown item type: "+c.type)}i.pop()}},s=this.favorite.json;o(s);var c=this.layerRoot.serialize(!0),h=new l.Zipper,f=new u("Exporting...",""),d=!1,p=function(e,t){h.dispose(function(e){}),console.error(t),d||alert(e+": "+t),f.close()};window.addEventListener("unload",function(){d=!0},!1);var v=0,g=function(){if(++v<a.length+1)return void f.update(v/(a.length+1),1===v?"drawing...":"("+v+"/"+a.length+") "+a[v-1].name);n.layerRoot.deserialize(c),f.update(1,"building a zip..."),h.generate(function(t){f.close(),saveAs(t,e.cleanForFilename(n.favorite.rootName)+".zip"),h.dispose(function(e){})},function(e){return p("cannot create a zip archive",e)})};h.init(function(){h.addCompress("favorites.pfv",new Blob([n.favorite.pfv],{type:"text/plain; charset=utf-8"}),g,function(e){return p("cannot write pfv to a zip archive",e)});var r=0,i=function(){"filter"in a[r]?n.layerRoot.deserializePartial(t?"":c,a[r].value,a[r].filter||""):n.layerRoot.deserialize(a[r].value),n.render(function(t,n){1===t&&e.canvasToBlob(n).then(function(e){h.add(a[r].name,e,g,function(e){return p("cannot write png to a zip archive",e)}),++r<a.length&&setTimeout(i,0)})})};i()},function(e){return p("cannot create a zip archive",e)})},e.prototype.exportFaview=function(t,n){var r=this,i=new l.Zipper,a=new u("Exporting...",""),o=!1,s=function(e,t){i.dispose(function(e){}),a.close(),console.error(t),o||alert(e+": "+t)};window.addEventListener("unload",function(){o=!0},!1),i.init(function(){r.enumerateFaview(function(r,o,l,c,u){var h=r.map(function(n,r){return e.cleanForFilename((r&&t?n.caption+"-":"")+n.name)}).join(n?"_":"\\")+".png";e.canvasToBlob(o).then(function(e){i.add(h,e,u,function(e){return s("cannot write png to a zip archive",e)})}),a.update(l/c,h)},function(){a.update(1,"building a zip..."),i.generate(function(e){saveAs(e,"simple-view.zip"),i.dispose(function(e){}),a.close()},function(e){return s("cannot create a zip archive",e)})})},function(e){return s("cannot create a zip archive",e)})},e.prototype.exportFaviewTiled=function(t,n,r,i,a,o){var c,h=this;switch(r){case"tmx":c="tmx";break;case"json":c="json";break;case"js":c="js";break;case"raw":switch(i){case"csv":c="csv";break;case"bin":c="bin"}}var f=new l.Zipper,d=new s.Tileder,p=new u("Exporting...",""),v=!1,g=function(e,t){f.dispose(function(e){}),p.close(),console.error(t),v||alert(e+": "+t)};window.addEventListener("unload",function(){v=!0},!1);var m=0,w=0,y=!1,b=function(){++w,y&&w===m&&(p.update(1,"building a zip..."),f.generate(function(e){saveAs(e,"tiled.zip"),f.dispose(function(e){}),p.close()},function(e){return g("cannot create a zip archive",e)}))};f.init(function(){h.enumerateFaview(function(r,i,a,o,s){var l=r.map(function(n,r){switch(t){case"standard":return e.cleanForFilename((r?n.caption+"-":"")+n.name);case"compact":return e.cleanForFilename(n.name);case"index":return n.index}}).join(n?"_":"\\");p.update(a/o/2,l),d.add(l,i,s)},function(){d.finish("binz"===i,function(t,n,r){++m,e.canvasToBlob(t.getImage(document)).then(function(e){f.add(t.filename+".png",e,function(){p.update(.5,t.filename+".png"),b(),o&&(++m,f.addCompress(t.filename+".tsx",new Blob([t.export()],{type:"text/xml; charset=utf-8"}),function(){p.update(.5,t.filename+".tsx"),b()},function(e){return g("cannot write tsx to a zip archive",e)}))},function(e){return g("cannot write png to a zip archive",e)})})},function(e,t,n){var s=a?f.addCompress:f.add;s=s.bind(f),++m,s(e.name+"."+c,e.export(r,i,o),function(){p.update(t/n/2+.5,e.name+"."+c),b()},function(e){return g("cannot write file to a zip archive",e)})},function(){++m,y=!0,b()})});var l={format:c,flatten:n,namingStyle:t,roots:h.faview.items.map(function(t){return{name:t.name,captions:t.selects.map(function(t){return e.cleanForFilename(t.caption)}),selects:t.selects.map(function(t){return t.items.map(function(t){return e.cleanForFilename(t.name)})})}})};"js"===r?(++m,f.addCompress("faview.js",new Blob(["onFaviewLoaded(",JSON.stringify(l),");"],{type:"text/javascript; charset=utf-8"}),function(){return b()},function(e){return g("cannot write faview.js to a zip archive",e)}),++m,f.addCompress("viewer.html",new Blob([s.getViewer()],{type:"text/html; charset=utf-8"}),function(){return b()},function(e){return g("cannot write viewer.html to a zip archive",e)})):(++m,f.addCompress("faview.json",new Blob([JSON.stringify(l)],{type:"application/json; charset=utf-8"}),function(){return b()},function(e){return g("cannot write faview.json to a zip archive",e)}))},function(e){return g("cannot create a zip archive",e)})},e.prototype.exportFaviewPRIMA2=function(){var t=this,n=this.layerRoot.serialize(!0),r=new u("Exporting...",""),i=function(e,n,r){return new Promise(function(i){t.layerRoot.deserialize(e),r.forEach(function(e,r){var i=n[r];if(-1===i){var a=t.favorite.get(e.valueByIndex(0));t.layerRoot.deserializePartial(void 0,"",t.favorite.getFirstFilter(a))}else{var a=t.favorite.get(e.valueByIndex(i));t.layerRoot.deserializePartial(void 0,a.data?a.data.value:"",t.favorite.getFirstFilter(a))}}),t.render(function(e,t){var n=document.createElement("canvas");n.width=t.width,n.height=t.height;var r=n.getContext("2d");if(!(r instanceof CanvasRenderingContext2D))throw new Error("could not get canvas context");r.drawImage(t,0,0),1===e&&i(n)})})},a=this.faview.items.map(function(t){return{name:t.name,captions:t.selects.map(function(t){return e.cleanForFilename(t.caption)}),selects:t.selects.map(function(t){return t.items.map(function(t){return e.cleanForFilename(t.name)})}),render:function(e){return i(n,e,t.selects)},renderSolo:function(e){return i("",e,t.selects)}}});c.default(16,a[0].captions,a[0].selects,a[0].render,a[0].renderSolo,function(e,t,n){return new Promise(function(i){r.update(t/n,"Phase "+(e+1)+"/3: "+t+"/"+n),requestAnimationFrame(function(){return i()})})}).then(function(e){saveAs(e,"tiled.prima"),r.close(),t.layerRoot.deserialize(n)})},e.prototype.enumerateFaview=function(e,t){var n=this;this.refreshFaview();for(var r=this.faview.items,i=0,a=0,o=r;a<o.length;a++){var s=o[a];if(s.selects.length){for(var l=1,c=0,u=s.selects;c<u.length;c++){l*=u[c].items.length}i+=l}}if(i){var h,f=this.layerRoot.serialize(!0),d=0,p=[],v=function(t,r,a){var o=h[t],s=o.items[r];p.push({caption:o.caption,name:s.name,index:r});var l=n.favorite.get(s.value);n.layerRoot.deserializePartial(void 0,l.data?l.data.value:"",n.favorite.getFirstFilter(l));var c=function(){p.pop(),r<o.items.length-1?v(t,r+1,a):a()};t<h.length-1?h[t+1].items.length?v(t+1,0,c):c():n.render(function(t,n){1===t&&e(p,n,++d,i,c)})},g=function(e,t){var n=r[e];p.push({caption:"root",name:n.name,index:e}),h=n.selects;var i=function(){p.pop(),++e>=r.length?t():g(e,t)};h.length&&h[0].items.length?v(0,0,i):i()};g(0,function(){n.layerRoot.deserialize(f),t()})}},e.prototype.initUI=function(){var t=this;this.optionAutoTrim=e.getInputElement("#option-auto-trim"),this.optionSafeMode=e.getInputElement("#option-safe-mode");var n=document.querySelectorAll(".psdtool-tab-toolbar");this.sideBody=r(document,"side-body"),this.sideBody.addEventListener("scroll",function(e){for(var r=t.sideBody.scrollTop+"px",i=0;i<n.length;++i){var a=n[i];a instanceof HTMLElement&&(a.style.top=r)}},!1),this.sideBodyScrollPos={},jQuery('a[data-toggle="tab"]').on("hide.bs.tab",function(e){var n=e.target.getAttribute("href");n&&(t.sideBodyScrollPos[n]={left:t.sideBody.scrollLeft,top:t.sideBody.scrollTop})}).on("shown.bs.tab",function(e){var n=e.target.getAttribute("href");n&&(n in t.sideBodyScrollPos&&(t.sideBody.scrollLeft=t.sideBodyScrollPos[n].left,t.sideBody.scrollTop=t.sideBodyScrollPos[n].top),t.resized())}),jQuery('a[data-toggle="tab"][href="#layer-tree-pane"]').on("show.bs.tab",function(e){t.leaveReaderMode(),t.refreshFaview()}),this.initFavoriteUI(),this.previewBackground=r(document,"preview-background");var i=r(document,"preview");if(!(i instanceof HTMLCanvasElement))throw new Error("element not found: #preview");this.previewCanvas=i,this.previewCanvas.addEventListener("dragstart",function(e){var n=t.previewCanvas.toDataURL(),r=t.previewCanvas.getAttribute("data-filename");if(r){var i=n.indexOf(";");n=n.substring(0,i)+";filename="+encodeURIComponent(r)+n.substring(i)}try{e.dataTransfer.setData("text",n),e.dataTransfer.setData("text/uri-list",n),e.dataTransfer.setData("text/plain",n)}catch(e){}},!1),jQuery("#main").on("splitpaneresize",function(e){return t.resized()}).splitPane();var a=r(document,"flip-x");a instanceof HTMLInputElement&&(this.flipX=a),jQuery(this.flipX).on("change",function(e){return t.redraw()});var o=r(document,"flip-y");o instanceof HTMLInputElement&&(this.flipY=o),jQuery(this.flipY).on("change",function(e){return t.redraw()});var s=r(document,"fixed-side");if(!(s instanceof HTMLSelectElement))throw new Error("element not found: #fixed-side");this.fixedSide=s,this.fixedSide.addEventListener("change",function(e){return t.redraw()},!1);var l;this.maxPixels=e.getInputElement("#max-pixels"),this.maxPixels.addEventListener("blur",function(n){var r=e.normalizeNumber(t.maxPixels.value);r!==l&&(l=r,t.maxPixels.value=r,t.redraw())},!1),this.seqDlPrefix=e.getInputElement("#seq-dl-prefix"),this.seqDlNum=e.getInputElement("#seq-dl-num");var c=r(document,"seq-dl");if(!(c instanceof HTMLButtonElement))throw new Error("element not found: #seq-dl");this.seqDl=c,this.seqDl.addEventListener("click",function(n){var r=t.seqDlPrefix.value;if(""===t.seqDlNum.value)return void t.save(r+".png");var i=parseInt(e.normalizeNumber(t.seqDlNum.value),10);i<0&&(i=0),t.save(r+("0000"+i).slice(-4)+".png"),t.seqDlNum.value=(i+1).toString()},!1),Mousetrap.pause()},e.prototype.redraw=function(){var e=this;this.seqDl.disabled=!0,this.render(function(t,n){e.previewBackground.style.width=n.width+"px",e.previewBackground.style.height=n.height+"px",e.seqDl.disabled=1!==t,e.previewCanvas.draggable=1===t,setTimeout(function(){e.previewCanvas.width=n.width,e.previewCanvas.height=n.height;var t=e.previewCanvas.getContext("2d");if(!t)throw new Error("cannot get CanvasRenderingContext2D");t.drawImage(n,0,0)},0)}),this.layerRoot.updateClass()},e.prototype.save=function(t){e.canvasToBlob(this.previewCanvas).then(function(e){saveAs(e,t)})},e.prototype.loadRenderer=function(e){this.renderer=new i.Renderer(e);var t=this.layerRoot.nodes,n=this.renderer.nodes;for(var r in n)n.hasOwnProperty(r)&&function(e,t){e.getVisibleState=function(){return t.checked}}(n[r],t[r])},e.prototype.render=function(e){var t=this.optionAutoTrim.checked,n=t?this.renderer.Width:this.renderer.CanvasWidth,r=t?this.renderer.Height:this.renderer.CanvasHeight,i=parseInt(this.maxPixels.value,10),a=1;switch(this.fixedSide.value){case"w":n>i&&(a=i/n);break;case"h":r>i&&(a=i/r)}(n*a<1||r*a<1)&&(a=n>r?1/r:1/n);var o,s;this.flipX.checked?this.flipY.checked?(o=3,s=3):(o=1,s=1):this.flipY.checked?(o=2,s=2):(o=0,s=0),this.layerRoot.flip!==o&&(this.layerRoot.flip=o),this.renderer.render(a,t,s,e)},e.prototype.initLayerTree=function(){var e=this,t=r(document,"layer-tree");if(!(t instanceof HTMLUListElement))throw new Error("#layer-tree is not an UL element");this.layerTree=t,this.layerTree.innerHTML="",this.layerTree.addEventListener("click",function(t){var n=t.target;if(n instanceof HTMLInputElement&&n.classList.contains("psdtool-layer-visible")){var r=e.layerRoot.nodes[parseInt(n.getAttribute("data-seq")||"0",10)];n.checked&&(e.lastCheckedNode=r);for(var i=r.parent;!i.isRoot;i=i.parent)i.checked=!0;r.clippedBy&&(r.clippedBy.checked=!0),e.redraw()}},!1)},e.prototype.loadLayerTree=function(e){this.layerTree||this.initLayerTree(),this.layerRoot=new o.LayerTree(this.optionSafeMode.checked,this.layerTree,e)},e.prototype.enterReaderMode=function(e,t,n){this.previewBackground.classList.contains("reader")||(this.previewBackground.classList.add("reader"),this.normalModeState=this.layerRoot.serialize(!0)),t?this.layerRoot.deserializePartial(this.normalModeState,e,t):this.layerRoot.deserialize(e),n&&this.previewCanvas.setAttribute("data-filename",n),this.redraw()},e.prototype.leaveReaderMode=function(e,t){if(this.previewBackground.classList.contains("reader")&&this.previewBackground.classList.remove("reader"),e)this.previewCanvas.removeAttribute("data-filename"),t?this.normalModeState?this.layerRoot.deserializePartial(this.normalModeState,e,t):this.layerRoot.deserializePartial(void 0,e,t):this.layerRoot.deserialize(e);else{if(!this.normalModeState)return;this.previewCanvas.removeAttribute("data-filename"),this.layerRoot.deserialize(this.normalModeState)}this.redraw(),this.normalModeState=""},e.getInputElement=function(e){var t=document.querySelector(e);if(t instanceof HTMLInputElement)return t;throw new Error("element not found "+e)},e.cleanForFilename=function(e){return e.replace(/[\x00-\x1f\x22\x2a\x2f\x3a\x3c\x3e\x3f\x7c\x7f]+/g,"_")},e.formateDate=function(e){var t=e.getFullYear()+"-";return t+=("0"+(e.getMonth()+1)).slice(-2)+"-",t+=("0"+e.getDate()).slice(-2)+" ",t+=("0"+e.getHours()).slice(-2)+":",t+=("0"+e.getMinutes()).slice(-2)+":",t+=("0"+e.getSeconds()).slice(-2)},e.extractFilePrefixFromUrl=function(e){return e=e.replace(/#[^#]*$/,""),e=e.replace(/\?[^?]*$/,""),e=e.replace(/^.*?([^\/]+)$/,"$1"),e=e.replace(/\..*$/i,"")+"_"},e.initDropZone=function(e,t){var n=r(document,e);n.addEventListener("dragenter",function(e){return n.classList.add("psdtool-drop-active"),e.preventDefault(),e.stopPropagation(),!1},!1),n.addEventListener("dragover",function(e){return n.classList.add("psdtool-drop-active"),e.preventDefault(),e.stopPropagation(),!1},!1),n.addEventListener("dragleave",function(e){return n.classList.remove("psdtool-drop-active"),e.preventDefault(),e.stopPropagation(),!1},!1),n.addEventListener("drop",function(e){return n.classList.remove("psdtool-drop-active"),e.dataTransfer.files.length>0&&t(e.dataTransfer.files),e.preventDefault(),e.stopPropagation(),!1},!1);var i=n.querySelector("input[type=file]");if(i instanceof HTMLInputElement){var a=i;i.addEventListener("change",function(e){a.files&&a.files.length&&t(a.files),a.value=""},!1)}},e.canvasToBlob=function(e){return new Promise(function(t,n){if(HTMLCanvasElement.prototype.toBlob)return void e.toBlob(function(e){if(e)return void t(e);n("could not get Blob")});for(var r=atob(e.toDataURL().split(",")[1]),i=new Uint8Array(r.length),a=0,o=r.length;a<o;++a)i[a]=r.charCodeAt(a);t(new Blob([i],{type:"image/png"}))})},e.normalizeNumber=function(e){return e.replace(/[\uff10-\uff19]/g,function(e){return(e[0].charCodeAt(0)-65296).toString()})},e.loadAsBlobCrossDomain=function(t,n){return new Promise(function(r,i){if("https:"===location.protocol&&"http:"===n.substring(0,5))return i(new Error("cannot access to the insecure content from HTTPS."));var a,o=document.createElement("iframe"),s=setTimeout(function(){return a&&(a.onmessage=void 0),document.body.removeChild(o),i(new Error("something went wrong"))},2e4);o.setAttribute("sandbox","allow-scripts allow-same-origin"),o.onload=function(l){var c=new MessageChannel;a=c.port1,a.onmessage=function(a){if(s&&(clearTimeout(s),s=0),a.data&&a.data.type)switch(a.data.type){case"complete":return document.body.removeChild(o),a.data.data?(t(1),void r({buffer:a.data.data,name:a.data.name?a.data.name:e.extractFilePrefixFromUrl(n)})):void i(new Error("something went wrong"));case"error":return document.body.removeChild(o),void i(new Error(a.data.message?a.data.message:"could not receive data"));case"progress":return void("loaded"in a.data&&"total"in a.data&&t(a.data.loaded/a.data.total))}},o.contentWindow.postMessage(location.protocol,n.replace(/^([^:]+:\/\/[^\/]+).*$/,"$1"),[c.port2])},o.src=n,o.style.display="none",document.body.appendChild(o)})},e.loadAsBlobFromString=function(t,n){return"xd:"===n.substring(0,3)?this.loadAsBlobCrossDomain(t,n.substring(3)):new Promise(function(r,i){var a=new XMLHttpRequest;a.open("GET",n),a.responseType="blob",a.onload=function(o){if(t(1),200===a.status)return void r({buffer:a.response,name:e.extractFilePrefixFromUrl(n)});i(new Error(a.status+" "+a.statusText))},a.onerror=function(e){console.error(e),i(new Error("could not receive data"))},a.onprogress=function(e){return t(e.loaded/e.total)},a.send(null)})},e.loadAsBlob=function(e,t){return t instanceof File?new Promise(function(e){e({buffer:t,name:t.name.replace(/\..*$/i,"")+"_"})}):this.loadAsBlobFromString(e,t)},e}();t.Main=d,function(){var e=Mousetrap.prototype.stopCallback;Mousetrap.prototype.stopCallback=function(t,n,r){return!(!this.paused&&(n.classList.contains("psdtool-layer-visible")||n.classList.contains("psdtool-faview-select")))&&e.call(this,t,n,r)},Mousetrap.init()}();var p=new d;document.addEventListener("DOMContentLoaded",function(e){return p.init()},!1)},function(e,t,n){(function(t,r){/*!
 * @overview es6-promise - a tiny implementation of Promises/A+.
 * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
 * @license   Licensed under MIT license
 *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
 * @version   4.1.1
 */
!function(t,n){e.exports=n()}(0,function(){"use strict";function e(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}function i(e){return"function"==typeof e}function a(e){W=e}function o(e){V=e}function s(){return void 0!==Z?function(){Z(c)}:l()}function l(){var e=setTimeout;return function(){return e(c,1)}}function c(){for(var e=0;e<q;e+=2){(0,Q[e])(Q[e+1]),Q[e]=void 0,Q[e+1]=void 0}q=0}function u(e,t){var n=arguments,r=this,i=new this.constructor(f);void 0===i[ee]&&j(i);var a=r._state;return a?function(){var e=n[a-1];V(function(){return M(a,i,e,r._result)})}():A(r,i,e,t),i}function h(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var n=new t(f);return b(n,e),n}function f(){}function d(){return new TypeError("You cannot resolve a promise with itself")}function p(){return new TypeError("A promises callback cannot return that same promise.")}function v(e){try{return e.then}catch(e){return ie.error=e,ie}}function g(e,t,n,r){try{e.call(t,n,r)}catch(e){return e}}function m(e,t,n){V(function(e){var r=!1,i=g(n,t,function(n){r||(r=!0,t!==n?b(e,n):k(e,n))},function(t){r||(r=!0,S(e,t))},"Settle: "+(e._label||" unknown promise"));!r&&i&&(r=!0,S(e,i))},e)}function w(e,t){t._state===ne?k(e,t._result):t._state===re?S(e,t._result):A(t,void 0,function(t){return b(e,t)},function(t){return S(e,t)})}function y(e,t,n){t.constructor===e.constructor&&n===u&&t.constructor.resolve===h?w(e,t):n===ie?(S(e,ie.error),ie.error=null):void 0===n?k(e,t):i(n)?m(e,t,n):k(e,t)}function b(t,n){t===n?S(t,d()):e(n)?y(t,n,v(n)):k(t,n)}function x(e){e._onerror&&e._onerror(e._result),E(e)}function k(e,t){e._state===te&&(e._result=t,e._state=ne,0!==e._subscribers.length&&V(E,e))}function S(e,t){e._state===te&&(e._state=re,e._result=t,V(x,e))}function A(e,t,n,r){var i=e._subscribers,a=i.length;e._onerror=null,i[a]=t,i[a+ne]=n,i[a+re]=r,0===a&&e._state&&V(E,e)}function E(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var r=void 0,i=void 0,a=e._result,o=0;o<t.length;o+=3)r=t[o],i=t[o+n],r?M(n,r,i,a):i(a);e._subscribers.length=0}}function _(){this.error=null}function L(e,t){try{return e(t)}catch(e){return ae.error=e,ae}}function M(e,t,n,r){var a=i(n),o=void 0,s=void 0,l=void 0,c=void 0;if(a){if(o=L(n,r),o===ae?(c=!0,s=o.error,o.error=null):l=!0,t===o)return void S(t,p())}else o=r,l=!0;t._state!==te||(a&&l?b(t,o):c?S(t,s):e===ne?k(t,o):e===re&&S(t,o))}function C(e,t){try{t(function(t){b(e,t)},function(t){S(e,t)})}catch(t){S(e,t)}}function U(){return oe++}function j(e){e[ee]=oe++,e._state=void 0,e._result=void 0,e._subscribers=[]}function z(e,t){this._instanceConstructor=e,this.promise=new e(f),this.promise[ee]||j(this.promise),H(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?k(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&k(this.promise,this._result))):S(this.promise,T())}function T(){return new Error("Array Methods must be provided an Array")}function R(e){return new z(this,e).promise}function D(e){var t=this;return new t(H(e)?function(n,r){for(var i=e.length,a=0;a<i;a++)t.resolve(e[a]).then(n,r)}:function(e,t){return t(new TypeError("You must pass an array to race."))})}function F(e){var t=this,n=new t(f);return S(n,e),n}function P(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function I(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function B(e){this[ee]=U(),this._result=this._state=void 0,this._subscribers=[],f!==e&&("function"!=typeof e&&P(),this instanceof B?C(this,e):I())}function N(){var e=void 0;if(void 0!==r)e=r;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=B}var O=void 0;O=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var H=O,q=0,Z=void 0,W=void 0,V=function(e,t){Q[q]=e,Q[q+1]=t,2===(q+=2)&&(W?W(c):$())},X="undefined"!=typeof window?window:void 0,G=X||{},Y=G.MutationObserver||G.WebKitMutationObserver,K="undefined"==typeof self&&void 0!==t&&"[object process]"==={}.toString.call(t),J="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Q=new Array(1e3),$=void 0;$=K?function(){return function(){return t.nextTick(c)}}():Y?function(){var e=0,t=new Y(c),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}():J?function(){var e=new MessageChannel;return e.port1.onmessage=c,function(){return e.port2.postMessage(0)}}():void 0===X?function(){try{var e=n(8);return Z=e.runOnLoop||e.runOnContext,s()}catch(e){return l()}}():l();var ee=Math.random().toString(36).substring(16),te=void 0,ne=1,re=2,ie=new _,ae=new _,oe=0;return z.prototype._enumerate=function(e){for(var t=0;this._state===te&&t<e.length;t++)this._eachEntry(e[t],t)},z.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===h){var i=v(e);if(i===u&&e._state!==te)this._settledAt(e._state,t,e._result);else if("function"!=typeof i)this._remaining--,this._result[t]=e;else if(n===B){var a=new n(f);y(a,e,i),this._willSettleAt(a,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(r(e),t)},z.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===te&&(this._remaining--,e===re?S(r,n):this._result[t]=n),0===this._remaining&&k(r,this._result)},z.prototype._willSettleAt=function(e,t){var n=this;A(e,void 0,function(e){return n._settledAt(ne,t,e)},function(e){return n._settledAt(re,t,e)})},B.all=R,B.race=D,B.resolve=h,B.reject=F,B._setScheduler=a,B._setAsap=o,B._asap=V,B.prototype={constructor:B,then:u,catch:function(e){return this.then(null,e)}},B.polyfill=N,B.Promise=B,B})}).call(t,n(6),n(7))},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function i(e){if(u===setTimeout)return setTimeout(e,0);if((u===n||!u)&&setTimeout)return u=setTimeout,setTimeout(e,0);try{return u(e,0)}catch(t){try{return u.call(null,e,0)}catch(t){return u.call(this,e,0)}}}function a(e){if(h===clearTimeout)return clearTimeout(e);if((h===r||!h)&&clearTimeout)return h=clearTimeout,clearTimeout(e);try{return h(e)}catch(t){try{return h.call(null,e)}catch(t){return h.call(this,e)}}}function o(){v&&d&&(v=!1,d.length?p=d.concat(p):g=-1,p.length&&s())}function s(){if(!v){var e=i(o);v=!0;for(var t=p.length;t;){for(d=p,p=[];++g<t;)d&&d[g].run();g=-1,t=p.length}d=null,v=!1,a(e)}}function l(e,t){this.fun=e,this.array=t}function c(){}var u,h,f=e.exports={};!function(){try{u="function"==typeof setTimeout?setTimeout:n}catch(e){u=n}try{h="function"==typeof clearTimeout?clearTimeout:r}catch(e){h=r}}();var d,p=[],v=!1,g=-1;f.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];p.push(new l(e,t)),1!==p.length||v||i(s)},l.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=c,f.addListener=c,f.once=c,f.off=c,f.removeListener=c,f.removeAllListeners=c,f.emit=c,f.prependListener=c,f.prependOnceListener=c,f.listeners=function(e){return[]},f.binding=function(e){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(e){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(10),i=n(11);!function(e){e[e.NoFlip=0]="NoFlip",e[e.FlipX=1]="FlipX",e[e.FlipY=2]="FlipY",e[e.FlipXY=3]="FlipXY"}(t.FlipType||(t.FlipType={}));var a=function(){function e(e){var t=this;if(this.buffer=document.createElement("canvas"),this._visible=!1,this.getVisibleState=function(){return t._visible},this.state="",this.nextState="",this.children=[],this.clipping=!1,this.clip=[],this.x=0,this.y=0,this.width=0,this.height=0,this.maskX=0,this.maskY=0,this.maskWidth=0,this.maskHeight=0,this.maskDefaultColor=0,this.parent=this,!e)return void(this.id=-1);this.id=e.SeqID;var n=e.Width,r=e.Height;n*r>0&&(this.buffer=document.createElement("canvas"),this.buffer.width=n,this.buffer.height=r),this.image=e.Canvas,this.x=e.X,this.y=e.Y,this.width=n,this.height=r,this.mask=e.Mask,this.maskX=e.MaskX,this.maskY=e.MaskY,this.maskWidth=e.MaskWidth,this.maskHeight=e.MaskHeight,this.maskDefaultColor=e.MaskDefaultColor,this.clipping=e.Clipping,this.blendMode=e.BlendMode,this.opacity=e.Opacity,this._visible=e.Visible,this.blendClippedElements=e.BlendClippedElements}return Object.defineProperty(e.prototype,"visible",{get:function(){return this.getVisibleState()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stateHash",{get:function(){return e.calcHash(this.state).toString(16)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nextStateHash",{get:function(){return e.calcHash(this.nextState).toString(16)},enumerable:!0,configurable:!0}),e.calcHash=function(e){if(0===e.length)return 0;for(var t,n=0,r=0;r<e.length;++r)t=e.charCodeAt(r),n=(n<<5)-n+t,n|=0;return n},e}();t.Node=a;var o=function(){function e(e){this.psd=e,this.canvas=document.createElement("canvas"),this.root=new a(void 0),this.nodes={},this.buildTree(this.root,e),this.root.buffer=document.createElement("canvas"),this.root.buffer.width=e.Width,this.root.buffer.height=e.Height,this.registerClippingGroup(this.root)}return e.applyMaskToPassThroughLayer=function(t,n,r,i,a,o,s,l,c,u,h,f){if(o<0&&(u-=o,i-=o,l-=o,o=0),i<0&&(u-=i,o-=i,l-=i,i=0),s<0&&(h-=s,a-=s,c-=s,s=0),a<0&&(h-=a,s-=a,c-=a,a=0),u=Math.min(u,n.canvas.width-i,t.canvas.width-o),h=Math.min(h,n.canvas.height-a,t.canvas.height-s),!(u<=0||h<=0)){var d=t.getImageData(o,s,u,h),p=d.data,v=n.getImageData(i,a,u,h).data,g=t.canvas.ownerDocument.createElement("canvas");g.width=u,g.height=h;var m=g.getContext("2d");if(!(m instanceof CanvasRenderingContext2D))throw new Error("cannot get canvas context");m.fillRect(0,0,u,h),f?e.draw(m,r.canvas,l,c,1,"destination-out"):e.draw(m,r.canvas,l,c,1,"destination-in");for(var w,y,b=m.getImageData(0,0,u,h).data,x=0,k=u*h<<2;x<k;x+=4)w=b[x+3],y=255-w,p[x+0]=(p[x+0]*w*32897>>23)+(v[x+0]*y*32897>>23),p[x+1]=(p[x+1]*w*32897>>23)+(v[x+1]*y*32897>>23),p[x+2]=(p[x+2]*w*32897>>23)+(v[x+2]*y*32897>>23),p[x+3]=(p[x+3]*w*32897>>23)+(v[x+3]*y*32897>>23);t.putImageData(d,o,s)}},e.draw=function(e,t,n,i,a,o){switch(o){case"clear":case"copy":case"destination":case"source-over":case"destination-over":case"source-in":case"destination-in":case"source-out":case"destination-out":case"source-atop":case"destination-atop":case"xor":return e.globalAlpha=a,e.globalCompositeOperation=o,void e.drawImage(t,n,i)}var s=t.getContext("2d");if(!s)throw new Error("cannot get CanvasRenderingContext2D");r.blend(e,s,0,0,n,i,t.width,t.height,a,o)},e.clear=function(e){e.globalAlpha=1,e.globalCompositeOperation="source-over",e.clearRect(0,0,e.canvas.width,e.canvas.height)},Object.defineProperty(e.prototype,"Width",{get:function(){return this.psd.Width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Height",{get:function(){return this.psd.Height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CanvasWidth",{get:function(){return this.psd.CanvasWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CanvasHeight",{get:function(){return this.psd.CanvasHeight},enumerable:!0,configurable:!0}),e.prototype.buildTree=function(e,t){for(var n,r=0,i=t.Children;r<i.length;r++){var o=i[r];n=new a(o),n.parent=e,this.buildTree(n,o),e.children.push(n),this.nodes[n.id]=n}},e.prototype.registerClippingGroup=function(e){for(var t=[],n=void 0,r=e.children.length-1;r>=0;--r)if(n=e.children[r],this.registerClippingGroup(n),n.clipping)t.unshift(n);else{if(t.length){for(var i=0,a=t;i<a.length;i++){var o=a[i];o.clippedBy=n}n.clippingBuffer=document.createElement("canvas"),n.clippingBuffer.width=n.width,n.clippingBuffer.height=n.height,Array.prototype.push.apply(n.clip,t)}t=[]}},e.prototype.render=function(t,n,r,i){var a=this,o=Date.now();this.root.nextState="";for(var s=0,l=this.root.children;s<l.length;s++){var c=l[s];c.clipping&&"pass-through"!==c.blendMode||this.calculateNextState(c,c.opacity/255,c.blendMode)&&(this.root.nextState+=c.nextStateHash+"+")}var u=this.root.buffer;if(this.root.state!==this.root.nextState){var h=u.getContext("2d");if(!h)throw new Error("cannot get CanvasRenderingContext2D");e.clear(h);for(var f=0,d=this.root.children;f<d.length;f++){var c=d[f];this.drawLayer(h,c,-this.psd.X,-this.psd.Y,c.opacity/255,c.blendMode)}this.root.state=this.root.nextState}console.log("rendering: "+(Date.now()-o)),o=Date.now(),this.downScale(u,t,function(s,l){console.log("scaling: "+(Date.now()-o)+"(phase:"+s+")");var c=n?a.psd.Width:a.psd.CanvasWidth,u=n?a.psd.Height:a.psd.CanvasHeight,h=a.canvas;h.width=0|c*t,h.height=0|u*t;var f=h.getContext("2d");if(!f)throw new Error("cannot get CanvasRenderingContext2D");switch(e.clear(f),f.save(),r){case 1:f.translate(h.width,0),f.scale(-1,1);break;case 2:f.translate(0,h.height),f.scale(1,-1);break;case 3:f.translate(h.width,h.height),f.scale(-1,-1)}f.drawImage(l,n?0:0|a.psd.X*t,n?0:0|a.psd.Y*t),f.restore(),i(s,h)})},e.prototype.downScale=function(e,t,n){if(1===t)return void n(1,e);var r=new i.DownScaler(e,t);n(0,r.fast()),setTimeout(function(){return r.beautifulWorker(function(e){return n(1,e)})},0)},e.prototype.calculateNextState=function(e,t,n){if(!e.visible||0===t||e.clipping||!e.children.length&&!e.image)return!1;if(e.nextState="",e.children.length){"pass-through"===n&&(e.nextState+=e.parent.nextStateHash+"+");for(var r=0;r<e.children.length;++r){var i=e.children[r];this.calculateNextState(e.children[r],i.opacity/255,i.blendMode)&&(e.nextState+=e.children[r].nextStateHash+"+")}}else e.image&&(e.nextState=e.id.toString());if(e.mask&&(e.nextState+="|lm"),!e.clip.length||"pass-through"===n)return!0;if(e.nextState+="|cm"+(e.blendClippedElements?"1":"0")+":",e.blendClippedElements){for(var r=0,a=void 0;r<e.clip.length;++r)a=e.clip[r],a.clipping=!1,this.calculateNextState(e.clip[r],a.opacity/255,a.blendMode)&&(e.nextState+=e.clip[r].nextStateHash+"+"),a.clipping=!0;return!0}e.nextState+=Date.now()+"_"+Math.random()+":";for(var o=0,s=e.clip;o<s.length;o++){var a=s[o];a.clipping=!1,this.calculateNextState(a,1,"source-over")&&(e.nextState+=a.nextStateHash+"+"),a.clipping=!0}return!0},e.prototype.drawLayer=function(t,n,r,i,a,o){if(!n.visible||0===a||n.clipping||!n.children.length&&!n.image)return!1;var s=n.buffer;if(n.state===n.nextState)return"pass-through"===o?(t.clearRect(r+n.x,i+n.y,n.width,n.height),e.draw(t,s,r+n.x,i+n.y,1,"source-over")):e.draw(t,s,r+n.x,i+n.y,a,o),!0;var l=s.getContext("2d");if(!l)throw new Error("cannot get CanvasRenderingContext2D for BackBuffer");if(e.clear(l),n.children.length)if("pass-through"===o){e.draw(l,t.canvas,-r-n.x,-i-n.y,1,"source-over");for(var c=0,u=n.children;c<u.length;c++){var h=u[c];this.drawLayer(l,h,-n.x,-n.y,h.opacity*a/255,h.blendMode)}}else for(var f=0,d=n.children;f<d.length;f++){var h=d[f];this.drawLayer(l,h,-n.x,-n.y,h.opacity/255,h.blendMode)}else n.image&&e.draw(l,n.image.canvas,0,0,1,"source-over");if(n.mask&&("pass-through"===o?e.applyMaskToPassThroughLayer(l,t,n.mask,r+n.x,i+n.y,0,0,n.maskX-n.x,n.maskY-n.y,n.width,n.height,255===n.maskDefaultColor):e.draw(l,n.mask.canvas,n.maskX-n.x,n.maskY-n.y,1,n.maskDefaultColor?"destination-out":"destination-in")),!n.clip.length)return"pass-through"===o?(t.clearRect(r+n.x,i+n.y,n.width,n.height),e.draw(t,s,r+n.x,i+n.y,1,"source-over")):e.draw(t,s,r+n.x,i+n.y,a,o),n.state=n.nextState,!0;var p=n.clippingBuffer;if(!p)throw new Error("clippingBuffer not found");var v=p.getContext("2d");if(!v)throw new Error("cannot get CanvasRenderingContext2D for ClipBackBuffer");if(n.blendClippedElements){e.draw(v,s,0,0,1,"copy-opaque");for(var g=0,m=n.clip;g<m.length;g++){var h=m[g];h.clipping=!1,this.drawLayer(v,h,-n.x,-n.y,h.opacity/255,h.blendMode),h.clipping=!0}return e.draw(v,s,0,0,1,"copy-alpha"),n.clippingBuffer=s,n.buffer=p,"pass-through"===o?(t.clearRect(r+n.x,i+n.y,n.width,n.height),e.draw(t,s,r+n.x,i+n.y,1,"source-over")):e.draw(t,p,r+n.x,i+n.y,a,o),n.state=n.nextState,!0}e.draw(t,s,r+n.x,i+n.y,a,o),e.clear(v);for(var w=0,y=n.clip;w<y.length;w++){var h=y[w];h.clipping=!1,this.drawLayer(v,h,-n.x,-n.y,1,"source-over")?(h.clipping=!0,e.draw(v,s,0,0,1,"destination-in"),e.draw(t,p,r+n.x,i+n.y,h.opacity/255,h.blendMode),e.clear(v)):h.clipping=!0}return n.state=n.nextState,!0},e}();t.Renderer=o},function(e,t,n){"use strict";function r(e,t,n){return 77*e+151*t+28*n>>8}function i(e,t,n,i){return i-=r(e,t,n),a(e+i,t+i,n+i)}function a(e,t,n){var i=r(e,t,n),a=Math.min(e,t,n),o=Math.max(e,t,n);return a<0&&(e=i+(e-i)*i/(i-a),t=i+(t-i)*i/(i-a),n=i+(n-i)*i/(i-a)),o>255&&(e=i+(e-i)*(255-i)/(o-i),t=i+(t-i)*(255-i)/(o-i),n=i+(n-i)*(255-i)/(o-i)),e<<16|t<<8|n}function o(e,t,n){return Math.max(e,t,n)-Math.min(e,t,n)}function s(e,t,n,r){return e<=t?t<=n?l(e,t,n,r):e<=n?16711680&(r=l(e,n,t,r))|(255&r)<<8|(65280&r)>>8:(65535&(r=l(n,e,t,r)))<<8|(16711680&r)>>16:e<=n?(65280&(r=l(t,e,n,r)))<<8|(16711680&r)>>8|255&r:t<=n?(255&(r=l(t,n,e,r)))<<16|(16776960&r)>>8:(255&(r=l(n,t,e,r)))<<16|65280&r|(16711680&r)>>16}function l(e,t,n,r){return n>e?(t-e)*r/(n-e)<<8|r:0}function c(e,t,n,r,i){for(var a=0,o=n*r<<2;a<o;a+=4)e[a+3]=t[a+3]*i}function u(e,t,n,r,i){for(var a=255*i,o=0,s=n*r<<2;o<s;o+=4)e[o+0]=t[o+0],e[o+1]=t[o+1],e[o+2]=t[o+2],e[o+3]=a}function h(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=a,m=o,w=s,e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function f(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=a<c?a:c,m=o<u?o:u,w=s<h?s:h,e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function d(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=a*c*32897>>23,m=o*u*32897>>23,w=s*h*32897>>23,e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function p(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=255===c?255:0===a?0:255-Math.min(255,(255-c)/a*255),m=255===u?255:0===o?0:255-Math.min(255,(255-u)/o*255),w=255===h?255:0===s?0:255-Math.min(255,(255-h)/s*255),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function v(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=Math.max(0,c+a-255),m=Math.max(0,u+o-255),w=Math.max(0,h+s-255),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function g(e,t,n,i,a){for(var o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x,k=0,S=n*i<<2;k<S;k+=4)o=t[k],s=t[k+1],l=t[k+2],c=t[k+3],u=e[k],h=e[k+1],f=e[k+2],d=e[k+3],x=0|c*a*32897,p=x*d>>23,v=x*(255-d)>>23,g=(8388735-x)*d>>23,b=p+v+g,e[k+3]=b,b&&(r(o,s,l)<r(u,h,f)?(m=o,w=s,y=l):(m=u,w=h,y=f),e[k]=(m*p+o*v+u*g)/b,e[k+1]=(w*p+s*v+h*g)/b,e[k+2]=(y*p+l*v+f*g)/b)}function m(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=a>c?a:c,m=o>u?o:u,w=s>h?s:h,e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function w(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=a+c-(a*c*32897>>23),m=o+u-(o*u*32897>>23),w=s+h-(s*h*32897>>23),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function y(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=0===c?0:255===a?255:Math.min(255,255*c/(255-a)),m=0===u?0:255===o?255:Math.min(255,255*u/(255-o)),w=0===h?0:255===s?255:Math.min(255,255*h/(255-s)),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function b(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=a+c,m=o+u,w=s+h,e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function x(e,t,n,i,a){for(var o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x,k=0,S=n*i<<2;k<S;k+=4)o=t[k],s=t[k+1],l=t[k+2],c=t[k+3],u=e[k],h=e[k+1],f=e[k+2],d=e[k+3],x=0|c*a*32897,p=x*d>>23,v=x*(255-d)>>23,g=(8388735-x)*d>>23,b=p+v+g,e[k+3]=b,b&&(r(o,s,l)>r(u,h,f)?(m=o,w=s,y=l):(m=u,w=h,y=f),e[k]=(m*p+o*v+u*g)/b,e[k+1]=(w*p+s*v+h*g)/b,e[k+2]=(y*p+l*v+f*g)/b)}function k(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=c<128?a*c*32897>>22:255-((255-(c-128<<1))*(255-a)*32897>>23),m=u<128?o*u*32897>>22:255-((255-(u-128<<1))*(255-o)*32897>>23),w=h<128?s*h*32897>>22:255-((255-(h-128<<1))*(255-s)*32897>>23),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function S(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(a<128?g=c-(((255-(a<<1))*c*32897>>23)*(255-c)*32897>>23):(b=c<64?((32897*((c<<4)-3060)>>23)*c+1020)*c*32897>>23:255*Math.sqrt(c/255),g=c+(((a<<1)-255)*(b-c)*32897>>23)),o<128?m=u-(((255-(o<<1))*u*32897>>23)*(255-u)*32897>>23):(b=u<64?((32897*((u<<4)-3060)>>23)*u+1020)*u*32897>>23:255*Math.sqrt(u/255),m=u+(((o<<1)-255)*(b-u)*32897>>23)),s<128?w=h-(((255-(s<<1))*h*32897>>23)*(255-h)*32897>>23):(b=h<64?((32897*((h<<4)-3060)>>23)*h+1020)*h*32897>>23:255*Math.sqrt(h/255),w=h+(((s<<1)-255)*(b-h)*32897>>23)),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function A(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(a<128?g=c*a*32897>>22:(b=(a<<1)-255,g=c+b-(c*b*32897>>23)),o<128?m=u*o*32897>>22:(b=(o<<1)-255,m=u+b-(u*b*32897>>23)),s<128?w=h*s*32897>>22:(b=(s<<1)-255,w=h+b-(h*b*32897>>23)),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function E(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(a<128?(b=a<<1,g=0===a?b:Math.max(0,255-255*(255-c)/b)):(b=1+(a-128<<1),g=255===b?b:Math.min(255,255*c/(255-b))),o<128?(b=o<<1,m=0===o?b:Math.max(0,255-255*(255-u)/b)):(b=1+(o-128<<1),m=255===b?b:Math.min(255,255*u/(255-b))),s<128?(b=s<<1,w=0===s?b:Math.max(0,255-255*(255-h)/b)):(b=1+(s-128<<1),w=255===b?b:Math.min(255,255*h/(255-b))),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function _(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=a<128?c+(a<<1)-255:c+(a-128<<1),m=o<128?u+(o<<1)-255:u+(o-128<<1),w=s<128?h+(s<<1)-255:h+(s-128<<1),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function L(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(a<128?(b=a<<1,g=b<c?b:c):(b=a-128<<1,g=b>c?b:c),o<128?(b=o<<1,m=b<u?b:u):(b=o-128<<1,m=b>u?b:u),s<128?(b=s<<1,w=b<h?b:h):(b=s-128<<1,w=b>h?b:h),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function M(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(a<128?(b=a<<1,0!==a&&(b=Math.max(0,255-255*(255-c)/b))):0===c?b=0:255!==(b=1+(a-128<<1))&&(b=Math.min(255,255*c/(255-b))),g=b<128?0:255,o<128?(b=o<<1,0!==o&&(b=Math.max(0,255-255*(255-u)/b))):0===u?b=0:255!==(b=1+(o-128<<1))&&(b=Math.min(255,255*u/(255-b))),m=b<128?0:255,s<128?(b=s<<1,0!==s&&(b=Math.max(0,255-255*(255-h)/b))):0===h?b=0:255!==(b=1+(s-128<<1))&&(b=Math.min(255,255*h/(255-b))),w=b<128?0:255,e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function C(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(b=c-a,g=b<0?-b:b,b=u-o,m=b<0?-b:b,b=h-s,w=b<0?-b:b,e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function U(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=c+a-(c*a*32897>>22),m=u+o-(u*o*32897>>22),w=h+s-(h*s*32897>>22),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function j(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=Math.max(0,c-a),m=Math.max(0,u-o),w=Math.max(0,h-s),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function z(e,t,n,r,i){for(var a,o,s,l,c,u,h,f,d,p,v,g,m,w,y,b,x=0,k=n*r<<2;x<k;x+=4)a=t[x],o=t[x+1],s=t[x+2],l=t[x+3],c=e[x],u=e[x+1],h=e[x+2],f=e[x+3],b=0|l*i*32897,d=b*f>>23,p=b*(255-f)>>23,v=(8388735-b)*f>>23,y=d+p+v,e[x+3]=y,y&&(g=0===c?0:0===a?255:Math.min(255,c/a*255),m=0===u?0:0===o?255:Math.min(255,u/o*255),w=0===h?0:0===s?255:Math.min(255,h/s*255),e[x]=(g*d+a*p+c*v)/y,e[x+1]=(m*d+o*p+u*v)/y,e[x+2]=(w*d+s*p+h*v)/y)}function T(e,t,n,a,l){for(var c,u,h,f,d,p,v,g,m,w,y,b,x,k,S,A,E=0,_=n*a<<2;E<_;E+=4)c=t[E],u=t[E+1],h=t[E+2],f=t[E+3],d=e[E],p=e[E+1],v=e[E+2],g=e[E+3],A=0|f*l*32897,m=A*g>>23,w=A*(255-g)>>23,y=(8388735-A)*g>>23,S=m+w+y,e[E+3]=S,S&&(A=s(c,u,h,o(d,p,v)),b=(16711680&A)>>16,x=(65280&A)>>8,k=255&A,A=i(b,x,k,r(d,p,v)),b=(16711680&A)>>16,x=(65280&A)>>8,k=255&A,e[E]=(b*m+c*w+d*y)/S,e[E+1]=(x*m+u*w+p*y)/S,e[E+2]=(k*m+h*w+v*y)/S)}function R(e,t,n,a,l){for(var c,u,h,f,d,p,v,g,m,w,y,b,x,k,S,A,E=0,_=n*a<<2;E<_;E+=4)c=t[E],u=t[E+1],h=t[E+2],f=t[E+3],d=e[E],p=e[E+1],v=e[E+2],g=e[E+3],A=0|f*l*32897,m=A*g>>23,w=A*(255-g)>>23,y=(8388735-A)*g>>23,S=m+w+y,e[E+3]=S,S&&(A=s(d,p,v,o(c,u,h)),b=(16711680&A)>>16,x=(65280&A)>>8,k=255&A,A=i(b,x,k,r(d,p,v)),b=(16711680&A)>>16,x=(65280&A)>>8,k=255&A,e[E]=(b*m+c*w+d*y)/S,e[E+1]=(x*m+u*w+p*y)/S,e[E+2]=(k*m+h*w+v*y)/S)}function D(e,t,n,a,o){for(var s,l,c,u,h,f,d,p,v,g,m,w,y,b,x,k,S=0,A=n*a<<2;S<A;S+=4)s=t[S],l=t[S+1],c=t[S+2],u=t[S+3],h=e[S],f=e[S+1],d=e[S+2],p=e[S+3],k=0|u*o*32897,v=k*p>>23,g=k*(255-p)>>23,m=(8388735-k)*p>>23,x=v+g+m,e[S+3]=x,x&&(k=i(s,l,c,r(h,f,d)),w=(16711680&k)>>16,y=(65280&k)>>8,b=255&k,e[S]=(w*v+s*g+h*m)/x,e[S+1]=(y*v+l*g+f*m)/x,e[S+2]=(b*v+c*g+d*m)/x)}function F(e,t,n,a,o){for(var s,l,c,u,h,f,d,p,v,g,m,w,y,b,x,k,S=0,A=n*a<<2;S<A;S+=4)s=t[S],l=t[S+1],c=t[S+2],u=t[S+3],h=e[S],f=e[S+1],d=e[S+2],p=e[S+3],k=0|u*o*32897,v=k*p>>23,g=k*(255-p)>>23,m=(8388735-k)*p>>23,x=v+g+m,e[S+3]=x,x&&(k=i(h,f,d,r(s,l,c)),w=(16711680&k)>>16,y=(65280&k)>>8,b=255&k,e[S]=(w*v+s*g+h*m)/x,e[S+1]=(y*v+l*g+f*m)/x,e[S+2]=(b*v+c*g+d*m)/x)}function P(e,t,n,r,i,a,o,s,l,c){if("normal"===c&&(c="source-over"),c in B)return e.save(),e.globalAlpha=l,e.globalCompositeOperation=c,e.drawImage(t.canvas,n,r,o,s,i,a,o,s),void e.restore();if(i<0&&(o-=i,n-=i,i=0),n<0&&(o-=n,i-=n,n=0),a<0&&(s-=a,r-=a,a=0),r<0&&(s-=r,a-=r,r=0),o=Math.min(o,t.canvas.width-n,e.canvas.width-i),s=Math.min(s,t.canvas.height-r,e.canvas.height-a),!(o<=0||s<=0||0===l)){var u=e.getImageData(i,a,o,s),h=u.data,f=t.getImageData(n,r,o,s).data;if(!(c in I))throw new Error("unimplemeneted blend mode: "+c);I[c](h,f,o,s,l),e.putImageData(u,i,a)}}Object.defineProperty(t,"__esModule",{value:!0});var I={"copy-alpha":c,"copy-opaque":u,"source-over":h,darken:f,multiply:d,"color-burn":p,"linear-burn":v,"darker-color":g,lighten:m,screen:w,"color-dodge":y,"linear-dodge":b,"lighter-color":x,overlay:k,"soft-light":S,"hard-light":A,"vivid-light":E,"linear-light":_,"pin-light":L,"hard-mix":M,difference:C,exclusion:U,subtract:j,divide:z,hue:T,saturation:R,color:D,luminosity:F},B=function(){var e={},t=document.createElement("canvas"),n=t.getContext("2d");if(!n)throw new Error("cannot get CanvasRenderingContext2D");for(var r=0,i=Object.keys(I);r<i.length;r++){var a=i[r];n.globalCompositeOperation=a,n.globalCompositeOperation===a&&(e[a]=void 0)}return e}();t.blend=P,function(){return new Promise(function(e){var t=new Image;t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAGUlEQVQI1wXBAQEAAAgCIOz/5TJI20UGhz5D2wX8PWbkFQAAAABJRU5ErkJggg==",t.onload=function(n){var r=document.createElement("canvas");r.width=257,r.height=256;var i=r.getContext("2d");if(!i)throw new Error("cannot get CanvasRenderingContext2D");i.fillStyle="rgb(255, 255, 255)",i.fillRect(0,0,r.width,r.height),i.globalAlpha=.5,i.globalCompositeOperation="color-dodge",i.drawImage(t,0,0);var a=i.getImageData(0,0,1,1);e(a.data[0]<128)}})}().then(function(e){e&&delete B["color-dodge"]})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.src=e,this.scale=t,this.dest=document.createElement("canvas")}return Object.defineProperty(e.prototype,"destWidth",{get:function(){return 0|Math.max(1,this.src.width*this.scale)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"destHeight",{get:function(){return 0|Math.max(1,this.src.height*this.scale)},enumerable:!0,configurable:!0}),e.prototype.fast=function(){this.adjustSize();var e=this.dest.getContext("2d");if(!e)throw new Error("cannot get CanvasRenderingContext2D from dest");return e.drawImage(this.src,0,0,this.src.width,this.src.height,0,0,this.destWidth,this.destHeight),this.dest},e.prototype.adjustSize=function(){var e=this.destWidth;this.dest.width!==e&&(this.dest.width=e);var t=this.destHeight;this.dest.height!==t&&(this.dest.height=t)},e.prototype.beautifulWorker=function(t){var n=this,r=new Worker(e.createWorkerURL());e.activeWorker=r,r.onmessage=function(e){n.adjustSize();var i=n.dest.getContext("2d");if(!i)throw new Error("cannot get CanvasRenderingContext2D from dest");for(var a=i.createImageData(n.destWidth,n.destHeight),o=new Uint8Array(e.data.dest.ab),s=new Uint8Array(a.data.buffer,a.data.byteOffset,a.data.byteLength),l=0,c=s.length;l<c;l+=4)s[l]=o[l],s[l+1]=o[l+1],s[l+2]=o[l+2],s[l+3]=o[l+3];i.putImageData(a,0,0),t(n.dest),r.terminate()};var i=this.src.getContext("2d");if(!i)throw new Error("cannot get CanvasRenderingContext2D from src");var a=i.getImageData(0,0,this.src.width,this.src.height),o=this.dest.getContext("2d");if(!o)throw new Error("cannot get CanvasRenderingContext2D from dest");var s=o.createImageData(this.destWidth,this.destHeight);r.postMessage({src:{ab:a.data.buffer,width:a.width,height:a.height},dest:{ab:s.data.buffer,width:s.width,height:s.height},scale:this.scale},[a.data.buffer,s.data.buffer])},e.createWorkerURL=function(){if(e.workerURL)return e.workerURL;var t="\n'use strict';\n"+n(12)+"\nonmessage = function(e) {\n    var d = e.data;\n    DownScaler.scale({\n        data: new Uint8ClampedArray(d.src.ab),\n        width: d.src.width,\n        height: d.src.height\n    }, {\n        data: new Uint8ClampedArray(d.dest.ab),\n        width: d.dest.width,\n        height: d.dest.height\n    }, 2.2);\n    postMessage({dest: d.dest}, [d.dest.ab]);\n};";return e.workerURL=URL.createObjectURL(new Blob([t],{type:"text/javascript"})),e.workerURL},e.revokeWorkerURL=function(){e.workerURL&&(URL.revokeObjectURL(e.workerURL),e.workerURL="")},e}();t.DownScaler=r},function(e,t){e.exports='!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.DownScaler=e():t.DownScaler=e()}(this,function(){return function(t){function e(a){if(r[a])return r[a].exports;var i=r[a]={i:a,l:!1,exports:{}};return t[a].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var r={};return e.m=t,e.c=r,e.d=function(t,r,a){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:a})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=1)}([function(t,e,r){"use strict";function a(t,e){var r=t>>>16&65535,a=65535&t,i=e>>>16&65535,n=65535&e;return a*n+(r*n+a*i<<16>>>0)|0}function i(t,e){if(0===t)return e;for(;0!==e;)t>e?t-=e:e-=t;return t}function n(t,r){return e.imul(t,r)/i(t,r)}Object.defineProperty(e,"__esModule",{value:!0}),e.imul=Math.imul?Math.imul:a,e.gcd=i,e.lcm=n},function(t,e,r){"use strict";function a(t,e,r){if(t.width<e.width||t.height<e.height)throw new Error("upscale is not supported");if(t.width===e.width&&t.height===e.height)return void u.copy(t,e);var a=new f.Gamma32(r),i=a.apply(t),n={width:e.width,height:e.height,data:new Float32Array(e.data.length)};if(t.height!==e.height)if(t.width!==e.width){var h={width:e.width,height:t.height,data:new Float32Array(o.imul(e.width<<2,t.height))};u.horz(i,h),u.vert(h,n)}else u.vert(i,n);else u.horz(i,n);a.restore(n,e)}function i(t,e,r){if(t.width<e.width||t.height<e.height)throw new Error("upscale is not supported");if(t.width===e.width&&t.height===e.height)return void u.copy(t,e);var a=new f.Gamma16(r),i=a.apply(t),n={width:e.width,height:e.height,data:new Uint16Array(e.data.length)};if(t.height!==e.height)if(t.width!==e.width){var h={width:e.width,height:t.height,data:new Uint16Array(o.imul(e.width<<2,t.height))};u.horz(i,h),u.vert(h,n)}else u.vert(i,n);else u.horz(i,n);a.restore(n,e)}function n(t,e){if(t.width<e.width||t.height<e.height)throw new Error("upscale is not supported");if(t.width===e.width&&t.height===e.height)return void u.copy(t,e);if(t.height!==e.height)if(t.width!==e.width){var r={width:e.width,height:t.height,data:new Uint8ClampedArray(o.imul(e.width<<2,t.height))};u.horz8(t,r),u.vert8(r,e)}else u.vert8(t,e);else u.horz8(t,e)}function h(t,e,r){if(void 0===r)return n(t,e);i(t,e,r)}Object.defineProperty(e,"__esModule",{value:!0});var o=r(0),u=r(2),f=r(3);e.scaleGamma32=a,e.scaleGamma16=i,e.scaleNoGamma=n,e.scale=h},function(t,e,r){"use strict";function a(t,e){for(var r=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength),a=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.byteLength),i=t.data.length,n=0;n<i;++n)a[n]=r[n]}function i(t,e){for(var r=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.length),a=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.length),i=t.width,n=e.width,h=0|u.lcm(i,n),o=h/i|0,f=h/n|0,d=new Int32Array(n+1),l=new Int32Array(n+1),w=0;w<=n;++w)l[w]=u.imul(f,w+1)%o,d[w]=u.imul(f,w)/o|0;for(var s=e.height,c=t.width<<2,m=e.width<<2,v=0;v<s;++v)for(var g=u.imul(v,m),y=u.imul(v,c),p=0,b=0;p<n;++p){var A=d[p],O=d[p+1],U=o-b;b=l[p];var M=0,_=0,j=0,x=0,z=0;0!==U&&(z=u.imul(r[y+3],U),_+=u.imul(r[y+0],z),j+=u.imul(r[y+1],z),x+=u.imul(r[y+2],z),M+=z,y+=4);for(var w=A+1;w<O;++w)z=u.imul(r[y+3],o),_+=u.imul(r[y+0],z),j+=u.imul(r[y+1],z),x+=u.imul(r[y+2],z),M+=z,y+=4;0!==b&&(z=u.imul(r[y+3],b),_+=u.imul(r[y+0],z),j+=u.imul(r[y+1],z),x+=u.imul(r[y+2],z),M+=z),0===M?(a[g+0]=0,a[g+1]=0,a[g+2]=0,a[g+3]=0):(a[g+0]=_/M|0,a[g+1]=j/M|0,a[g+2]=x/M|0,a[g+3]=M/f|0),g+=4}}function n(t,e){for(var r=t.data,a=e.data,i=t.width,n=e.width,h=0|u.lcm(i,n),o=h/i|0,f=h/n|0,d=new Int32Array(n+1),l=new Int32Array(n+1),w=0;w<=n;++w)l[w]=u.imul(f,w+1)%o,d[w]=u.imul(f,w)/o|0;for(var s=e.height,c=t.width<<2,m=e.width<<2,v=0;v<s;++v)for(var g=u.imul(v,m),y=u.imul(v,c),p=0,b=0;p<n;++p){var A=d[p],O=d[p+1],U=o-b;b=l[p];var M=0,_=0,j=0,x=0,z=0;0!==U&&(z=r[y+3]*U,_+=r[y+0]*z,j+=r[y+1]*z,x+=r[y+2]*z,M+=z,y+=4);for(var w=A+1;w<O;++w)z=r[y+3]*o,_+=r[y+0]*z,j+=r[y+1]*z,x+=r[y+2]*z,M+=z,y+=4;0!==b&&(z=r[y+3]*b,_+=r[y+0]*z,j+=r[y+1]*z,x+=r[y+2]*z,M+=z),0===M?(a[g+0]=0,a[g+1]=0,a[g+2]=0,a[g+3]=0):(a[g+0]=_/M,a[g+1]=j/M,a[g+2]=x/M,a[g+3]=M/f),g+=4}}function h(t,e){for(var r=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.length),a=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.length),i=t.height,n=e.height,h=u.lcm(i,n),o=h/i|0,f=h/n|0,d=new Int32Array(n+1),l=new Int32Array(n+1),w=0;w<=n;++w)l[w]=u.imul(f,w+1)%o,d[w]=u.imul(f,w)/o|0;for(var s=t.width<<2,c=e.width<<2,m=0;m<c;m+=4)for(var v=m,g=m,y=0,p=0;y<n;++y){var b=d[y],A=d[y+1],O=o-p;p=l[y];var U=0,M=0,_=0,j=0,x=0;0!==O&&(x=u.imul(r[g+3],O),M+=u.imul(r[g+0],x),_+=u.imul(r[g+1],x),j+=u.imul(r[g+2],x),U+=x,g+=s);for(var w=b+1;w<A;++w)x=u.imul(r[g+3],o),M+=u.imul(r[g+0],x),_+=u.imul(r[g+1],x),j+=u.imul(r[g+2],x),U+=x,g+=s;0!==p&&(x=u.imul(r[g+3],p),M+=u.imul(r[g+0],x),_+=u.imul(r[g+1],x),j+=u.imul(r[g+2],x),U+=x),0===U?(a[v+0]=0,a[v+1]=0,a[v+2]=0,a[v+3]=0):(a[v+0]=M/U|0,a[v+1]=_/U|0,a[v+2]=j/U|0,a[v+3]=U/f|0),v+=c}}function o(t,e){for(var r=t.data,a=e.data,i=t.height,n=e.height,h=u.lcm(i,n),o=h/i|0,f=h/n|0,d=new Int32Array(n+1),l=new Int32Array(n+1),w=0;w<=n;++w)l[w]=u.imul(f,w+1)%o,d[w]=u.imul(f,w)/o|0;for(var s=t.width<<2,c=e.width<<2,m=0;m<c;m+=4)for(var v=m,g=m,y=0,p=0;y<n;++y){var b=d[y],A=d[y+1],O=o-p;p=l[y];var U=0,M=0,_=0,j=0,x=0;0!==O&&(x=r[g+3]*O,M+=r[g+0]*x,_+=r[g+1]*x,j+=r[g+2]*x,U+=x,g+=s);for(var w=b+1;w<A;++w)x=r[g+3]*o,M+=r[g+0]*x,_+=r[g+1]*x,j+=r[g+2]*x,U+=x,g+=s;0!==p&&(x=r[g+3]*p,M+=r[g+0]*x,_+=r[g+1]*x,j+=r[g+2]*x,U+=x),0===U?(a[v+0]=0,a[v+1]=0,a[v+2]=0,a[v+3]=0):(a[v+0]=M/U,a[v+1]=_/U,a[v+2]=j/U,a[v+3]=U/f),v+=c}}Object.defineProperty(e,"__esModule",{value:!0});var u=r(0);e.copy=a,e.horz8=i,e.horz=n,e.vert8=h,e.vert=o},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=r(0),i=function(){function t(t){for(var e=new Uint16Array(256),r=0;r<256;++r)e[r]=65535*Math.pow(r/255,t)|0;this.table=e,t=1/t;for(var a=new Uint8Array(65536),r=0;r<65536;++r)a[r]=255*Math.pow(r/65535,t)|0;this.revTable=a}return t.prototype.apply=function(t){for(var e={width:t.width,height:t.height,data:new Uint16Array(t.data.length)},r=this.table,i=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.length),n=e.data,h=t.data.length,o=0;o<h;o+=4)n[o+0]=r[i[o+0]],n[o+1]=r[i[o+1]],n[o+2]=r[i[o+2]],n[o+3]=a.imul(i[o+3],257);return e},t.prototype.restore=function(t,e){for(var r=this.revTable,a=t.data,i=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.length),n=t.data.length,h=0;h<n;h+=4)i[h+0]=r[a[h+0]],i[h+1]=r[a[h+1]],i[h+2]=r[a[h+2]],i[h+3]=a[h+3]>>8},t}();e.Gamma16=i;var n=function(){function t(t){for(var e=new Float32Array(256),r=0;r<256;++r)e[r]=Math.pow(r/255,t);this.table=e}return t.prototype.reverseLookup=function(t){for(var e,r=this.table,a=0,i=r.length-1;i-a>1;)e=a+i>>1,r[e]<=t?a=e:i=e;return t-r[a]<=r[i]-t?a:i},t.prototype.apply=function(t){for(var e={width:t.width,height:t.height,data:new Float32Array(t.data.length)},r=this.table,a=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.length),i=e.data,n=t.data.length,h=0;h<n;h+=4)i[h+0]=r[a[h+0]],i[h+1]=r[a[h+1]],i[h+2]=r[a[h+2]],i[h+3]=a[h+3]/255;return e},t.prototype.restore=function(t,e){for(var r=t.data,a=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.length),i=t.data.length,n=0;n<i;n+=4)a[n+0]=this.reverseLookup(r[n+0]),a[n+1]=this.reverseLookup(r[n+1]),a[n+2]=this.reverseLookup(r[n+2]),a[n+3]=255*r[n+3]|0},t}();e.Gamma32=n}])});'},function(e,t,n){"use strict";function r(e,t){var n=new FileReader;n.onload=function(e){return t(n.result)},n.readAsArrayBuffer(new Blob([e]))}function i(e){var t=new Uint8Array(e),n="",r=0,i=0,a=0,o=0;for(t.length>=3&&239===t[0]&&187===t[1]&&191===t[2]&&(r=3);r<t.length;)if((i=t[r])<128)n+=String.fromCharCode(i),r++;else if(i>191&&i<224){if(r+1>=t.length)throw"UTF-8 Decode failed. Two byte character was truncated.";a=t[r+1],n+=String.fromCharCode((31&i)<<6|63&a),r+=2}else{if(r+2>=t.length)throw"UTF-8 Decode failed. Multi byte character was truncated.";a=t[r+1],o=t[r+2],n+=String.fromCharCode((15&i)<<12|(63&a)<<6|63&o),r+=3}return n}function a(e){var t=0,n=e.replace(/\r/g,"").split("\n");n.shift();for(var r=0,i=n;r<i.length;r++){var a=i[r];a.length>2&&"//"===a.substring(0,2)&&++t}return t}Object.defineProperty(t,"__esModule",{value:!0});var o=n(0);!function(e){e[e.ShowLayerTree=0]="ShowLayerTree",e[e.ShowFaview=1]="ShowFaview",e[e.ShowFaviewAndReadme=2]="ShowFaviewAndReadme"}(t.FaviewMode||(t.FaviewMode={}));var s=function(){function e(e){this.json_=[{id:"root",text:e,type:"root",state:{opened:!0},children:[]}]}return Object.defineProperty(e.prototype,"json",{get:function(){return this.json_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"root",{get:function(){return this.json_[0]},enumerable:!0,configurable:!0}),e.prototype.add=function(t,n,r){var i,a=this.json_,o=t.split("/");o.unshift(e.encodeName(this.root.text));for(var s=0;s<o.length;++s){var l=e.decodeName(o[s]);for(i=0;i<a.length;++i)if(a[i].text===l){a=a[i].children?a[i].children:a[i].children=[],i=-1;break}i===a.length&&(s===o.length-1?a.push(e.createNode(l,n,r)):(a.push(e.createNode(l,"folder")),a=a[a.length-1].children))}},e.createNode=function(e,t,n){switch(t){case"item":return{text:e,type:t,data:{value:n||""},children:[]};case"folder":return{text:e,type:t,state:{opened:!0},children:[]};case"filter":return{text:e,type:t,data:{value:n||""},state:{opened:!0},children:[]}}throw new Error("unknown node type: "+t)},e.encodeName=function(e){return e.replace(/[\x00-\x1f\x22\x25\x27\x2f\x5c\x7e\x7f]/g,function(e){return"%"+("0"+e[0].charCodeAt(0).toString(16)).slice(-2)})},e.decodeName=function(e){return decodeURIComponent(e)},e}(),l=function(){function e(e,t,n){this.defaultRootName=t,this.psdHash="",this.faviewMode=1,this.uniqueId=Date.now().toString()+Math.random().toString().substring(2),this.changedTimer=0,this.tree=e,this.jq=jQuery(this.tree),this.initTree(n)}return Object.defineProperty(e.prototype,"rootName",{get:function(){var e=this.jst.get_node("root");return e&&e.text?e.text:this.defaultRootName},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"json",{get:function(){return this.jst.get_json()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pfv",{get:function(){var e=this,t=this.json;if(1!==t.length)throw new Error("sorry but favorite tree data is broken");var n=[],r=["[PSDToolFavorites-v1]"],i=function(t){for(var a=0,o=t;a<o.length;a++){var l=o[a];switch(n.push(s.encodeName(l.text)),l.type){case"root":r.push("root-name/"+n[0]),r.push("faview-mode/"+e.faviewMode.toString()),r.push(""),n.pop(),l.children&&l.children.length&&i(l.children),n.push("");break;case"folder":l.children&&l.children.length?i(l.children):(r.push("//"+n.join("/")+"~folder"),r.push(""));break;case"filter":r.push("//"+n.join("/")+"~filter"),l.data&&l.data.value&&r.push(l.data.value),r.push(""),l.children&&l.children.length&&i(l.children);break;case"item":r.push("//"+n.join("/")),l.data&&l.data.value&&r.push(l.data.value),r.push("")}n.pop()}};return i(t),r.join("\n")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renameNodes",{get:function(){var e=[],t=function(e,n){for(var r=0,i=e;r<i.length;r++){var a=i[r];if(!a.id)throw new Error("node does not have id");n.push({id:a.id,text:a.text,originalText:a.text,children:[]}),a.children&&a.children.length&&t(a.children,n[n.length-1].children)}};return t(this.json,e),e},enumerable:!0,configurable:!0}),e.prototype.bulkRename=function(e){var t=this,n=function(e,r){for(var i=0,a=e;i<a.length;i++){var o=a[i];o.originalText!==o.text&&t.jst.rename_node(o.id,r?"_":o.text),n(o.children,r)}};n(e,!0),n(e,!1)},e.prototype.jstCheck=function(e,t,n){switch(e){case"create_node":return"root"!==t.type;case"rename_node":return!0;case"delete_node":return"root"!==t.type;case"move_node":case"copy_node":return"root"!==t.type&&"#"!==n.id&&"item"!==n.type}return!1},e.prototype.clearSelection=function(){0!==this.jst.get_top_selected().length&&(this.jst.deselect_all(),this.onClearSelection&&this.onClearSelection())},e.prototype.get=function(e){return this.jst.get_node(e)},e.prototype.edit=function(e){var t=e;void 0===e&&(t=this.jst.get_top_selected()),this.jst.edit(t)},e.prototype.update=function(e,t){var n;if(e)n=this.jst.get_node(e);else{var r=this.jst.get_top_selected();if(!r.length)return;n=r[0]}t.type&&this.jst.set_type(n,t.type),t.data&&(n.data=t.data)},e.prototype.getFirstFilter=function(e){for(var t=0,n=this.getParents(e,"filter");t<n.length;t++){var r=n[t];if(r.data)return r.data.value}return""},e.prototype.getAncestorFilters=function(e){for(var t=[],n=0,r=this.getParents(e,"filter");n<r.length;n++){var i=r[n];i.data&&t.push(i.data.value)}return t},e.prototype.getParents=function(e,t){for(var n=[],r=this.jst.get_node(e.parent);r;r=this.jst.get_node(r.parent))void 0!==t&&t!==r.type||n.push(r);return n},e.prototype.remove=function(e){var t=e;void 0===e&&(t=this.jst.get_top_selected()),this.clearSelection();try{this.jst.delete_node(t)}catch(e){this.jst.delete_node(this.jst.create_node(null,"dummy","last")),this.jst.deselect_all()}},e.prototype.createItemNode=function(e,t){return void 0!==t&&""!==t||(t="New Item"),{text:t,type:"item",data:{value:e},children:[]}},e.prototype.createFolderNode=function(e){return void 0!==e&&""!==e||(e="New Folder"),{text:e,type:"folder",children:[]}},e.prototype.createFilterNode=function(e,t){return void 0!==t&&""!==t||(t="New Filter"),{text:t,type:"filter",data:{value:e},children:[]}},e.prototype.insertNode=function(e){var t=this.jst.get_top_selected(!0);if(0===t.length)return this.jst.create_node("root",e,"last");var n=t[0];if("item"!==n.type){var r=this.jst.create_node(n,e,"last");return n.state.opened||this.jst.open_node(n,null),r}var i=this.jst.get_node(n.parent),a=i.children.indexOf(n.id);return this.jst.create_node(i,e,-1!==a?a+1:"last")},e.prototype.selectNode=function(e,t){this.clearSelection(),this.jst.select_node(e,!0),t&&this.jst.edit(e)},e.prototype.addItem=function(e,t,n){var r=this.insertNode(this.createItemNode(e,t));return this.selectNode(r,n),r},e.prototype.addFolder=function(e,t){var n=this.insertNode(this.createFolderNode(e));return this.selectNode(n,t),n},e.prototype.addFilter=function(e,t,n){var r=this.insertNode(this.createFilterNode(e,t));return this.selectNode(r,n),r},e.prototype.addFolders=function(e){for(var t=[],n=0,r=e;n<r.length;n++){var i=r[n];t.push(this.insertNode(this.createFolderNode(i)))}this.clearSelection();for(var a=0,o=t;a<o.length;a++){var s=o[a];this.jst.select_node(s,!0)}return t},e.prototype.jstChanged=function(){var e=this;this.changedTimer&&clearTimeout(this.changedTimer),this.changedTimer=setTimeout(function(){e.changedTimer=0,e.onModified&&e.onModified(),e.updateLocalStorage()},32)},e.prototype.jstSelectionChanged=function(){var e=this.jst.get_top_selected(!0);if(0!==e.length){var t=e[0];if("item"!==t.type)return void(this.onClearSelection&&this.onClearSelection());try{this.onSelect&&this.onSelect(t)}catch(e){console.error(e),alert(e)}}},e.prototype.jstCopyNode=function(e,t){var n=this,r=function(e,t){var i=n.suggestUniqueName(e);switch(e.text!==i&&n.jst.rename_node(e,i),e.type){case"item":e.data={value:t.data.value};break;case"folder":for(var a=0;a<e.children.length;++a)r(n.jst.get_node(e.children[a]),n.jst.get_node(t.children[a]));break;case"filter":e.data={value:t.data.value};for(var a=0;a<e.children.length;++a)r(n.jst.get_node(e.children[a]),n.jst.get_node(t.children[a]))}};r(t.node,t.original)},e.prototype.jstMoveNode=function(e,t){var n=this.suggestUniqueName(t.node,t.text);t.text!==n&&this.jst.rename_node(t.node,n)},e.prototype.jstCreateNode=function(e,t){var n=this.suggestUniqueName(t.node);t.node.text!==n&&this.jst.rename_node(t.node,n)},e.prototype.jstRenameNode=function(e,t){var n=this.suggestUniqueName(t.node,t.text);t.text!==n&&this.jst.rename_node(t.node,n)},e.prototype.jstDoubleClick=function(e){var t=this.jst.get_node(e.target);switch(t.type){case"item":case"folder":case"filter":this.onDoubleClick&&this.onDoubleClick(t);break;default:this.jst.toggle_node(t)}},e.prototype.suggestUniqueName=function(e,t){var n=this.jst.get_node(e),r=this.jst.get_node(n.parent),i=new Set,a=r.children;if(a&&a.length)for(var o=0,s=a;o<s.length;o++){var l=s[o],c="string"==typeof l?l:l.id;c!==n.id&&i.add(this.jst.get_text(c))}var u=t||n.text;if(!i.has(u))return u;u+=" ";for(var h=2;i.has(u+h);)++h;return u+h},e.prototype.initTree=function(e,t){var n=this;this.jq.jstree("destroy"),this.jq.jstree({core:{animation:!1,check_callback:this.jstCheck,dblclick_toggle:!1,themes:{dots:!1},data:t||new s(this.defaultRootName).json},types:{root:{icon:!1},item:{icon:"glyphicon glyphicon-picture"},folder:{icon:"glyphicon glyphicon-folder-open"},filter:{icon:"glyphicon glyphicon-filter"}},plugins:["types","dnd","wholerow"]}),this.jst=this.jq.jstree(),this.jq.on("changed.jstree",function(e){return n.jstSelectionChanged()}),this.jq.on(["set_text.jstree","create_node.jstree","rename_node.jstree","delete_node.jstree","move_node.jstree","copy_node.jstree","cut.jstree","paste.jstree"].join(" "),function(e){return n.jstChanged()}),this.jq.on("copy_node.jstree",function(e,t){return n.jstCopyNode(e,t)}),this.jq.on("move_node.jstree",function(e,t){return n.jstMoveNode(e,t)}),this.jq.on("create_node.jstree",function(e,t){return n.jstCreateNode(e,t)}),this.jq.on("rename_node.jstree",function(e,t){return n.jstRenameNode(e,t)}),this.jq.on("dblclick.jstree",function(e){return n.jstDoubleClick(e)}),this.jq.on("ready.jstree",function(t){e&&e()})},e.prototype.updateLocalStorage=function(){var e=this,t=this.pfv;r(t,function(n){for(var r=e.getPFVListFromLocalStorage(),i=!1,s="pfv"+o.crc32(n).toString(16),l=0;l<r.length;++l)r[l].id!==e.uniqueId||r[l].hash!==e.psdHash?r[l].id===s&&r[l].hash===e.psdHash&&r.splice(l,1):(r.splice(l,1),i=!0);if(i||0!==a(t)){for(e.uniqueId=s,r.push({id:e.uniqueId,time:(new Date).getTime(),hash:e.psdHash,data:t});r.length>8;)r.shift();localStorage.psdtool_pfv=JSON.stringify(r)}})},e.prototype.getPFVListFromLocalStorage=function(){return"psdtool_pfv"in localStorage?JSON.parse(localStorage.psdtool_pfv):[]},e.prototype.getPFVFromLocalStorage=function(e){var t=this.getPFVListFromLocalStorage();if(t.length)for(var n=0,r=t;n<r.length;n++){var i=r[n];if(i.hash===e)return i}},e.prototype.loadFromArrayBuffer=function(e){return this.loadFromString(i(e),"pfv"+o.crc32(e).toString(16))},e.prototype.loadFromString=function(e,t){var n=this,i=function(t){var r=n.stringToNodeTree(e);n.initTree(function(){n.uniqueId=t,n.faviewMode=r.faviewMode,n.onLoaded&&n.onLoaded()},r.root)};return void 0!==t?i(t):r(e,function(e){i("pfv"+o.crc32(e).toString(16))}),!0},e.prototype.stringToNodeTree=function(e){var t=e.replace(/\r/g,"").split("\n");if("[PSDToolFavorites-v1]"!==t.shift())throw new Error("given PFV file does not have a valid header");for(var n,r=new s(this.defaultRootName),i={"root-name":this.defaultRootName,"faview-mode":2..toString()},a="",o="",l=[],c=!0,u=0,h=t;u<h.length;u++){var f=h[u];""!==f&&(f.length>2&&"//"===f.substring(0,2)?(c?(r.root.text=i["root-name"],c=!1):r.add(a,o,l.join("\n")),a=f.substring(2),-1!==a.indexOf("~")?(l=a.split("~"),a=l[0],o=l[1]):o="item",l=[]):c?(a=f.substring(0,f.indexOf("/")),(n=s.decodeName(f.substring(a.length+1)))&&(i[a]=n)):l.push(f))}c?r.root.text=i["root-name"]:r.add(a,o,l.join("\n"));var d,p=parseInt(i["faview-mode"],10);switch(p){case 0:case 1:case 2:d=p;break;default:d=2}return{root:r.json,faviewMode:d}},e}();t.Favorite=l,t.countEntries=a;var c=function(){function e(e,t,n,r){this.select=e,this.changed=t,this.caption=n,this.items=r}return Object.defineProperty(e.prototype,"selectedIndex",{get:function(){return this.select.selectedIndex},set:function(e){this.select.selectedIndex=e,this.changed(this.select)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"value",{get:function(){return this.select.value},enumerable:!0,configurable:!0}),e.prototype.valueByIndex=function(e){return this.select.options.item(e).value},e}();t.FaviewSelect=c;var u=function(){function e(e,t,n){var r=this;this.favorite=e,this.rootSel=t,this.root=n,this.closed_=!0,this.treeRoots=[],n.addEventListener("click",function(e){return r.click(e)},!1),n.addEventListener("change",function(e){return r.change(e)},!1),n.addEventListener("input",function(e){return r.input(e)},!1),n.addEventListener("keyup",function(e){return r.keyup(e)},!1),t.addEventListener("change",function(e){return r.change(e)},!1),t.addEventListener("keyup",function(e){return r.keyup(e)},!1)}return Object.defineProperty(e.prototype,"roots",{get:function(){return this.treeRoots.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"selectedRootIndex",{get:function(){return this.rootSel.selectedIndex},set:function(e){this.rootSel.selectedIndex=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"items",{get:function(){for(var e=this,t=[],n=0;n<this.rootSel.length;++n){for(var r=[],i=this.treeRoots[n].getElementsByTagName("select"),a=0;a<i.length;++a){var o=i[a];if(o instanceof HTMLSelectElement){var s=o.getAttribute("data-caption");if(!s)throw new Error("could not get caption");for(var l=[],u=0;u<o.length;++u){var h=o.options.item(u);l.push({name:h.textContent||"",value:h.value})}r.push(new c(o,function(t){return e.changed(t)},s,l))}}var f=this.rootSel.options.item(n);t.push({name:f.textContent||"",value:f.value,selects:r})}return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"closed",{get:function(){return this.closed_},enumerable:!0,configurable:!0}),e.prototype.serialize=function(){for(var e={rootSelectedValue:this.rootSel.value,items:{}},t=0;t<this.treeRoots.length;++t){for(var n={},r=this.treeRoots[t].getElementsByTagName("select"),i=0;i<r.length;++i){var a=r[i].getAttribute("data-id");if(!a)throw new Error("id is not defined");n[a]={value:r[i].value,lastMod:parseInt(r[i].getAttribute("data-lastmod")||"0",10)}}var o=this.rootSel.options[t];o instanceof HTMLOptionElement&&(e.items[o.value]=n)}return e},e.prototype.deserialize=function(e){for(var t=0;t<this.rootSel.length;++t){var n=this.rootSel.options[t];if(n instanceof HTMLOptionElement&&n.value in e.items){for(var r=e.items[n.value],i=this.treeRoots[t].getElementsByTagName("select"),a=0;a<i.length;++a){var o=i[a];if(o instanceof HTMLSelectElement){var s=o.getAttribute("data-id");if(!s)throw new Error("id is not defined");if(s in r)for(var l=0;l<o.length;++l){var c=o.options[l];if(c instanceof HTMLOptionElement&&c.value===r[s].value){if(o.selectedIndex=l,o.setAttribute("data-lastmod",r[s].lastMod.toString()),!o.parentElement)throw new Error("unexpected behavior");var u=o.parentElement.querySelector("input[type=range]");u instanceof HTMLInputElement&&(u.value=l.toString());break}}}}e.rootSelectedValue===n.value&&(this.rootSel.selectedIndex=t)}}},e.prototype.rootChanged=function(){for(var e=0;e<this.treeRoots.length;++e)this.rootSel.selectedIndex===e?this.treeRoots[e].style.display="block":this.treeRoots[e].style.display="none";this.onRootChanged&&this.onRootChanged()},e.prototype.changed=function(e){if(e.setAttribute("data-lastmod",Date.now().toString()),!e.parentElement)throw new Error("unexpected behavior");var t=e.parentElement.querySelector("input[type=range]");t instanceof HTMLInputElement&&(t.value=e.selectedIndex.toString()),this.onChange&&this.onChange(this.favorite.get(e.value))},e.prototype.keyup=function(e){var t=e.target;t instanceof HTMLSelectElement&&(t.blur(),t.focus())},e.prototype.change=function(e){var t=e.target;if(t instanceof HTMLSelectElement){if(t===this.rootSel)return void this.rootChanged();this.changed(t)}else if(t instanceof HTMLInputElement&&"range"===t.type){if(!t.parentElement)throw new Error("unexpected behavior");var n=t.parentElement.querySelector("select");n instanceof HTMLSelectElement&&(n.selectedIndex=parseInt(t.value,10),this.changed(n))}},e.prototype.input=function(e){var t=e.target;if(t instanceof HTMLInputElement&&"range"===t.type){if(!t.parentElement)throw new Error("unexpected behavior");var n=t.parentElement.querySelector("select");n instanceof HTMLSelectElement&&(n.selectedIndex=parseInt(t.value,10),this.changed(n))}},e.prototype.click=function(e){var t=e.target;if(t instanceof HTMLButtonElement){var n=0;if(t.classList.contains("psdtool-faview-prev")?n=-1:t.classList.contains("psdtool-faview-next")&&(n=1),0===n)return;if(!t.parentElement)throw new Error("unexpected behavior");var r=t.parentElement.querySelector("select");r instanceof HTMLSelectElement&&(r.selectedIndex=(r.length+r.selectedIndex+n)%r.length,r.focus(),this.changed(r))}},e.prototype.addNode=function(e,t){if(!e.id)throw new Error("node id is not defined");var n=e.text.replace(/^\*/,""),r=document.createElement("li"),i=document.createElement("span");i.className="glyphicon glyphicon-asterisk",r.appendChild(i),r.appendChild(document.createTextNode(" "+n)),t.appendChild(r);var a=document.createElement("select");a.className="form-control psdtool-faview-select",a.setAttribute("data-id",e.id),a.setAttribute("data-caption",n);var o,s,l=document.createElement("ul"),c=0,u=0;if(e.children&&e.children.length)for(var h=0,f=e.children;h<f.length;h++){var d=f[h];switch("string"==typeof d&&(d=this.favorite.get(d)),d.type){case"item":if(o=document.createElement("option"),o.textContent=d.text,!d.id)throw new Error("node id is not defined");o.value=d.id,1==++c&&(s=d.id),a.appendChild(o);break;case"folder":case"filter":this.addNode(d,l),++u}}if(c>0&&s&&""!==this.favorite.getFirstFilter(this.favorite.get(s))){var p=document.createElement("input");p.type="range",p.max=(c-1).toString(),p.value="0";var v=document.createElement("button");v.className="btn btn-default psdtool-faview-prev",v.innerHTML="&lt;",v.tabIndex=-1;var g=document.createElement("button");g.className="btn btn-default psdtool-faview-next",g.innerHTML="&gt;",g.tabIndex=-1;var m=document.createElement("div");m.className="psdtool-faview-select-container",1===c&&(v.disabled=!0,a.disabled=!0,p.disabled=!0,g.disabled=!0),m.appendChild(v),m.appendChild(a),m.appendChild(p),m.appendChild(g),r.appendChild(m)}u>0&&r.appendChild(l)},e.prototype.addRoot=function(e){for(var t=0,n=e;t<n.length;t++){var r=n[t];if(r.text.length>1&&"*"===r.text.charAt(0)&&r.id){var i=document.createElement("option");i.value=r.id,i.textContent=r.text.substring(1),this.rootSel.appendChild(i);var a=document.createElement("ul");if(r.children)for(var o=0,s=r.children;o<s.length;o++){var l=s[o];if("string"!=typeof l)switch(l.type){case"folder":case"filter":this.addNode(l,a)}}var c=document.createElement("li");c.style.display="none",c.appendChild(a),this.treeRoots.push(c),this.root.appendChild(c);for(var u=c.getElementsByTagName("select"),h=0;h<u.length;++h)u[h].setAttribute("data-lastmod",(u.length-h).toString())}r.children&&this.addRoot(r.children)}},e.prototype.start=function(e){this.treeRoots=[],this.rootSel.innerHTML="",this.root.innerHTML="",this.addRoot(this.favorite.json),void 0!==e&&this.deserialize(e),this.roots>0&&this.rootChanged(),this.closed_=!1},e.prototype.refresh=function(){this.start(this.serialize())},e.prototype.getActive=function(){for(var e=this.treeRoots[this.rootSel.selectedIndex].getElementsByTagName("select"),t=[],n=0;n<e.length;++n)t.push({n:this.favorite.get(e[n].value),lastMod:parseInt(e[n].getAttribute("data-lastmod")||"0",10)});t.sort(function(e,t){return e.lastMod===t.lastMod?0:e.lastMod<t.lastMod?-1:1});for(var r=[],i=0,a=t;i<a.length;i++){var n=a[i];r.push(n.n)}return r},e.prototype.close=function(){this.treeRoots=[],this.rootSel.innerHTML="",this.root.innerHTML="",this.closed_=!0},e}();t.Faview=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.NoFlip=0]="NoFlip",e[e.FlipX=1]="FlipX",e[e.FlipY=2]="FlipY",e[e.FlipXY=3]="FlipXY"}(t.FlipType||(t.FlipType={}));var r=function(){function e(t,n,r,i,a){this.input=t,this.displayName_=n,this.name_=r,this.children=[],this.parent=this,this.internalName_=e.encodeLayerName(this.name,a),i.length?this.fullPath_=i.join("/")+"/"+this.internalName_:this.fullPath_=this.internalName_}return Object.defineProperty(e.prototype,"checked",{get:function(){return this.input.checked},set:function(e){this.input.checked=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"disabled",{get:function(){return this.input.disabled},set:function(e){this.input.disabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"displayName",{get:function(){return this.displayName_.data},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"internalName",{get:function(){return this.internalName_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fullPath",{get:function(){return this.fullPath_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isRoot",{get:function(){return this===this.parent},enumerable:!0,configurable:!0}),e.encodeLayerName=function(e,t){return e.replace(/[\x00-\x1f\x22\x25\x27\x2f\x5c\x7e\x7f]/g,function(e){return"%"+("0"+e[0].charCodeAt(0).toString(16)).slice(-2)})+(0===t?"":"\\"+t.toString())},e}();t.Node=r;var i=function(){function e(e,t,n){var i=this;this.disableExtendedFeature=e,this.treeRoot=t,this.root=new r(document.createElement("input"),document.createTextNode(""),"",[],0),this.nodes={},this.flipX=[],this.flipY=[],this.flipXY=[],this.flip_=0;var a=[],o=function(e,t,n,s){for(var l={},c={},u=0,h=n;u<h.length;u++){var f=h[u];f.Name in c?l[f.SeqID]=++c[f.Name]:l[f.SeqID]=c[f.Name]=0}for(var d=n.length-1;d>=0;--d){var p=i.createElements(n[d],s),v=new r(p.input,p.text,n[d].Name,a,l[n[d].SeqID]);v.parent=t,t.children.push(v),i.nodes[n[d].SeqID]=v;var g=document.createElement("ul");a.push(v.internalName),o(g,v,n[d].Children,n[d].SeqID),a.pop(),v.li=document.createElement("li"),n[d].Folder&&v.li.classList.add("psdtool-folder"),v.li.appendChild(p.div),v.li.appendChild(g),e.appendChild(v.li)}};o(t,this.root,n.Children,-1),this.registerClippingGroup(n.Children),this.disableExtendedFeature||this.registerFlippingGroup(),this.normalize(),this.flip=this.flip}return Object.defineProperty(e.prototype,"text",{get:function(){var e=[],t=[],n=function(r){for(var i=0,a=r.children;i<a.length;i++){var o=a[i];e.push(t.join("")+o.name),t.push("\t"),n(o),t.pop()}};return n(this.root),e.join("\n")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"flip",{get:function(){return this.flip_},set:function(e){switch(this.flip_=e,this.treeRoot.classList.remove("psdtool-flip-x","psdtool-flip-y","psdtool-flip-xy"),e){case 0:this.doFlip(this.flipX,!1),this.doFlip(this.flipY,!1),this.doFlip(this.flipXY,!1);break;case 1:this.doFlip(this.flipY,!1),this.doFlip(this.flipXY,!1),this.doFlip(this.flipX,!0),this.treeRoot.classList.add("psdtool-flip-x");break;case 2:this.doFlip(this.flipXY,!1),this.doFlip(this.flipX,!1),this.doFlip(this.flipY,!0),this.treeRoot.classList.add("psdtool-flip-y");break;case 3:this.doFlip(this.flipX,!1),this.doFlip(this.flipY,!1),this.doFlip(this.flipXY,!0),this.treeRoot.classList.add("psdtool-flip-xy")}},enumerable:!0,configurable:!0}),e.prototype.flipSerialize=function(e){var t=function(e,n){for(var r,i=0,a=e.children;i<a.length;i++){var o=a[i];n.children[o.internalName]=r={checked:o.checked,children:{}},t(o,r)}},n={checked:e.checked,children:{}};return t(e,n),n},e.prototype.flipDeserialize=function(e,t){var n=function(e,t){for(var r,i=0,a=e.children;i<a.length;i++){var o=a[i];o.internalName in t.children&&(r=t.children[o.internalName],o.checked=r.checked,n(o,r))}};n(e,t)},e.prototype.doFlip=function(e,t){for(var n=0,r=e;n<r.length;n++){var i=r[n];if(t&&i.normal.checked){var a=this.flipSerialize(i.normal);this.flipDeserialize(i.flipped,a),i.flipped.checked=!0,i.normal.checked=!1}else if(!t&&i.flipped.checked){var a=this.flipSerialize(i.flipped);this.flipDeserialize(i.normal,a),i.normal.checked=!0,i.flipped.checked=!1}}},e.prototype.createElements=function(e,t){var n=document.createElement("label"),r=document.createElement("input"),i=e.Name;if(!this.disableExtendedFeature&&i.length>1)switch(i.charAt(0)){case"!":r.className="psdtool-layer-visible psdtool-layer-force-visible",r.name="l"+e.SeqID,r.type="checkbox",r.checked=!0,r.disabled=!0,r.style.display="none",i=i.substring(1);break;case"*":r.className="psdtool-layer-visible psdtool-layer-radio",r.name="r_"+t,r.type="radio",r.checked=e.Visible,i=i.substring(1)}if(r.name||(r.className="psdtool-layer-visible",r.name="l"+e.SeqID,r.type="checkbox",r.checked=e.Visible),this.disableExtendedFeature||(i=this.parseToken(i).name),r.setAttribute("data-seq",e.SeqID.toString()),n.appendChild(r),e.Clipping){var a=document.createElement("img");a.className="psdtool-clipped-mark",a.src="img/clipped.svg",a.alt="clipped mark",n.appendChild(a)}if(e.Folder){var o=document.createElement("span");o.className="psdtool-icon glyphicon glyphicon-folder-open",o.setAttribute("aria-hidden","true"),n.appendChild(o)}else{var s=document.createElement("canvas");if(s.className="psdtool-thumbnail",s.width=96,s.height=96,e.Canvas){var l=e.Width,c=e.Height;l>c?(l=s.width,c=s.width/e.Width*c):(c=s.height,l=s.height/e.Height*l);var u=s.getContext("2d");if(!u)throw new Error("cannot get CanvasRenderingContext2D for make thumbnail");u.drawImage(e.Canvas.canvas,(s.width-l)/2,(s.height-c)/2,l,c)}n.appendChild(s)}var h=document.createTextNode(i);n.appendChild(h);var f=document.createElement("div");return f.className="psdtool-layer-name",f.appendChild(n),{text:h,div:f,input:r}},e.prototype.updateClass=function(){function e(t){if(t.checked){if(t.li.classList.remove("psdtool-hidden"),t.clip)for(var n=0;n<t.clip.length;++n)t.clip[n].li.classList.remove("psdtool-hidden-by-clipping")}else if(t.li.classList.add("psdtool-hidden"),t.clip)for(var n=0;n<t.clip.length;++n)t.clip[n].li.classList.add("psdtool-hidden-by-clipping");for(var n=0;n<t.children.length;++n)e(t.children[n])}for(var t=0;t<this.root.children.length;++t)e(this.root.children[t])},e.prototype.registerClippingGroup=function(e){for(var t,n=[],r=e.length-1;r>=0;--r)if(this.registerClippingGroup(e[r].Children),t=this.nodes[e[r].SeqID],e[r].Clipping)n.unshift(t);else{if(n.length){for(var i=0;i<n.length;++i)n[i].clippedBy=t;t.clip=n}n=[]}},e.prototype.parseToken=function(e){for(var t=[],n=e.split(":"),r=n.length-1;r>=0;--r)switch(n[r]){case"flipx":case"flipy":case"flipxy":t.push(n[r]),n.pop();break;default:return{tokens:t,name:n.join(":")}}throw new Error("cannot parse token from name: "+e)},e.prototype.registerFlippingGroup=function(){var e=this,t=function(n){for(var r=0,i=n.children;r<i.length;r++){var a=i[r];t(a);for(var o=e.parseToken(a.name),s=[],l=0,c=o.tokens;l<c.length;l++){switch(c[l]){case"flipx":s.push(1);break;case"flipy":s.push(2);break;case"flipxy":s.push(3)}}if(0!==s.length){for(var u=void 0,h=0,f=n.children;h<f.length;h++){var d=f[h];if(d.name===o.name){u=d;break}}if(u)for(var p=0,v=s;p<v.length;p++){var g=v[p];switch(g){case 1:u.li.classList.add("psdtool-item-flip-x-orig"),a.li.classList.add("psdtool-item-flip-x"),e.flipX.push({normal:u,flipped:a});break;case 2:u.li.classList.add("psdtool-item-flip-y-orig"),a.li.classList.add("psdtool-item-flip-y"),e.flipY.push({normal:u,flipped:a});break;case 3:u.li.classList.add("psdtool-item-flip-xy-orig"),a.li.classList.add("psdtool-item-flip-xy"),e.flipXY.push({normal:u,flipped:a})}}}}};t(this.root)},e.prototype.getAllNode=function(){var e,t=[];for(var n in this.nodes)this.nodes.hasOwnProperty(n)&&(e=this.nodes[n],e.checked&&t.push(e));return t},e.prototype.serialize=function(e){var t=this.getAllNode();if(!t.length)return"";if(e){for(var n=[],r=0,i=t;r<i.length;r++){var a=i[r];n.push("/"+a.fullPath)}return n.join("\n")}var o,s=[],l={};for(o=0;o<t.length;++o)s.push({node:t[o],fullPathSlash:t[o].fullPath+"/",index:o}),l[t[o].fullPath]=!0;s.sort(function(e,t){return e.fullPathSlash>t.fullPathSlash?1:e.fullPathSlash<t.fullPathSlash?-1:0});var c,u;for(o=0;o<s.length;++o){for(u=s[o].node.fullPath.split("/"),c=0;c<u.length;++c)if(!l[u.slice(0,c+1).join("/")]){s.splice(o--,1),c=-1;break}-1!==c&&o>0&&0===s[o].fullPathSlash.indexOf(s[o-1].fullPathSlash)&&s.splice(--o,1)}s.sort(function(e,t){return e.index>t.index?-1:e.index<t.index?1:0}),u=[];for(var h=0,f=s;h<f.length;h++){var d=f[h];u.push(d.node.fullPath)}return u.join("\n")},e.prototype.buildDeserializeTree=function(e){for(var t,n,r,i="/"===e.charAt(0),a={children:{},checked:!0,allLayer:i},o=e.replace(/\r/g,"").split("\n"),s=0,l=o;s<l.length;s++){var c=l[s];for(r=c.split("/"),t=i?1:0,n=a;t<r.length;++t)r[t]in n.children||(n.children[r[t]]={children:{},checked:!i}),n=n.children[r[t]];i&&(n.checked=!0)}return a},e.prototype.apply=function(e,t,n){for(var r={},i=0,a=t.children;i<a.length;i++){var o=a[i];r[o.internalName]=!0;var s=void 0;e&&(s=e.children[o.internalName]),e&&s?(s.checked&&(o.checked=!0),this.apply(s,o,n)):(o.checked=!1,n&&this.apply(null,o,n))}},e.prototype.deserialize=function(e){var t=this.serialize(!0);try{var n=this.buildDeserializeTree(e);n.allLayer&&(this.clear(),this.normalize()),this.apply(n,this.root,n.allLayer),this.flip=this.flip}catch(e){throw this.apply(this.buildDeserializeTree(t),this.root,!0),this.flip=this.flip,e}},e.prototype.buildFilterTree=function(e){for(var t,n,r={children:{}},i=0,a=e.replace(/\r/g,"").split("\n");i<a.length;i++){n=a[i].split("/"),t=r;for(var o=0,s=n;o<s.length;o++){var l=s[o];l in t.children||(t.children[l]={children:{}}),t=t.children[l]}}return r},e.prototype.applyWithFilter=function(e,t,n){for(var r={},i=0,a=n.children;i<a.length;i++){var o=a[i];r[o.internalName]=!0;var s=void 0;if(t&&(s=t.children[o.internalName]),t&&s){var l=void 0;e&&(l=e.children[o.internalName]),e&&l?(l.checked&&(o.checked=!0),this.applyWithFilter(l,s,o)):o.checked=!1}}},e.prototype.deserializePartial=function(e,t,n){var r=this.serialize(!0);try{if(void 0!==e)if(""===e)this.clear();else{var i=this.buildDeserializeTree(e);i.allLayer&&(this.clear(),this.normalize()),this.apply(i,this.root,i.allLayer)}var a=this.buildDeserializeTree(t);if(a.allLayer)throw new Error("cannot use allLayer mode in LayerTree.deserializePartial");this.applyWithFilter(a,this.buildFilterTree(n),this.root),this.flip=this.flip}catch(e){throw this.apply(this.buildDeserializeTree(r),this.root,!0),this.flip=this.flip,e}},e.prototype.clear=function(){for(var e in this.nodes)this.nodes.hasOwnProperty(e)&&(this.nodes[e].checked=!1)},e.prototype.normalize=function(){var e=document.getElementById("layer-tree");if(!e)throw new Error("#layer-tree not found");for(var t=e.querySelectorAll(".psdtool-layer-force-visible"),n=0;n<t.length;++n)t[n].checked=!0;for(var r={},i=e.querySelectorAll(".psdtool-layer-radio"),n=0;n<i.length;++n){var a=i[n];if(!(a instanceof HTMLInputElement))throw new Error("found .psdtool-layer-radio that are not HTMLInputElement");if(!(a.name in r)){r[a.name]=!0;e.querySelectorAll('.psdtool-layer-radio[name="'+a.name+'"]:checked').length||(a.checked=!0)}}},e}();t.LayerTree=i;var a=function(){function e(e,t){var n=this;this.root=new r(document.createElement("input"),document.createTextNode(""),"",[],0),this.nodes={};var i=[],a=function(e,t,o){for(var s={},l={},c=0,u=o;c<u.length;c++){var h=u[c];h.Name in l?s[h.SeqID]=++l[h.Name]:s[h.SeqID]=l[h.Name]=0}for(var f=o.length-1;f>=0;--f){var d=n.createElements(o[f]),p=new r(d.input,d.text,o[f].Name,i,s[o[f].SeqID]);p.parent=t,t.children.push(p),n.nodes[o[f].SeqID]=p,p.li=document.createElement("li");var v=document.createElement("ul");i.push(p.internalName),a(v,p,o[f].Children),i.pop(),p.li.appendChild(d.label),p.li.appendChild(v),e.appendChild(p.li)}};a(e,this.root,t.Children)}return e.prototype.createElements=function(e){var t=document.createElement("input");t.type="checkbox",t.checked=!0,t.setAttribute("data-seq",e.SeqID.toString());var n=document.createTextNode(e.Name),r=document.createElement("label");return r.appendChild(t),r.appendChild(n),{text:n,label:r,input:t}},e.prototype.getAllNode=function(){var e,t=[],n=0;for(var r in this.nodes)this.nodes.hasOwnProperty(r)&&(e=this.nodes[r],e.disabled||(++n,e.checked&&t.push(e)));return t.length===n?[]:t},e.prototype.serialize=function(){var e=this.getAllNode();if(!e.length)return"";var t,n=[],r={};for(t=0;t<e.length;++t)n.push({node:e[t],fullPathSlash:e[t].fullPath+"/",index:t}),r[e[t].fullPath]=!0;n.sort(function(e,t){return e.fullPathSlash>t.fullPathSlash?1:e.fullPathSlash<t.fullPathSlash?-1:0});var i,a;for(t=0;t<n.length;++t){for(a=n[t].node.fullPath.split("/"),i=0;i<a.length;++i)if(!r[a.slice(0,i+1).join("/")]){n.splice(t--,1),i=-1;break}-1!==i&&t>0&&0===n[t].fullPathSlash.indexOf(n[t-1].fullPathSlash)&&n.splice(--t,1)}for(n.sort(function(e,t){return e.index>t.index?-1:e.index<t.index?1:0}),a=[],t=0;t<n.length;++t)a.push(n[t].node.fullPath);return a.join("\n")},e.prototype.buildDeserializeTree=function(e){for(var t,n,r={children:{},checked:!0},i=e.replace(/\r/g,"").split("\n"),a=0,o=i;a<o.length;a++){n=o[a].split("/"),t=r;for(var s=0,l=n;s<l.length;s++){var c=l[s];c in t.children||(t.children[c]={children:{},checked:!0}),t=t.children[c]}}return r},e.prototype.apply=function(e,t,n){for(var r={},i=0,a=t.children;i<a.length;i++){var o=a[i];if(!o.disabled){r[o.internalName]=!0;var s=void 0;e&&(s=e.children[o.internalName]),e&&s?(o.checked=s.checked,this.apply(s,o,n)):(n&&(o.disabled=!0),o.checked=!1,this.apply(null,o,n))}}},e.prototype.deserialize=function(e,t){var n=this.serialize();try{for(var r in this.nodes)this.nodes.hasOwnProperty(r)&&(this.nodes[r].disabled=!1,this.nodes[r].checked=!1);for(var i=t.length-1;i>=0;--i)this.apply(this.buildDeserializeTree(t[i]),this.root,!0);if(""===e)return;this.apply(this.buildDeserializeTree(e),this.root,!1)}catch(e){throw this.apply(this.buildDeserializeTree(n),this.root,!1),e}},e}();t.Filter=a},function(e,t,n){"use strict";function r(e,t,n){for(var r=new Array(e.length),i=0;i<e.length;++i)r[i]='<tile gid="'+e[i].toString()+'"/>';return t+r.join(t+n)+n}function i(e,t,n){for(var r=new Array(e.length-e.length/(t-1)|0),i=0,a=0,o=0;i<e.length;++i,++a,++o)o+1===t&&i+1<e.length?(r[a]=e[i].toString()+n+e[++i].toString(),o=0):r[a]=e[i].toString();return r.join(",")}function a(){return'<!DOCTYPE html>\n<meta charset="utf-8">\n<title>Tiled Viewer</title>\n<style>\nbody{margin:0}\n#ui,#view{float:left}\n#selects{padding:0 0.5em}\n#selects li{padding:0;margin:0 0 1em 0;list-style:none}\n#selects select,input[type=range]{display:block;margin: 2px 0;min-width:192px}\n#view{background-image: url(data:image/gif;base64,R0lGODlhYABgAKEBAMzMzP///////////yH/C05FVFNDQVBFMi4wAwEAAAAh+QQACgD/ACwAAAAAYABgAAAC/oxvoKuIzNyBSyYKbMDZcv15GDiKFHmaELqqkVvBjdxJoV3iqd7yrx8DzoQ1x82YQ+6UPebPGYQOpcVH0rrENrVPbtQ7BVcnV3LWvEV31V922D2+cM7ydH19b+ff+/im3MeC90dHaGc4eCQmqIfYqAjHyOc4CRlII+lnSakJyJkJiilKFEo6SlWKerq4Gtl6aRqrqiHLWut6Czu7a8uL66vbK/w7HEx8bJz8+bqc2wz8XByNPK28ee2JXah9yJ2YDb4dPvctbt49Xo5+rt7+mP7OHr9O714Jfy+fXz9v36n/j98+f6mkeeuHcGDCgASZHVQI0U9Bag8ZLpxoDZ/F+ogYq3ms2BGkQ40hSY4EWBLlSYEbW6Zk+bKhM5EzycFcKRMaTZ0ma6r0eRNoToM9ef40GhTpUIpFiR51mhTq0oxPqcW8iBOrUK1KuUr1yrQq1ahhyY6d+rFpWbQ7v3LM+nZr3K5zxbRdC/Zs3rRi+Zr1y1at3rp4CQ92CRexXMV0Gbt1XBjy4auGad2dnJiyZMB7L3Ou7Dm04M+bRfc1/Rd14NOjVXfW6Bp069msa6emfdv26ty8d/t+rRt4b+G/ZQevrDl55uWLlTdn3th5dOiPpVenHtl6duyYn3tvHLs07uLij5cfbhz9efLau0//fh3+dvnu47+HVgAAIfkEAQoAAgAsAAAAAGAAYAAAAv4MjhfLm9naQ5FNVc3NembAXeC3kZ75hGUlqie7Ri0K0ZSNwa8cS731cwQ7KdxIV0TWlDdmjrfzRYFTYZW4hCa1WenW26V+xWHr2FzGNrlrcJv8RsfVT3cdfpfn6Uf2fjPj1Gc3iFeod8jncqZotJgW6JcYSfg4R2lo+TeEiag5yRl61dko+HnqmGqqKom6+trKWimbSetpWxor46rbOwv761sLPCx8S3xsnBvMXNyc/LzsPA1NLV2Nfa1Nyi3K2D3qDSl+Sb4Zjv7tAa6ePu5eDn/eTv9eH38/b7+Pz6/fD/CfQFDyCOYz6A9hQIUDeUVjl9ChNYgLJWbrxDCjxf1t5jTiotjwY8eNID0i41iQ5EiRKVkeVNnyZEmYL11GtFkRJ4iZOk0q4ylzZdCYP4UWJfrQaFKkE5U2ZXrRaVSoKGsOtXoU6zOfS7U+9ToVbNWbV8lmNdsV7Ve1YdmOzVkW7lm5aemutdsW79udUvdyvRsybuC5g+sWBvw372HFif3SdAuUcOPIhif3pYzYomWqmBk/1tvZcc/Pi0UL3iw2tOrLrDm3Tv0acuyApiWTRi3btW7Yu3Pz/u07OOjZpVf3Hn68OHHccZgrT+48+u3po6ufpn7dum3tlbFvzw7+u/juOmuTD39+fGbu69G3V++ZfXz38+Gbf58+/4ICACH5BAEKAAMALAAAAABgAGAAAAL+TICJxqza2kvRTVDNxXnnc31eF5KTWFajxKlptMIve5oPWru5vNO3DQFShAtii/fTJZFBZZM5dEahRWmVevQ9tVPu1Zu19MRLMK5M3qa76287rJm9z+r42I7G10F3ft6/F2NmRMemxyE4R7hoBQdo+Oh2KBnpmDhpKYdZSHlZyZnZ5zmq+cmIBZp6Otio2rqq+CqLCrtZazrLSpsbu+urG+f62wtMbGzLizysXMx8jLsM3Sz9TCpaav2XHYjdff2t7R0Ozk0OuX0uXj7Ovu6eHoTeqQ7fXv8+b55vv48fyv/Pn7Bp8gLeO9gPocGEDBc6HFiNXkOIzipSs1iQ4sX8jYkm3sr4UeLDkPpGJuMoUiPIkyujtSSYkiRAlTFZ1nR5E2ZJmjtlFnkZsadNoTiJ6pzpUyFPpEOZFnV6VGBSj02lVlU61eRTq1ux8qLaFWxUr2G1jhUbFGparmfNriXbdinbt2gx5qTr1q5RvHLhrtGrFvBcwX4J10W513BexIEZD3ZcGPJhoIr7Tr5bOavlxUAvJ5bMGTPozaQ1m77quTHl0afLlkYd+vPq2aJpm8sM+7Xr1nF58/WNe3du4KyHGxeOvPdx5cl/Lwehm7l0582DT7dO/Xrx6tu121ZdO7xs8eDHm7eHPX337OzVf3/8PnL81PDJ1z9/X20BACH5BAEKAAMALAAAAABgAGAAAAL+jIGJxqza2kvRTVDPzeHi7HEhuJGTWFajmkar20qxdZoP/LG1ftuQTwEuhDlcj/dDBpVDZlG2MyalS2rT+qQdsagodPudhqvjazmr8WrFa3Lb/EZ3ZmlwvGuvs/VuPtwv93KGtzenBkjYZ5i3WCh45wPplPjXqPiISEQZSGdZienJeRi6Wap5OonKpTrIKrmaGgs72ypbS/t6q5vLm2nbS+rqizuse9kJmoy8PKrczMzoHA3tSH38jD2dXb19rf3NDe4dTj5u/mmN3q0uzl7ufi7aLv9ODyxdb/pbfJ9OH6+PWLB9AwXiAyis4C5+DBX2W/cPnsSIFAMudNjw4ET7iw/ncSyGkKDGiglHfsSI0mRJfydVimS5EmJLmC9lxvR4M1/OkAZp9rRZs4nLnziD6jTK8+JQpT6ZAiV6FGrSjlGdFpW6cWdWpFuxkuT6ldbUjE2pjk1ZluxTq1XNdmV7dqnbsHDfzp259q5WunrB4r0apq/Xv23VAhZcl6/hwmjzLo6btvHhx3YpK5bMWK5lwpAdK+w8GTPozJE1i658+rLp1aVbe2b92nVo2LNlk469DbHuzXs5o6Z9uzZu4cSDGx+N/Lft5KqXKx9+3Axz382hT++N3W/2wdsTU//efXdq8NrLczfvPad44NfRr3devXj78/TTu+fNoAAAIfkEAQoAAwAsAAAAAGAAYAAAAv6MA6l5javcgVE+ai/MlNkOcJ2IfaNZSiC5oa16wqmzugt725X80rE/a9QMOV4R2BP+lMHJ0tkkPqVRzZGZhGapW+sOedWGuWOvx/jFlofgtNhNhptDunPbrpaz8/h3P/43h6M3JVhHhxa454d418j3yDioWLgIGHnJAjmJaZjYaenpyEl6WPp5Omq6isqq2gr7KrvpShtrOytZq3vLm5u5C9wr/CuKe+yLTIy7VulcFRr93CUNPd1snU19TaiNve3dDT7+XS5uThmeTn7evo4Oyv3uHq9ezz6ff/+tbJz8vwygv4AEBxqshm8fvVT9EMJjKNDhwmAH5SnUB7GgRPyMFDde/Jixor2QbB52tEgS5cmRKxOmZDlMpMuWJmN6fDnTpkqdMIvdpDmRZ06fO5E0LHq0Z9KhS2sSVRoRaVSoGqVWpSrTadOgT5lO9XoVbFauWzlywan1a9qwa8ea7dr2p9C4Vt2CBPq27N25ZNX2ZfvXLtrAco36zXt4L1zCdQvrHYwYcGTBeBU/rgzZcuLMnDF75ju5MF2sjjd/Xhy6sWrSq8WWlqwZdmfQsSnTno269mvbhmWfvnz7t+ngxHPjBm5cuO/iyJsPT878ufPl0DUcl46d+nTe23d7bz3aNXjGrMuLNx8+Pfnz7Pll5/7+O/r16lPPt9+eawEAIfkEAQoAAwAsAAAAAGAAYAAAAv6MDal5HbvcgUoiCuzDGmfrdRw4SiFJiSkKqS0bwZXM0J9ZOie+8q8fA86ENeJNl2vskD3m7+cMRofTYvWoTE60l2bWuwV3oV9y2DyWltVndpq6hrflb2vcPsfXsXn+3uW2ISaIRhi4dOdnSLeo16iI2AfIGPlnM+lY+YgJybV5CcpzxUkaOmqaWGqkerqKKvlq6TrbWpsa+0l7qwvLK2vbC/y7K5xbrInsmTy4XNh8qFziHM1MPV2Nfa0Nnc29TWntLQ7eTf6dGW4+jl7Oft7ZDv/OSlwfbD98r5/Pb4zvv0/QsXTu1skzSC/gM3UMCzY8+DBhv4UOK0K0KBHgRPyCFztmpOgRF8iPHEnGMzkvDUqEIku2PPkypS+NNEfGZDnTZk6XO2H2lDnQZ1Cg/3QOxXk0IoqkGG8q/Ym0KE+mIaE+pbryqlShW4kqnNo16leuY71uJHvWbC61RsNqLSs2bdyaYOG+lXuXLlq9bOvibWoVMFangt0Wtnv47ODAVRc7NtwYctbEfOe2RRwZ8+TMfzlXznu58+bRhD3v6Ls39GfKqlv7XW36tevUsmvTvo06t2XbukHz3o1ldm/Wv33jBj489nHjyUkzdv5Yc2nokqdbfx6q+fXoordXxw6eO2zq0sN/Fy8cuXrm64kvd38NfXH47ZVrN1++VQEAIfkEAQoAAwAsAAAAAGAAYAAAAv6MD6l5Hbscgkw+CuylGmfrdZjIgaNZSiEKkS0bwYobq6edOiv+8rV+A+YaO2HP+CMGlcNJ01BkHqVJ59RahZ6em6uWG8XOZBXf2FxGntVp6trdFse/3m7W/pZ/0Ht2H/6nR5NHdxdWSIg3pxiIuHjIOPi4JEjWGGkpeQnJSem46YnJp0maaWozeupXmtq6qgrI+uoaC1tJezurW4v7Kcu7mws8LFzsa3vcKxqczLxM3Az9bDwdTb0CFtqZzV237a0d3m0oDj6e+E1+PrkO2v57Xa5uTj9vjy6P/45c3Z+uXw/gPXYBJyn7R3Cgu4ILFcKzBtFfvoQCK1K82NBiRvqMDyXuOzhxo8iOCEfyK0kyZMqPzrAxXPnypEqZLKWhpBkTZM14OyPe1Jmz5UygDnEWJaoR5lGhPSUi5Wg0aVSoT01WVSr16lSrTIPaHNp16demP8NmNUsVLdexMcmCZSuWp1e5cX2+pXsWbl68afX25bsWMNa/dt0anlsYsUdwWhurHRw4cd3Fk8v6jUx5r2TNmQl3xmxZ8FbIpEeb1nq48t3NnkOzBr36c2nHl2c/Pn2btmjdr23Xxv0bVe7hwYnvNt4b+PHizJc7T85btnLoyKVHd239dmrO2LvH9r699ffx4WGX9/08e3Pq69WnB6+403Xy8emr3lcAACH5BAEKAAMALAAAAABgAGAAAAL+jB+gq4jM3IFLGtosBjbhvoGfNkohSYkpCqktG8GVnJmlc9qr/vKxPwPWcLdHcXK8JD07YtP4REaVU2bPeYVmpVtq1/rDhrVjbmSZEwfVQ/La3Ta/5XFv2T7H18F5/j4Nx0EjKETIZhjocueHSNeo98io2AfoOPmHlllVCXkZySk56DkqWlpIemp6iLqqoZr4ahnbORuaetuKC6sry0vra5srvDvcW/x7HEy8bMyM7KzcLP08HU19bZ0Nuq3Z0r3IvflNOY4pfv4Vnl7+yc4KrQ7uXhtPji5/b7+eb77vj/9PH8CBAgv2I3jQYLtN9OYBq5cw4sKAEt9VgzgRYUb4hRaxYeyozWGyjw35baxYkuLJlSBJPhQJ7wPMizM91gxpsuVNlyN3+syZUqNOoC+J9jQaEylNpTaZ4lTZMihHqSiLQqXKEuvQq1aFav3adWrYqke5lvU6NmvarWjPil3102xSuUvpNrX7tO1cvXX53vWb9+1ewX0J/zUcmOxgxYUZH/4D1q3jxGolV158uXHmx5sps0XME/PnyaE1j+5cmvPp1aLiAk7tObJo2aZpq7Ydey1u2Lxdg/ZNGjhq4VF1G7fM+vhs5bWZ33aeG/lu4tOd9rZOHfp1qNmla+++3Lv48OSbjzdf/vl59emjt9/+GvzF6ng/FgAAOw==)}\n</style>\n<div id="ui">\n  <div id="root"></div>\n  <ul id="selects"></ul>\n</div>\n<canvas id="view"></canvas>\n<script>\nvar tileMapLoadedCallbacks = {};\nfunction onTileMapLoaded(name, data) {\n  if (!(name in tileMapLoadedCallbacks)) {\n    return;\n  }\n  tileMapLoadedCallbacks[name](data);\n  delete tileMapLoadedCallbacks[name];\n}\nfunction loadTileMap(url, callback){\n  var m = url.match(/\\..+$/);\n  switch (m && m[0]) {\n  case \'.json\':\n    var xhr = new XMLHttpRequest();\n    xhr.open(\'GET\', url, true);\n    xhr.onload = function(e) {\n      callback(JSON.parse(this.response));\n    };\n    xhr.send();\n    return;\n  case \'.js\':\n    tileMapLoadedCallbacks[url.replace(/\\//g, \'\\\\\').replace(/\\..+$/, \'\')] = callback;\n    var sc = document.createElement(\'script\');\n    sc.src = url;\n    document.body.appendChild(sc);\n    setTimeout(function(){\n      document.body.removeChild(sc);\n    }, 0);\n    return;\n  }\n  throw new Error(\'unsupported filetype: \'+url);\n}\nfunction decodeData(layer){\n  if (!(\'encoding\' in layer)) {\n    return layer.data;\n  }\n  switch (layer.encoding) {\n  case \'base64\':\n    var ab = base64ToArrayBuffer(layer.data);\n    if (\'compression\' in layer) {\n      switch (layer.compression) {\n      case \'zlib\':\n        ab = pako.inflate(ab).buffer;\n        break;\n      default:\n        throw new Error(\'unsupported compression: \'+layer.compression);\n      }\n    }\n    var i32a = new Int32Array(ab), r = new Array(i32a.length);\n    for (var i = 0; i < i32a.length; ++i) {\n      r[i] = i32a[i];\n    }\n    return r;\n  default:\n    throw new Error(\'unsupported encoding: \'+layer.encoding);\n  }\n}\nfunction base64ToArrayBuffer(s){\n  var bin = atob(s), u8a = new Uint8Array(bin.length);\n  for (var i = 0; i < bin.length; ++i) {\n    u8a[i] = bin.charCodeAt(i);\n  }\n  return u8a.buffer;\n}\nvar selectId = 0;\nfunction createSelect(caption, items, onChange){\n  var id = \'sel\' + (++selectId);\n\n  var label = document.createElement(\'label\');\n  label.textContent = caption;\n  label.htmlFor = id;\n\n  var sel = document.createElement(\'select\');\n  sel.id = id;\n  items.map(function(item, index){\n    var opt = document.createElement(\'option\');\n    opt.textContent = item;\n    opt.value = item;\n    sel.appendChild(opt);\n  });\n\n  var slider = document.createElement(\'input\');\n  slider.type = \'range\';\n  slider.max = items.length-1;\n  slider.value = 0;\n\n  sel.addEventListener(\'change\', function(e){\n    slider.value = sel.selectedIndex;\n    onChange(e);\n  }, false);\n  slider.addEventListener(\'input\', function(e){\n    sel.selectedIndex = slider.value;\n    var ev = document.createEvent("HTMLEvents");\n    ev.initEvent("change", false, true);\n    sel.dispatchEvent(ev);\n  }, false);\n\n  var li = document.createElement(\'li\');\n  li.appendChild(label);\n  li.appendChild(sel);\n  li.appendChild(slider);\n  return li;\n}\nfunction updateSelects(faview, rootIndex) {\n  var elem = document.getElementById(\'selects\');\n  elem.innerHTML = \'\';\n  function changed(){\n    updateCanvas(faview, document.getElementById(\'view\'));\n  }\n  var root = faview.roots[rootIndex];\n  root.selects.map(function(sel, i){\n    elem.appendChild(createSelect(root.captions[i], sel, changed));\n  });\n}\nfunction buildName(flatten, namingStyle, ext) {\n  var items = [], sels = document.querySelectorAll(\'select\');\n  for (var i = 0; i < sels.length; ++i){\n    switch (namingStyle) {\n    case \'standard\':\n      items.push(\n        (i ? document.querySelector("label[for=\'"+sels[i].id+"\']").textContent+\'-\' : \'\')+\n        sels[i].options[sels[i].selectedIndex].value\n      );\n      break;\n    case \'compact\':\n      items.push(sels[i].options[sels[i].selectedIndex].value);\n      break;\n    case \'index\':\n      items.push(sels[i].selectedIndex);\n      break;\n    }\n  }\n  return items.join(flatten ? \'_\' : \'/\') + \'.\' + ext;\n}\nfunction renderCanvas(tiled, canvas, images, layer){\n  var tsx = tiled.tilesets, tw = tiled.tilewidth, th = tiled.tileheight;\n  canvas.width = tiled.properties.originalwidth;\n  canvas.height = tiled.properties.originalheight;\n  var ctx = canvas.getContext(\'2d\');\n  var dx = 0, dy = 0, data = decodeData(layer);\n  for (var i = 0; i < data.length; ++i) {\n    var d = data[i]-1, img = 0;\n    while(d >= tsx[img].tilecount) {\n      d -= tsx[img++].tilecount;\n    }\n    var sx = d % tsx[img].columns, sy = (d - sx) / tsx[img].columns;\n    ctx.drawImage(images[img], sx * tw, sy * th, tw, th, dx * tw, dy * th, tw, th);\n    if (++dx == layer.width) {\n      dx = 0;\n      ++dy;\n    }\n  }\n}\nfunction updateCanvas(faview, canvas){\n  var path = buildName(faview.flatten, faview.namingStyle, faview.format);\n  loadTileMap(path, function(tiled){\n    var images, loading = 0;\n    function loaded(){\n      if (--loading) return;\n      tiled.layers.map(function(layer){\n        renderCanvas(tiled, canvas, images, layer);\n      });\n    }\n    images = tiled.tilesets.map(function(tsx){\n      ++loading;\n      var img = new Image();\n      img.src = path.replace(/[^\\/]+$/, \'\') + tsx.image.replace(/\\\\/g, \'/\');\n      img.onload = loaded;\n      return img;\n    });\n  });\n}\nfunction onFaviewLoaded(faview){\n  var sel = document.createElement(\'select\');\n  faview.roots.map(function(root){\n    var opt = document.createElement(\'option\');\n    opt.textContent = root.name;\n    opt.value = root.name;\n    sel.appendChild(opt);\n  });\n  sel.addEventListener(\'change\', function(e){\n    updateSelects(faview, e.currentTarget.selectedIndex);\n  }, false);\n  if (faview.roots.length <= 1) {\n    sel.style.display = \'none\';\n  }\n  document.getElementById(\'root\').appendChild(sel);\n  updateSelects(faview, 0);\n  updateCanvas(faview, document.getElementById(\'view\'));\n}\n<\/script>\n<script>\n/* pako 1.0.3 nodeca/pako */\n!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.pako=e()}}(function(){return function e(t,i,n){function a(o,s){if(!i[o]){if(!t[o]){var f="function"==typeof require&&require;if(!s&&f)return f(o,!0);if(r)return r(o,!0);var l=new Error("Cannot find module \'"+o+"\'");throw l.code="MODULE_NOT_FOUND",l}var d=i[o]={exports:{}};t[o][0].call(d.exports,function(e){var i=t[o][1][e];return a(i?i:e)},d,d.exports,e,t,i,n)}return i[o].exports}for(var r="function"==typeof require&&require,o=0;o<n.length;o++)a(n[o]);return a}({1:[function(e,t,i){"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;i.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var n in i)i.hasOwnProperty(n)&&(e[n]=i[n])}}return e},i.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var a={arraySet:function(e,t,i,n,a){if(t.subarray&&e.subarray)return void e.set(t.subarray(i,i+n),a);for(var r=0;r<n;r++)e[a+r]=t[i+r]},flattenChunks:function(e){var t,i,n,a,r,o;for(n=0,t=0,i=e.length;t<i;t++)n+=e[t].length;for(o=new Uint8Array(n),a=0,t=0,i=e.length;t<i;t++)r=e[t],o.set(r,a),a+=r.length;return o}},r={arraySet:function(e,t,i,n,a){for(var r=0;r<n;r++)e[a+r]=t[i+r]},flattenChunks:function(e){return[].concat.apply([],e)}};i.setTyped=function(e){e?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,a)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,r))},i.setTyped(n)},{}],2:[function(e,t,i){"use strict";function n(e,t){if(t<65537&&(e.subarray&&o||!e.subarray&&r))return String.fromCharCode.apply(null,a.shrinkBuf(e,t));for(var i="",n=0;n<t;n++)i+=String.fromCharCode(e[n]);return i}var a=e("./common"),r=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch(e){r=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){o=!1}for(var s=new a.Buf8(256),f=0;f<256;f++)s[f]=f>=252?6:f>=248?5:f>=240?4:f>=224?3:f>=192?2:1;s[254]=s[254]=1,i.string2buf=function(e){var t,i,n,r,o,s=e.length,f=0;for(r=0;r<s;r++)i=e.charCodeAt(r),55296===(64512&i)&&r+1<s&&(n=e.charCodeAt(r+1),56320===(64512&n)&&(i=65536+(i-55296<<10)+(n-56320),r++)),f+=i<128?1:i<2048?2:i<65536?3:4;for(t=new a.Buf8(f),o=0,r=0;o<f;r++)i=e.charCodeAt(r),55296===(64512&i)&&r+1<s&&(n=e.charCodeAt(r+1),56320===(64512&n)&&(i=65536+(i-55296<<10)+(n-56320),r++)),i<128?t[o++]=i:i<2048?(t[o++]=192|i>>>6,t[o++]=128|63&i):i<65536?(t[o++]=224|i>>>12,t[o++]=128|i>>>6&63,t[o++]=128|63&i):(t[o++]=240|i>>>18,t[o++]=128|i>>>12&63,t[o++]=128|i>>>6&63,t[o++]=128|63&i);return t},i.buf2binstring=function(e){return n(e,e.length)},i.binstring2buf=function(e){for(var t=new a.Buf8(e.length),i=0,n=t.length;i<n;i++)t[i]=e.charCodeAt(i);return t},i.buf2string=function(e,t){var i,a,r,o,f=t||e.length,l=new Array(2*f);for(a=0,i=0;i<f;)if(r=e[i++],r<128)l[a++]=r;else if(o=s[r],o>4)l[a++]=65533,i+=o-1;else{for(r&=2===o?31:3===o?15:7;o>1&&i<f;)r=r<<6|63&e[i++],o--;o>1?l[a++]=65533:r<65536?l[a++]=r:(r-=65536,l[a++]=55296|r>>10&1023,l[a++]=56320|1023&r)}return n(l,a)},i.utf8border=function(e,t){var i;for(t=t||e.length,t>e.length&&(t=e.length),i=t-1;i>=0&&128===(192&e[i]);)i--;return i<0?t:0===i?t:i+s[e[i]]>t?i:t}},{"./common":1}],3:[function(e,t,i){"use strict";function n(e,t,i,n){for(var a=65535&e|0,r=e>>>16&65535|0,o=0;0!==i;){o=i>2e3?2e3:i,i-=o;do a=a+t[n++]|0,r=r+a|0;while(--o);a%=65521,r%=65521}return a|r<<16|0}t.exports=n},{}],4:[function(e,t,i){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],5:[function(e,t,i){"use strict";function n(){for(var e,t=[],i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}function a(e,t,i,n){var a=r,o=n+i;e^=-1;for(var s=n;s<o;s++)e=e>>>8^a[255&(e^t[s])];return e^-1}var r=n();t.exports=a},{}],6:[function(e,t,i){"use strict";function n(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}t.exports=n},{}],7:[function(e,t,i){"use strict";var n=30,a=12;t.exports=function(e,t){var i,r,o,s,f,l,d,u,c,h,b,w,m,k,_,g,v,p,x,y,S,E,B,Z,A;i=e.state,r=e.next_in,Z=e.input,o=r+(e.avail_in-5),s=e.next_out,A=e.output,f=s-(t-e.avail_out),l=s+(e.avail_out-257),d=i.dmax,u=i.wsize,c=i.whave,h=i.wnext,b=i.window,w=i.hold,m=i.bits,k=i.lencode,_=i.distcode,g=(1<<i.lenbits)-1,v=(1<<i.distbits)-1;e:do{m<15&&(w+=Z[r++]<<m,m+=8,w+=Z[r++]<<m,m+=8),p=k[w&g];t:for(;;){if(x=p>>>24,w>>>=x,m-=x,x=p>>>16&255,0===x)A[s++]=65535&p;else{if(!(16&x)){if(0===(64&x)){p=k[(65535&p)+(w&(1<<x)-1)];continue t}if(32&x){i.mode=a;break e}e.msg="invalid literal/length code",i.mode=n;break e}y=65535&p,x&=15,x&&(m<x&&(w+=Z[r++]<<m,m+=8),y+=w&(1<<x)-1,w>>>=x,m-=x),m<15&&(w+=Z[r++]<<m,m+=8,w+=Z[r++]<<m,m+=8),p=_[w&v];i:for(;;){if(x=p>>>24,w>>>=x,m-=x,x=p>>>16&255,!(16&x)){if(0===(64&x)){p=_[(65535&p)+(w&(1<<x)-1)];continue i}e.msg="invalid distance code",i.mode=n;break e}if(S=65535&p,x&=15,m<x&&(w+=Z[r++]<<m,m+=8,m<x&&(w+=Z[r++]<<m,m+=8)),S+=w&(1<<x)-1,S>d){e.msg="invalid distance too far back",i.mode=n;break e}if(w>>>=x,m-=x,x=s-f,S>x){if(x=S-x,x>c&&i.sane){e.msg="invalid distance too far back",i.mode=n;break e}if(E=0,B=b,0===h){if(E+=u-x,x<y){y-=x;do A[s++]=b[E++];while(--x);E=s-S,B=A}}else if(h<x){if(E+=u+h-x,x-=h,x<y){y-=x;do A[s++]=b[E++];while(--x);if(E=0,h<y){x=h,y-=x;do A[s++]=b[E++];while(--x);E=s-S,B=A}}}else if(E+=h-x,x<y){y-=x;do A[s++]=b[E++];while(--x);E=s-S,B=A}for(;y>2;)A[s++]=B[E++],A[s++]=B[E++],A[s++]=B[E++],y-=3;y&&(A[s++]=B[E++],y>1&&(A[s++]=B[E++]))}else{E=s-S;do A[s++]=A[E++],A[s++]=A[E++],A[s++]=A[E++],y-=3;while(y>2);y&&(A[s++]=A[E++],y>1&&(A[s++]=A[E++]))}break}}break}}while(r<o&&s<l);y=m>>3,r-=y,m-=y<<3,w&=(1<<m)-1,e.next_in=r,e.next_out=s,e.avail_in=r<o?5+(o-r):5-(r-o),e.avail_out=s<l?257+(l-s):257-(s-l),i.hold=w,i.bits=m}},{}],8:[function(e,t,i){"use strict";function n(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function a(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new _.Buf16(320),this.work=new _.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function r(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=D,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new _.Buf32(we),t.distcode=t.distdyn=new _.Buf32(me),t.sane=1,t.back=-1,z):C}function o(e){var t;return e&&e.state?(t=e.state,t.wsize=0,t.whave=0,t.wnext=0,r(e)):C}function s(e,t){var i,n;return e&&e.state?(n=e.state,t<0?(i=0,t=-t):(i=(t>>4)+1,t<48&&(t&=15)),t&&(t<8||t>15)?C:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=i,n.wbits=t,o(e))):C}function f(e,t){var i,n;return e?(n=new a,e.state=n,n.window=null,i=s(e,t),i!==z&&(e.state=null),i):C}function l(e){return f(e,_e)}function d(e){if(ge){var t;for(m=new _.Buf32(512),k=new _.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(x(S,e.lens,0,288,m,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;x(E,e.lens,0,32,k,0,e.work,{bits:5}),ge=!1}e.lencode=m,e.lenbits=9,e.distcode=k,e.distbits=5}function u(e,t,i,n){var a,r=e.state;return null===r.window&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new _.Buf8(r.wsize)),n>=r.wsize?(_.arraySet(r.window,t,i-r.wsize,r.wsize,0),r.wnext=0,r.whave=r.wsize):(a=r.wsize-r.wnext,a>n&&(a=n),_.arraySet(r.window,t,i-n,a,r.wnext),n-=a,n?(_.arraySet(r.window,t,i-n,n,0),r.wnext=n,r.whave=r.wsize):(r.wnext+=a,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=a))),0}function c(e,t){var i,a,r,o,s,f,l,c,h,b,w,m,k,we,me,ke,_e,ge,ve,pe,xe,ye,Se,Ee,Be=0,Ze=new _.Buf8(4),Ae=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return C;i=e.state,i.mode===X&&(i.mode=W),s=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,a=e.input,f=e.avail_in,c=i.hold,h=i.bits,b=f,w=l,ye=z;e:for(;;)switch(i.mode){case D:if(0===i.wrap){i.mode=W;break}for(;h<16;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if(2&i.wrap&&35615===c){i.check=0,Ze[0]=255&c,Ze[1]=c>>>8&255,i.check=v(i.check,Ze,2,0),c=0,h=0,i.mode=F;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&c)<<8)+(c>>8))%31){e.msg="incorrect header check",i.mode=ce;break}if((15&c)!==U){e.msg="unknown compression method",i.mode=ce;break}if(c>>>=4,h-=4,xe=(15&c)+8,0===i.wbits)i.wbits=xe;else if(xe>i.wbits){e.msg="invalid window size",i.mode=ce;break}i.dmax=1<<xe,e.adler=i.check=1,i.mode=512&c?q:X,c=0,h=0;break;case F:for(;h<16;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if(i.flags=c,(255&i.flags)!==U){e.msg="unknown compression method",i.mode=ce;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=ce;break}i.head&&(i.head.text=c>>8&1),512&i.flags&&(Ze[0]=255&c,Ze[1]=c>>>8&255,i.check=v(i.check,Ze,2,0)),c=0,h=0,i.mode=L;case L:for(;h<32;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}i.head&&(i.head.time=c),512&i.flags&&(Ze[0]=255&c,Ze[1]=c>>>8&255,Ze[2]=c>>>16&255,Ze[3]=c>>>24&255,i.check=v(i.check,Ze,4,0)),c=0,h=0,i.mode=H;case H:for(;h<16;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}i.head&&(i.head.xflags=255&c,i.head.os=c>>8),512&i.flags&&(Ze[0]=255&c,Ze[1]=c>>>8&255,i.check=v(i.check,Ze,2,0)),c=0,h=0,i.mode=M;case M:if(1024&i.flags){for(;h<16;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}i.length=c,i.head&&(i.head.extra_len=c),512&i.flags&&(Ze[0]=255&c,Ze[1]=c>>>8&255,i.check=v(i.check,Ze,2,0)),c=0,h=0}else i.head&&(i.head.extra=null);i.mode=j;case j:if(1024&i.flags&&(m=i.length,m>f&&(m=f),m&&(i.head&&(xe=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),_.arraySet(i.head.extra,a,o,m,xe)),512&i.flags&&(i.check=v(i.check,a,m,o)),f-=m,o+=m,i.length-=m),i.length))break e;i.length=0,i.mode=K;case K:if(2048&i.flags){if(0===f)break e;m=0;do xe=a[o+m++],i.head&&xe&&i.length<65536&&(i.head.name+=String.fromCharCode(xe));while(xe&&m<f);if(512&i.flags&&(i.check=v(i.check,a,m,o)),f-=m,o+=m,xe)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=P;case P:if(4096&i.flags){if(0===f)break e;m=0;do xe=a[o+m++],i.head&&xe&&i.length<65536&&(i.head.comment+=String.fromCharCode(xe));while(xe&&m<f);if(512&i.flags&&(i.check=v(i.check,a,m,o)),f-=m,o+=m,xe)break e}else i.head&&(i.head.comment=null);i.mode=Y;case Y:if(512&i.flags){for(;h<16;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if(c!==(65535&i.check)){e.msg="header crc mismatch",i.mode=ce;break}c=0,h=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=X;break;case q:for(;h<32;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}e.adler=i.check=n(c),c=0,h=0,i.mode=G;case G:if(0===i.havedict)return e.next_out=s,e.avail_out=l,e.next_in=o,e.avail_in=f,i.hold=c,i.bits=h,N;e.adler=i.check=1,i.mode=X;case X:if(t===Z||t===A)break e;case W:if(i.last){c>>>=7&h,h-=7&h,i.mode=le;break}for(;h<3;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}switch(i.last=1&c,c>>>=1,h-=1,3&c){case 0:i.mode=J;break;case 1:if(d(i),i.mode=ie,t===A){c>>>=2,h-=2;break e}break;case 2:i.mode=$;break;case 3:e.msg="invalid block type",i.mode=ce}c>>>=2,h-=2;break;case J:for(c>>>=7&h,h-=7&h;h<32;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if((65535&c)!==(c>>>16^65535)){e.msg="invalid stored block lengths",i.mode=ce;break}if(i.length=65535&c,c=0,h=0,i.mode=Q,t===A)break e;case Q:i.mode=V;case V:if(m=i.length){if(m>f&&(m=f),m>l&&(m=l),0===m)break e;_.arraySet(r,a,o,m,s),f-=m,o+=m,l-=m,s+=m,i.length-=m;break}i.mode=X;break;case $:for(;h<14;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if(i.nlen=(31&c)+257,c>>>=5,h-=5,i.ndist=(31&c)+1,c>>>=5,h-=5,i.ncode=(15&c)+4,c>>>=4,h-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=ce;break}i.have=0,i.mode=ee;case ee:for(;i.have<i.ncode;){for(;h<3;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}i.lens[Ae[i.have++]]=7&c,c>>>=3,h-=3}for(;i.have<19;)i.lens[Ae[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,Se={bits:i.lenbits},ye=x(y,i.lens,0,19,i.lencode,0,i.work,Se),i.lenbits=Se.bits,ye){e.msg="invalid code lengths set",i.mode=ce;break}i.have=0,i.mode=te;case te:for(;i.have<i.nlen+i.ndist;){for(;Be=i.lencode[c&(1<<i.lenbits)-1],me=Be>>>24,ke=Be>>>16&255,_e=65535&Be,!(me<=h);){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if(_e<16)c>>>=me,h-=me,i.lens[i.have++]=_e;else{if(16===_e){for(Ee=me+2;h<Ee;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if(c>>>=me,h-=me,0===i.have){e.msg="invalid bit length repeat",i.mode=ce;break}xe=i.lens[i.have-1],m=3+(3&c),c>>>=2,h-=2}else if(17===_e){for(Ee=me+3;h<Ee;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}c>>>=me,h-=me,xe=0,m=3+(7&c),c>>>=3,h-=3}else{for(Ee=me+7;h<Ee;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}c>>>=me,h-=me,xe=0,m=11+(127&c),c>>>=7,h-=7}if(i.have+m>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=ce;break}for(;m--;)i.lens[i.have++]=xe}}if(i.mode===ce)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=ce;break}if(i.lenbits=9,Se={bits:i.lenbits},ye=x(S,i.lens,0,i.nlen,i.lencode,0,i.work,Se),i.lenbits=Se.bits,ye){e.msg="invalid literal/lengths set",i.mode=ce;break}if(i.distbits=6,i.distcode=i.distdyn,Se={bits:i.distbits},ye=x(E,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,Se),i.distbits=Se.bits,ye){e.msg="invalid distances set",i.mode=ce;break}if(i.mode=ie,t===A)break e;case ie:i.mode=ne;case ne:if(f>=6&&l>=258){e.next_out=s,e.avail_out=l,e.next_in=o,e.avail_in=f,i.hold=c,i.bits=h,p(e,w),s=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,a=e.input,f=e.avail_in,c=i.hold,h=i.bits,i.mode===X&&(i.back=-1);break}for(i.back=0;Be=i.lencode[c&(1<<i.lenbits)-1],me=Be>>>24,ke=Be>>>16&255,_e=65535&Be,!(me<=h);){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if(ke&&0===(240&ke)){for(ge=me,ve=ke,pe=_e;Be=i.lencode[pe+((c&(1<<ge+ve)-1)>>ge)],me=Be>>>24,ke=Be>>>16&255,_e=65535&Be,!(ge+me<=h);){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}c>>>=ge,h-=ge,i.back+=ge}if(c>>>=me,h-=me,i.back+=me,i.length=_e,0===ke){i.mode=fe;break}if(32&ke){i.back=-1,i.mode=X;break}if(64&ke){e.msg="invalid literal/length code",i.mode=ce;break}i.extra=15&ke,i.mode=ae;case ae:if(i.extra){for(Ee=i.extra;h<Ee;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}i.length+=c&(1<<i.extra)-1,c>>>=i.extra,h-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=re;case re:for(;Be=i.distcode[c&(1<<i.distbits)-1],me=Be>>>24,ke=Be>>>16&255,_e=65535&Be,!(me<=h);){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if(0===(240&ke)){for(ge=me,ve=ke,pe=_e;Be=i.distcode[pe+((c&(1<<ge+ve)-1)>>ge)],me=Be>>>24,ke=Be>>>16&255,_e=65535&Be,!(ge+me<=h);){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}c>>>=ge,h-=ge,i.back+=ge}if(c>>>=me,h-=me,i.back+=me,64&ke){e.msg="invalid distance code",i.mode=ce;break}i.offset=_e,i.extra=15&ke,i.mode=oe;case oe:if(i.extra){for(Ee=i.extra;h<Ee;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}i.offset+=c&(1<<i.extra)-1,c>>>=i.extra,h-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=ce;break}i.mode=se;case se:if(0===l)break e;if(m=w-l,i.offset>m){if(m=i.offset-m,m>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=ce;break}m>i.wnext?(m-=i.wnext,k=i.wsize-m):k=i.wnext-m,m>i.length&&(m=i.length),we=i.window}else we=r,k=s-i.offset,m=i.length;m>l&&(m=l),l-=m,i.length-=m;do r[s++]=we[k++];while(--m);0===i.length&&(i.mode=ne);break;case fe:if(0===l)break e;r[s++]=i.length,l--,i.mode=ne;break;case le:if(i.wrap){for(;h<32;){if(0===f)break e;f--,c|=a[o++]<<h,h+=8}if(w-=l,e.total_out+=w,i.total+=w,w&&(e.adler=i.check=i.flags?v(i.check,r,w,s-w):g(i.check,r,w,s-w)),w=l,(i.flags?c:n(c))!==i.check){e.msg="incorrect data check",i.mode=ce;break}c=0,h=0}i.mode=de;case de:if(i.wrap&&i.flags){for(;h<32;){if(0===f)break e;f--,c+=a[o++]<<h,h+=8}if(c!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=ce;break}c=0,h=0}i.mode=ue;case ue:ye=R;break e;case ce:ye=O;break e;case he:return I;case be:default:return C}return e.next_out=s,e.avail_out=l,e.next_in=o,e.avail_in=f,i.hold=c,i.bits=h,(i.wsize||w!==e.avail_out&&i.mode<ce&&(i.mode<le||t!==B))&&u(e,e.output,e.next_out,w-e.avail_out)?(i.mode=he,I):(b-=e.avail_in,w-=e.avail_out,e.total_in+=b,e.total_out+=w,i.total+=w,i.wrap&&w&&(e.adler=i.check=i.flags?v(i.check,r,w,e.next_out-w):g(i.check,r,w,e.next_out-w)),e.data_type=i.bits+(i.last?64:0)+(i.mode===X?128:0)+(i.mode===ie||i.mode===Q?256:0),(0===b&&0===w||t===B)&&ye===z&&(ye=T),ye)}function h(e){if(!e||!e.state)return C;var t=e.state;return t.window&&(t.window=null),e.state=null,z}function b(e,t){var i;return e&&e.state?(i=e.state,0===(2&i.wrap)?C:(i.head=t,t.done=!1,z)):C}function w(e,t){var i,n,a,r=t.length;return e&&e.state?(i=e.state,0!==i.wrap&&i.mode!==G?C:i.mode===G&&(n=1,n=g(n,t,r,0),n!==i.check)?O:(a=u(e,t,r,r))?(i.mode=he,I):(i.havedict=1,z)):C}var m,k,_=e("../utils/common"),g=e("./adler32"),v=e("./crc32"),p=e("./inffast"),x=e("./inftrees"),y=0,S=1,E=2,B=4,Z=5,A=6,z=0,R=1,N=2,C=-2,O=-3,I=-4,T=-5,U=8,D=1,F=2,L=3,H=4,M=5,j=6,K=7,P=8,Y=9,q=10,G=11,X=12,W=13,J=14,Q=15,V=16,$=17,ee=18,te=19,ie=20,ne=21,ae=22,re=23,oe=24,se=25,fe=26,le=27,de=28,ue=29,ce=30,he=31,be=32,we=852,me=592,ke=15,_e=ke,ge=!0;i.inflateReset=o,i.inflateReset2=s,i.inflateResetKeep=r,i.inflateInit=l,i.inflateInit2=f,i.inflate=c,i.inflateEnd=h,i.inflateGetHeader=b,i.inflateSetDictionary=w,i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":1,"./adler32":3,"./crc32":5,"./inffast":7,"./inftrees":9}],9:[function(e,t,i){"use strict";var n=e("../utils/common"),a=15,r=852,o=592,s=0,f=1,l=2,d=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],u=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],c=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],h=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,i,b,w,m,k,_){var g,v,p,x,y,S,E,B,Z,A=_.bits,z=0,R=0,N=0,C=0,O=0,I=0,T=0,U=0,D=0,F=0,L=null,H=0,M=new n.Buf16(a+1),j=new n.Buf16(a+1),K=null,P=0;for(z=0;z<=a;z++)M[z]=0;for(R=0;R<b;R++)M[t[i+R]]++;for(O=A,C=a;C>=1&&0===M[C];C--);if(O>C&&(O=C),0===C)return w[m++]=20971520,w[m++]=20971520,_.bits=1,0;for(N=1;N<C&&0===M[N];N++);for(O<N&&(O=N),U=1,z=1;z<=a;z++)if(U<<=1,U-=M[z],U<0)return-1;if(U>0&&(e===s||1!==C))return-1;for(j[1]=0,z=1;z<a;z++)j[z+1]=j[z]+M[z];for(R=0;R<b;R++)0!==t[i+R]&&(k[j[t[i+R]]++]=R);if(e===s?(L=K=k,S=19):e===f?(L=d,H-=257,K=u,P-=257,S=256):(L=c,K=h,S=-1),F=0,R=0,z=N,y=m,I=O,T=0,p=-1,D=1<<O,x=D-1,e===f&&D>r||e===l&&D>o)return 1;for(var Y=0;;){Y++,E=z-T,k[R]<S?(B=0,Z=k[R]):k[R]>S?(B=K[P+k[R]],Z=L[H+k[R]]):(B=96,Z=0),g=1<<z-T,v=1<<I,N=v;do v-=g,w[y+(F>>T)+v]=E<<24|B<<16|Z|0;while(0!==v);for(g=1<<z-1;F&g;)g>>=1;if(0!==g?(F&=g-1,F+=g):F=0,R++,0===--M[z]){if(z===C)break;z=t[i+k[R]]}if(z>O&&(F&x)!==p){for(0===T&&(T=O),y+=N,I=z-T,U=1<<I;I+T<C&&(U-=M[I+T],!(U<=0));)I++,U<<=1;if(D+=1<<I,e===f&&D>r||e===l&&D>o)return 1;p=F&x,w[p]=O<<24|I<<16|y-m|0}}return 0!==F&&(w[y+F]=z-T<<24|64<<16|0),_.bits=O,0}},{"../utils/common":1}],10:[function(e,t,i){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],11:[function(e,t,i){"use strict";function n(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}t.exports=n},{}],"/lib/inflate.js":[function(e,t,i){"use strict";function n(e){if(!(this instanceof n))return new n(e);this.options=s.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0===(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var i=o.inflateInit2(this.strm,t.windowBits);if(i!==l.Z_OK)throw new Error(d[i]);this.header=new c,o.inflateGetHeader(this.strm,this.header)}function a(e,t){var i=new n(t);if(i.push(e,!0),i.err)throw i.msg;return i.result}function r(e,t){return t=t||{},t.raw=!0,a(e,t)}var o=e("./zlib/inflate"),s=e("./utils/common"),f=e("./utils/strings"),l=e("./zlib/constants"),d=e("./zlib/messages"),u=e("./zlib/zstream"),c=e("./zlib/gzheader"),h=Object.prototype.toString;n.prototype.push=function(e,t){var i,n,a,r,d,u,c=this.strm,b=this.options.chunkSize,w=this.options.dictionary,m=!1;if(this.ended)return!1;n=t===~~t?t:t===!0?l.Z_FINISH:l.Z_NO_FLUSH,"string"==typeof e?c.input=f.binstring2buf(e):"[object ArrayBuffer]"===h.call(e)?c.input=new Uint8Array(e):c.input=e,c.next_in=0,c.avail_in=c.input.length;do{if(0===c.avail_out&&(c.output=new s.Buf8(b),c.next_out=0,c.avail_out=b),i=o.inflate(c,l.Z_NO_FLUSH),i===l.Z_NEED_DICT&&w&&(u="string"==typeof w?f.string2buf(w):"[object ArrayBuffer]"===h.call(w)?new Uint8Array(w):w,i=o.inflateSetDictionary(this.strm,u)),i===l.Z_BUF_ERROR&&m===!0&&(i=l.Z_OK,m=!1),i!==l.Z_STREAM_END&&i!==l.Z_OK)return this.onEnd(i),this.ended=!0,!1;c.next_out&&(0!==c.avail_out&&i!==l.Z_STREAM_END&&(0!==c.avail_in||n!==l.Z_FINISH&&n!==l.Z_SYNC_FLUSH)||("string"===this.options.to?(a=f.utf8border(c.output,c.next_out),r=c.next_out-a,d=f.buf2string(c.output,a),c.next_out=r,c.avail_out=b-r,r&&s.arraySet(c.output,c.output,a,r,0),this.onData(d)):this.onData(s.shrinkBuf(c.output,c.next_out)))),0===c.avail_in&&0===c.avail_out&&(m=!0)}while((c.avail_in>0||0===c.avail_out)&&i!==l.Z_STREAM_END);return i===l.Z_STREAM_END&&(n=l.Z_FINISH),n===l.Z_FINISH?(i=o.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===l.Z_OK):n!==l.Z_SYNC_FLUSH||(this.onEnd(l.Z_OK),c.avail_out=0,!0)},n.prototype.onData=function(e){this.chunks.push(e)},n.prototype.onEnd=function(e){e===l.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},i.Inflate=n,i.inflate=a,i.inflateRaw=r,i.ungzip=a},{"./utils/common":1,"./utils/strings":2,"./zlib/constants":4,"./zlib/gzheader":6,"./zlib/inflate":8,"./zlib/messages":10,"./zlib/zstream":11}]},{},[])("/lib/inflate.js")});\n<\/script>\n<script src="faview.js"><\/script>'}function o(e){var t=new Uint8Array(e),n="",r=0,i=0,a=0,o=0;for(t.length>=3&&239===t[0]&&187===t[1]&&191===t[2]&&(r=3);r<t.length;)if((i=t[r])<128)n+=String.fromCharCode(i),r++;else if(i>191&&i<224){if(r+1>=t.length)throw"UTF-8 Decode failed. Two byte character was truncated.";a=t[r+1],n+=String.fromCharCode((31&i)<<6|63&a),r+=2}else{if(r+2>=t.length)throw"UTF-8 Decode failed. Multi byte character was truncated.";a=t[r+1],o=t[r+2],n+=String.fromCharCode((15&i)<<12|(63&a)<<6|63&o),r+=3}return n}Object.defineProperty(t,"__esModule",{value:!0});var s=n(0),l=function(){function e(e,t){this.index=e.index,this.hash=e.hash,this.name=e.name,this.width=e.width,this.height=e.height,this.originalWidth=e.originalWidth,this.originalHeight=e.originalHeight,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.data=e.data,this.deflated=e.deflated,this.tileSet=t}return e.prototype.export=function(e,t,n){if(this.deflated&&"binz"!==t)throw new Error("cannot export by '"+t+"' when have the compressed data");if(!this.deflated&&"binz"===t)throw new Error("cannot export by '"+t+"' when have the uncompressed data");switch(e){case"tmx":return this.exportTMX(t,n);case"json":return this.exportJSON(t,n);case"js":return this.exportJS(t,n);case"raw":return this.exportRaw(t)}throw new Error("unknown file format: "+e)},e.prototype.exportRaw=function(e){switch(e){case"csv":return new Blob([i(new Int32Array(this.data),this.width,"\n")],{type:"text/csv; charset=utf-8"});case"bin":return new Blob([this.data],{type:"application/octet-binary"});default:throw new Error("unknown tile format: "+e)}},e.prototype.exportJSON=function(e,t){for(var n=[],r=new Array(this.name.split("\\").length).join("..\\"),i=0;i<this.tileSet.length;++i)t?n.push(this.tileSet[i].getTileSetReference(r)):n.push(this.tileSet[i].getTileSet(r));var a={width:this.width,height:this.height,tilewidth:this.tileWidth,tileheight:this.tileHeight,nextobjectid:1,orientation:"orthogonal",renderorder:"right-down",version:1,propertytypes:{originalwidth:"int",originalheight:"int"},properties:{originalwidth:this.originalWidth,originalheight:this.originalHeight},tilesets:n,layers:[{height:this.height,name:this.name,opacity:1,type:"tilelayer",visible:!0,width:this.width,x:0,y:0}]};switch(e){case"csv":a.layers[0].data=Array.prototype.slice.call(new Int32Array(this.data));break;case"bin":a.layers[0].encoding="base64",a.layers[0].data=o(d.encode(this.data));break;case"binz":a.layers[0].encoding="base64",a.layers[0].compression="zlib",a.layers[0].data=o(d.encode(this.data));break;default:throw new Error("unknown tile format: "+e)}return new Blob([JSON.stringify(a)],{type:"application/json; charset=utf-8"})},e.prototype.exportJS=function(e,t){return new Blob(["(function(name,data){\n if(typeof onTileMapLoaded === 'undefined') {\n  if(typeof TileMaps === 'undefined') TileMaps = {};\n  TileMaps[name] = data;\n } else {\n  onTileMapLoaded(name, data);\n }})(",JSON.stringify(this.name),", ",this.exportJSON(e,t),");"],{type:"text/javascript; charset=utf-8"})},e.prototype.exportTMX=function(e,t){for(var n=['<?xml version="1.0" encoding="UTF-8"?>\n','<map version="1.0" orientation="orthogonal" renderorder="right-down"',' width="'+this.width+'" height="'+this.height+'"',' tilewidth="'+this.tileWidth+'" tileheight="'+this.tileHeight+'" nextobjectid="1">\n',"\t<properties>\n",'\t\t<property name="originalWidth" type="int" value="'+this.originalWidth+'"/>\n','\t\t<property name="originalHeight" type="int" value="'+this.originalHeight+'"/>\n',"\t</properties>\n"],a=new Array(this.name.split("\\").length).join("..\\"),o=0;o<this.tileSet.length;++o)t?n.push("\t"+this.tileSet[o].getTileSetReferenceTag(a)+"\n"):n.push("\t"+this.tileSet[o].getTileSetTag(a)+"\n");switch(n.push('\t<layer name="'+this.name+'" width="'+this.width+'" height="'+this.height+'">\n'),e){case"csv":n.push('\t\t<data encoding="csv">\n'),n.push(i(new Int32Array(this.data),this.width,",\n"));break;case"xml":n.push("\t\t<data>\n"),n.push(r(new Int32Array(this.data),"\t\t\t","\n"));break;case"bin":n.push('\t\t<data encoding="base64">\n\t\t\t'),n.push(d.encode(this.data));break;case"binz":n.push('\t\t<data encoding="base64" compression="zlib">\n\t\t\t'),n.push(d.encode(this.data));break;default:throw new Error("unknown tile format: "+e)}return n.push("\n\t\t</data>\n\t</layer>\n</map>"),new Blob(n,{type:"text/xml; charset=utf-8"})},e}();t.Image=l;var c=function(){function e(e,t,n){this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.tileCount=e.tileCount,this.columns=e.columns,this.width=e.width,this.height=e.height,this.data=e.data,this.gid=t,this.filename=n}return e.prototype.getImage=function(e){var t=new Uint8Array(this.data),n=Math.sqrt(t.length>>2),r=e.createElement("canvas");r.width=n,r.height=n;var i=r.getContext("2d");if(!i)throw new Error("cannot get CanvasRenderingContext2D");for(var a=i.createImageData(n,n),o=a.data,s=4*n,l=4*a.width,c=0;c<n;++c)for(var u=c*s,h=c*l,f=0;f<s;++f)o[h+f]=t[u+f];return i.putImageData(a,0,0),r},e.prototype.export=function(){return'<?xml version="1.0" encoding="UTF-8"?>\n<tileset name="'+this.filename+'" tilewidth="'+this.tileWidth+'" tileheight="'+this.tileHeight+'" tilecount="'+this.tileCount+'" columns="'+this.columns+'">\n   <image source="'+this.filename+'.png" width="'+this.width+'" height="'+this.height+'"/>\n</tileset>'},e.prototype.getTileSetReferenceTag=function(e){return'<tileset firstgid="'+this.gid+'" source="'+e+this.filename+'.tsx"/>'},e.prototype.getTileSetTag=function(e){return'<tileset firstgid="'+this.gid+'" name="'+this.filename+'" tilewidth="'+this.tileWidth+'" tileheight="'+this.tileHeight+'" tilecount="'+this.tileCount+'" columns="'+this.columns+'"><image source="'+e+this.filename+'.png" width="'+this.width+'" height="'+this.height+'"/></tileset>'},e.prototype.getTileSetReference=function(e){return{firstgid:this.gid,source:e+this.filename+".tsx"}},e.prototype.getTileSet=function(e){return{columns:this.columns,firstgid:this.gid,image:e+this.filename+".png",imageheight:this.height,imagewidth:this.width,margin:0,name:this.filename,spacing:0,tilecount:this.tileCount,tileheight:this.tileHeight,tilewidth:this.tileWidth}},e}();t.Tsx=c;var u=function(){function e(){this._tileSize=16,this._chopper=[],this._tile=new Map,this._images=[],this.numWorkers=4,this.queueMax=3,this.index=0;for(var e=0;e<this.numWorkers;++e)this._chopper.push(new h)}return e.prototype._waitReadyChopper=function(e,t){var n=this,r=function(){for(var i=0;i<n._chopper.length;++i)if(n._chopper[i].tasks<=e)return void t(n._chopper[i]);setTimeout(function(){return r()},100)};r()},e.prototype._add=function(e,t,n,r,i){var a=this;return new Promise(function(o){a._waitReadyChopper(a.queueMax,function(s){s.chop(e,t,n,r,i,a._tileSize,function(e,t){t.forEach(function(e,t){var n=a._tile.get(t);n?n.p>e.p&&(n.p=e.p):a._tile.set(t,e)}),a._images.push(e)}),o()})})},e.prototype.add=function(e,t,n){var r;if(t instanceof HTMLImageElement){var i=document.createElement("canvas");i.width=t.width,i.height=t.height,r=i.getContext("2d"),r&&r.drawImage(t,0,0)}else r=t.getContext("2d");if(!r)throw new Error("cannot get CanvasRenderingContext2D");var a=r.getImageData(0,0,r.canvas.width,r.canvas.height);this._add(this.index++,e,a.data.buffer,t.width,t.height).then(n)},e.prototype.finish=function(e,t,n,r){var i=this,a=function(){for(var o=!0,s=0;s<i._chopper.length;++s)if(i._chopper[s].tasks>0){o=!1;break}if(o){var u=[],h=1;f.build(e,i._tile,i._images,i._tileSize,function(e,n,r){var i=new c(e,h,n.toString());u.push(i),h+=e.tileCount,t(i,n,r)},function(e,t,r){var i=new l(e,u);n(i,t,r)},r)}else setTimeout(function(){return a()},100)};a()},e}();t.Tileder=u;var h=function(){function e(){var t=this;this.worker=new Worker(e.createWorkerURL()),this._callbacks=[],this.worker.onmessage=function(e){var n=t._callbacks.shift();n&&n(e.data.data,e.data.tile)}}return e.prototype.chop=function(e,t,n,r,i,a,o){this._callbacks.push(o),this.worker.postMessage({index:e,name:t,buffer:n,width:r,height:i,tileSize:a},[n])},Object.defineProperty(e.prototype,"tasks",{get:function(){return this._callbacks.length},enumerable:!0,configurable:!0}),e._chop=function(e,t,n,r,i,a,o,s){for(var l=[],c=new Map,u=a<<2,h=new Uint8ClampedArray(n),f=new Uint8Array(4*a*a),d=Math.floor(r/a),p=Math.floor(i/a),v=Math.ceil(r/a),g=Math.ceil(i/a),m=r-d*a,w=i-d*a,y=new Uint32Array(v*g),b=0;b<p;++b)for(var x=b*a,k=0;k<d;++k){for(var S=0;S<a;++S)for(var A=4*((x+S)*r+k*a),E=S*a*4,_=0;_<a;++_)f[E++]=h[A++],f[E++]=h[A++],f[E++]=h[A++],f[E++]=h[A++];var L=o(f.buffer,s);if(!c.has(L)){var M=f.slice().buffer;l.push(M),c.set(L,{h:L,p:1e6*b+k,b:M})}y[b*v+k]=L}if(m){f.fill(0);for(var b=0;b<p;++b){for(var x=b*a,S=0;S<a;++S)for(var A=4*((x+S)*r+d*a),E=S*u,_=0;_<m;++_)f[E++]=h[A++],f[E++]=h[A++],f[E++]=h[A++],f[E++]=h[A++];var L=o(f.buffer,s);if(!c.has(L)){var M=f.slice().buffer;l.push(M),c.set(L,{h:L,p:1e6*b+d,b:M})}y[b*v+d]=L}}if(w){f.fill(0);for(var x=p*a,k=0;k<d;++k){for(var S=0;S<w;++S)for(var A=4*((x+S)*r+k*a),E=S*u,_=0;_<a;++_)f[E++]=h[A++],f[E++]=h[A++],f[E++]=h[A++],f[E++]=h[A++];var L=o(f.buffer,s);if(!c.has(L)){var M=f.slice().buffer;l.push(M),c.set(L,{h:L,p:1e6*p+k,b:M})}y[p*v+k]=L}}if(m&&w){f.fill(0);for(var x=p*a,S=0;S<w;++S)for(var A=4*((x+S)*r+d*a),E=S*u,_=0;_<m;++_)f[E++]=h[A++],f[E++]=h[A++],f[E++]=h[A++],f[E++]=h[A++];var L=o(f.buffer,s);if(!c.has(L)){var M=f.slice().buffer;l.push(M),c.set(L,{h:L,p:1e6*p+d,b:M})}y[p*v+d]=L}return l.push(y.buffer),[{index:e,hash:function(e){var t=new Array(33),n=e.length/32|0;t[0]=0;for(var r=0,i=0,a=0,o=0;r<e.length;++r)a+=e[r],++i===n&&(t[++o]=a,i=0,a=0);for(var s=0,r=1;r<t.length;++r)s=s<<1|(t[r]>t[r-1]?1:0);return s}(y),name:t,width:v,height:g,originalWidth:r,originalHeight:i,tileWidth:a,tileHeight:a,data:y.buffer,deflated:!1},c,l]},e.createWorkerURL=function(){return e.workerURL?e.workerURL:(e.workerURL=URL.createObjectURL(new Blob(["\n'use strict';\nvar crcTable = new Uint32Array("+JSON.stringify(Array.from(new Int32Array(s.getCRCTable().buffer)))+");\nvar crc32 = "+s.crc32.toString()+";\nvar chop = "+e._chop.toString()+";\nonmessage = function(e){\n    var d = e.data;\n    var ret = chop(d.index, d.name, d.buffer, d.width, d.height, d.tileSize, crc32, crcTable);\n    postMessage({data: ret[0], tile: ret[1]}, ret[2]);\n};"],{type:"text/javascript"})),e.workerURL)},e}(),f=function(){function e(){}return e.build=function(t,n,r,i,a,o,s){var l=new Worker(e.createWorkerURL());l.onmessage=function(e){var t=e.data;t.image?(o(t.image,t.index,t.total),t.index===t.total-1&&s()):a(t.tsx,t.index,t.total)};var c=[];n.forEach(function(e){c.push(e.b)});for(var u=0,h=r;u<h.length;u++){var f=h[u];c.push(f.data)}l.postMessage({compressMap:t,tile:n,images:r,tileSize:i},c)},e._finish=function(e,t,n,r,i,a,o,s,l){for(var c=i(t,r,s,a),u=function(e){return e=(1431655765&e)+(e>>>1&1431655765),e=(858993459&e)+(e>>>2&858993459),e=(252645135&e)+(e>>>4&252645135),(65535&(e=(16711935&e)+(e>>>8&16711935)))+(e>>>16&65535)},h=0,f=0;f<n.length;++f)if(0===n[f].index){h=n[f].hash;break}n.sort(function(e,t){if(e.hash===t.hash)return e.index===t.index?0:e.index<t.index?-1:1;var n=u(e.hash^h);return u(t.hash^h)<n?-1:1});for(var f=0;f<n.length;++f){for(var d=n[f],p=new Uint32Array(d.data),v=0;v<p.length;++v){var g=c.get(p[v]);if(void 0===g)throw new Error("chip "+p[v]+" is not found(logic error)");p[v]=g+1}e&&(d.data=o(new Uint8Array(d.data)).buffer,d.deflated=!0),l(d,f,n.length)}},e._calcImageSize=function(e,t){for(var n=t*e*e,r=64;r<=1024;r+=r)if(n<=r*r)return r;return 1024},e._buildTsx=function(e,t,n,r){var i=[];e.forEach(function(e){return i.push(e)});var a=i.length;i.sort(function(e,t){return e.p===t.p?e.h===t.h?0:e.h<t.h?-1:1:e.p<t.p?-1:1});for(var o=0,s=0;o<a;){var l=r(t,a-o)>>4;o+=l*l,++s}o=0;for(var c=new Map,u=0;u<s;++u){for(var h=r(t,a-o),f=4*h,d=h/t,p=new Uint8Array(h*f),l=h>>4,v=0;v<l&&o<a;++v)for(var g=v*t,m=0;m<l&&o<a;++m){for(var w=i[o],y=new Uint8Array(w.b),b=0;b<t;++b)for(var x=4*((g+b)*h+m*t),k=b*t*4,S=0;S<t;++S)p[x++]=y[k++],p[x++]=y[k++],p[x++]=y[k++],p[x++]=y[k++];c.set(w.h,o++)}n({tileWidth:t,tileHeight:t,tileCount:d*d,columns:d,width:h,height:h,data:p.buffer},u,s)}return c},e.createWorkerURL=function(){return e.workerURL?e.workerURL:(e.workerURL=URL.createObjectURL(new Blob(["\n'use strict';\nimportScripts('https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.3/pako_deflate.min.js');\nvar calcImageSize = "+e._calcImageSize.toString()+";\nvar buildTsx = "+e._buildTsx.toString()+";\nvar compress = function(a){ return pako.deflate(a); };\nvar finish = "+e._finish.toString()+";\nonmessage = function(e){\n    var d = e.data;\n    var ret = finish(\n        d.compressMap,\n        d.tile,\n        d.images,\n        d.tileSize,\n        buildTsx,\n        calcImageSize,\n        compress,\n        function(tsx, index, total){\n            postMessage({tsx: tsx, index: index, total: total}, [tsx.data]);\n        },\n        function(image, index, total){\n            postMessage({image: image, index: index, total: total}, [image.data]);\n        }\n    );\n};"],{type:"text/javascript"})),e.workerURL)},e}();t.getViewer=a;var d=function(){function e(){}return e.encode=function(t){for(var n,r=new Uint8Array(t),i=r.byteLength,a=i%3,o=i-a,s=e.table,l=new Uint8Array(o/3*4+(a?4:0)),c=-1,u=0;u<o;u+=3)n=r[u]<<16|r[u+1]<<8|r[u+2],l[++c]=s[(16515072&n)>>18],l[++c]=s[(258048&n)>>12],l[++c]=s[(4032&n)>>6],l[++c]=s[63&n];return 1===a?(n=r[o],l[++c]=s[(252&n)>>2],l[++c]=s[(3&n)<<4],l[++c]=61,l[++c]=61):2===a&&(n=r[o]<<8|r[o+1],l[++c]=s[(64512&n)>>10],l[++c]=s[(1008&n)>>4],l[++c]=s[(15&n)<<2],l[++c]=61),l.buffer},e.table=new Uint8Array([65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,48,49,50,51,52,53,54,55,56,57,43,47]),e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(){function e(){this.id=Date.now().toString()+Math.random().toString().substring(2),this.fileInfos=[]}return e.prototype.init=function(e,t){var n=this,r=indexedDB.open("zipper",2);r.onupgradeneeded=function(e){var t=r.result;if(t instanceof IDBDatabase){try{t.deleteObjectStore("file")}catch(e){}return void t.createObjectStore("file")}throw new Error("req.result is not IDBDatabase")},r.onerror=function(e){return t(e)},r.onsuccess=function(t){var i=r.result;if(i instanceof IDBDatabase)return n.db=i,n.gc(function(e){}),void e();throw new Error("req.result is not IDBDatabase")}},e.prototype.dispose=function(e){this.db.onerror=e;var t=this.db.transaction("file","readwrite");t.onerror=e;var n=t.objectStore("file");this.remove(n,this.id,e),this.gc(function(e){})},e.prototype.gc=function(e){var t=this;if(this.db){this.db.onerror=e;var n=this.db.transaction("file","readwrite");n.onerror=e;var r=n.objectStore("file"),i=r.openCursor(IDBKeyRange.bound("meta_","meta`",!1,!0)),a=(new Date).getTime()-6e4;i.onsuccess=function(n){var o=i.result;if(o&&o instanceof IDBCursorWithValue){if(o.value.lastMod.getTime()<a){var s=o.key;"string"==typeof s&&t.remove(r,s.split("_")[1],e)}return void o.continue()}},i.onerror=e}},e.gc=function(){(new e).init(function(){},function(e){})},e.prototype.remove=function(e,t,n){if(this.db){e.delete(IDBKeyRange.bound("body_"+t+"_","body_"+t+"`",!1,!0)).onsuccess=function(n){e.delete("meta_"+t)}}},e.prototype.add=function(e,t,n,r){this.addCore(e,t,!1,n,r)},e.prototype.addCompress=function(e,t,n,r){this.addCore(e,t,!0,n,r)},e.prototype.addCore=function(e,t,n,r,i){var o=this;if(this.db){var s=this.fileInfos.length,l=new a(e,t,n,function(e){o.db.onerror=i;var t=o.db.transaction("file","readwrite");t.onerror=i;var n=t.objectStore("file");n.put({lastMod:new Date},"meta_"+o.id);var a=n.put(new Blob([e],{type:"application/octet-binary"}),"body_"+o.id+"_"+s);a.onsuccess=function(e){return r()},a.onerror=i},i);this.fileInfos.push(l)}},e.prototype.generate=function(e,t){var n=this;if(!this.db)throw new Error("Zipper is already disposed");this.db.onerror=t;var r=this.db.transaction("file","readwrite");r.onerror=t,r.objectStore("file").put({lastMod:new Date},"meta_"+this.id),this.receiveFiles(function(t){var r=o.endOfCentralDirectorySize;n.fileInfos.forEach(function(e){r+=e.localFileHeaderSize+e.compressedFileSize+e.centralDirectoryRecordSize}),e(r>4294967295||n.fileInfos.length>65535?n.makeZIP64(t):n.makeZIP(t))},t)},e.prototype.receiveFiles=function(e,t){var n=this,r=this.fileInfos.length,i=new Array(this.fileInfos.length);this.db.onerror=t;var a=this.db.transaction("file","readonly");a.onerror=t;var o=a.objectStore("file");this.fileInfos.forEach(function(a,s){var l=o.get("body_"+n.id+"_"+s);l.onsuccess=function(t){var n=l.result;n instanceof Blob&&(i[s]=n,--r||e(i))},l.onerror=t})},e.prototype.makeZIP=function(e){var t=[];this.fileInfos.forEach(function(n,r){t.push(n.toLocalFileHeader(),e[r])});var n=0,r=0;return this.fileInfos.forEach(function(e){t.push(e.toCentralDirectoryRecord(n)),n+=e.compressedFileSize+e.localFileHeaderSize,r+=e.centralDirectoryRecordSize}),t.push(o.buildEndOfCentralDirectory(this.fileInfos.length,r,n)),new Blob(t,{type:"application/zip"})},e.prototype.makeZIP64=function(e){var t=[],n=0;this.fileInfos.forEach(function(r,i){t.push(r.toLocalFileHeader64(n),e[i]),n+=r.compressedFileSize+r.localFileHeaderSize64}),n=0;var r=0;return this.fileInfos.forEach(function(e){t.push(e.toCentralDirectoryRecord64(n)),n+=e.compressedFileSize+e.localFileHeaderSize64,r+=e.centralDirectoryRecordSize64}),t.push(s.buildEndOfCentralDirectory(this.fileInfos.length,r,n)),new Blob(t,{type:"application/zip"})},e}();t.Zipper=i;var a=function(){function e(e,t,n,i,a){var s=this;this.date=new Date;var l=2;this.size=t.size,this.compressedSize=t.size,n?(this.compressionMethod=8,++l):this.compressionMethod=0;var c,u=new FileReader;u.onload=function(e){var t=u.result;if(t instanceof ArrayBuffer){if(c=t,s.crc=r.crc32(t),!--l)return void i(c);n&&o.deflate(t,function(e){c=e,s.compressedSize=e.byteLength,--l||i(c)})}},u.onerror=function(e){return a(u.error)},u.readAsArrayBuffer(t);var h=new FileReader;h.onload=function(e){var t=h.result;t instanceof ArrayBuffer&&(s.name=t,--l||i(c))},h.onerror=function(e){return a(h.error)},h.readAsArrayBuffer(new Blob([e]))}return Object.defineProperty(e.prototype,"fileSize",{get:function(){return this.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"compressedFileSize",{get:function(){return this.compressedSize},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localFileHeaderSize",{get:function(){return o.calcLocalFileHeaderSize(this.name)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localFileHeaderSize64",{get:function(){return s.calcLocalFileHeaderSize(this.name)},enumerable:!0,configurable:!0}),e.prototype.toLocalFileHeader=function(){return o.buildLocalFileHeader(this.name,this.crc,this.date,this.compressionMethod,this.size,this.compressedSize)},e.prototype.toLocalFileHeader64=function(e){return s.buildLocalFileHeader(this.name,this.crc,this.date,this.compressionMethod,this.size,this.compressedSize,e)},Object.defineProperty(e.prototype,"centralDirectoryRecordSize",{get:function(){return o.calcCentralDirectoryRecordSize(this.name)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"centralDirectoryRecordSize64",{get:function(){return s.calcCentralDirectoryRecordSize(this.name)},enumerable:!0,configurable:!0}),e.prototype.toCentralDirectoryRecord=function(e){return o.buildCentralDirectoryRecord(this.name,this.crc,this.date,this.compressionMethod,this.size,this.compressedSize,e)},e.prototype.toCentralDirectoryRecord64=function(e){return s.buildCentralDirectoryRecord(this.name,this.crc,this.date,this.compressionMethod,this.size,this.compressedSize,e)},e}(),o=function(){function e(){}return e.calcLocalFileHeaderSize=function(e){return 30+e.byteLength+9+e.byteLength},e.buildLocalFileHeader=function(t,n,i,a,o,s){var l=e.formatDate(i),c=new ArrayBuffer(30),u=new ArrayBuffer(9),h=new DataView(c);return h.setUint32(0,67324752,!0),h.setUint16(4,10,!0),h.setUint16(6,2048,!0),h.setUint16(8,a,!0),h.setUint16(10,65535&l,!0),h.setUint16(12,l>>>16&65535,!0),h.setUint32(14,n,!0),h.setUint32(18,s,!0),h.setUint32(22,o,!0),h.setUint16(26,t.byteLength,!0),h.setUint16(28,u.byteLength+t.byteLength,!0),h=new DataView(u),h.setUint16(0,28789,!0),h.setUint16(2,5+t.byteLength,!0),h.setUint8(4,1),h.setUint32(5,r.crc32(t),!0),new Blob([c,t,u,t])},e.calcCentralDirectoryRecordSize=function(e){return 46+e.byteLength+9+e.byteLength},e.buildCentralDirectoryRecord=function(t,n,i,a,o,s,l){var c=e.formatDate(i),u=new ArrayBuffer(46),h=new ArrayBuffer(9),f=new DataView(u);return f.setUint32(0,33639248,!0),f.setUint16(4,20,!0),f.setUint16(6,10,!0),f.setUint16(8,2048,!0),f.setUint16(10,a,!0),f.setUint16(12,65535&c,!0),f.setUint16(14,c>>>16&65535,!0),f.setUint32(16,n,!0),f.setUint32(20,s,!0),f.setUint32(24,o,!0),f.setUint16(28,t.byteLength,!0),f.setUint16(30,h.byteLength+t.byteLength,!0),f.setUint16(32,0,!0),f.setUint16(34,0,!0),f.setUint16(36,0,!0),f.setUint32(38,0,!0),f.setUint32(42,l,!0),f=new DataView(h),f.setUint16(0,28789,!0),f.setUint16(2,5+t.byteLength,!0),f.setUint8(4,1),f.setUint32(5,r.crc32(t),!0),new Blob([u,t,h,t])},e.formatDate=function(e){return e||(e=new Date),(e.getFullYear()-1980<<9|e.getMonth()+1<<5|e.getDate())<<16|e.getHours()<<11|e.getMinutes()<<5|e.getSeconds()/2},Object.defineProperty(e,"endOfCentralDirectorySize",{get:function(){return 22},enumerable:!0,configurable:!0}),e.buildEndOfCentralDirectory=function(e,t,n){var r=new ArrayBuffer(22),i=new DataView(r);return i.setUint32(0,101010256,!0),i.setUint16(4,0,!0),i.setUint16(6,0,!0),i.setUint16(8,e,!0),i.setUint16(10,e,!0),i.setUint32(12,t,!0),i.setUint32(16,n,!0),i.setUint16(20,0,!0),new Blob([r])},e.deflate=function(t,n){e.worker||(e.worker=new Worker(e.createWorkerURL()),e.worker.onmessage=function(t){var n=e.compressQueue.shift();n&&n(t.data)}),e.compressQueue.push(n),e.worker.postMessage(t,[t])},e.createWorkerURL=function(){return e.workerURL?e.workerURL:(e.workerURL=URL.createObjectURL(new Blob(["\n'use strict';\nimportScripts('https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.3/pako_deflate.min.js');\nonmessage = function(e){\n   var b = pako.deflateRaw(e.data).buffer;\n   postMessage(b, [b]);\n}\n"],{type:"text/javascript"})),e.workerURL)},e.compressQueue=[],e}(),s=function(){function e(){}return e.calcLocalFileHeaderSize=function(e){return 30+e.byteLength+32+9+e.byteLength},e.buildLocalFileHeader=function(t,n,i,a,o,s,l){var c=e.formatDate(i),u=new ArrayBuffer(30),h=new ArrayBuffer(32),f=new ArrayBuffer(9),d=new DataView(u);return d.setUint32(0,67324752,!0),d.setUint16(4,45,!0),d.setUint16(6,2048,!0),d.setUint16(8,a,!0),d.setUint16(10,65535&c,!0),d.setUint16(12,c>>>16&65535,!0),d.setUint32(14,n,!0),d.setUint32(18,4294967295,!0),d.setUint32(22,4294967295,!0),d.setUint16(26,t.byteLength,!0),d.setUint16(28,h.byteLength+f.byteLength+t.byteLength,!0),d=new DataView(h),d.setUint16(0,1,!0),d.setUint16(2,28,!0),e.setUint64(d,4,o),e.setUint64(d,12,s),e.setUint64(d,20,l),d.setUint32(28,0),d=new DataView(f),d.setUint16(0,28789,!0),d.setUint16(2,5+t.byteLength,!0),d.setUint8(4,1),d.setUint32(5,r.crc32(t),!0),new Blob([u,t,h,f,t])},e.calcCentralDirectoryRecordSize=function(e){return 46+e.byteLength+32+9+e.byteLength},e.buildCentralDirectoryRecord=function(t,n,i,a,o,s,l){var c=e.formatDate(i),u=new ArrayBuffer(46),h=new ArrayBuffer(32),f=new ArrayBuffer(9),d=new DataView(u);return d.setUint32(0,33639248,!0),d.setUint16(4,45,!0),d.setUint16(6,45,!0),d.setUint16(8,2048,!0),d.setUint16(10,a,!0),d.setUint16(12,65535&c,!0),d.setUint16(14,c>>>16&65535,!0),d.setUint32(16,n,!0),d.setUint32(20,4294967295,!0),d.setUint32(24,4294967295,!0),d.setUint16(28,t.byteLength,!0),d.setUint16(30,h.byteLength+f.byteLength+t.byteLength,!0),d.setUint16(32,0,!0),d.setUint16(34,65535,!0),d.setUint16(36,0,!0),d.setUint32(38,0,!0),d.setUint32(42,4294967295,!0),d=new DataView(h),d.setUint16(0,1,!0),d.setUint16(2,28,!0),e.setUint64(d,4,o),e.setUint64(d,12,s),e.setUint64(d,20,l),d.setUint32(28,0),d=new DataView(f),d.setUint16(0,28789,!0),d.setUint16(2,5+t.byteLength,!0),d.setUint8(4,1),d.setUint32(5,r.crc32(t),!0),new Blob([u,t,h,f,t])},e.formatDate=function(e){return e||(e=new Date),(e.getFullYear()-1980<<9|e.getMonth()+1<<5|e.getDate())<<16|e.getHours()<<11|e.getMinutes()<<5|e.getSeconds()/2},Object.defineProperty(e,"endOfCentralDirectorySize",{get:function(){return 98},enumerable:!0,configurable:!0}),e.buildEndOfCentralDirectory=function(t,n,r){var i=new ArrayBuffer(22),a=new ArrayBuffer(56),o=new ArrayBuffer(20),s=new DataView(a);return s.setUint32(0,101075792,!0),e.setUint64(s,4,a.byteLength+o.byteLength+i.byteLength-12),s.setUint16(12,45,!0),s.setUint16(14,45,!0),s.setUint32(16,0,!0),s.setUint32(20,0,!0),e.setUint64(s,24,t),e.setUint64(s,32,t),e.setUint64(s,40,n),e.setUint64(s,48,r),s=new DataView(o),s.setUint32(0,117853008,!0),s.setUint32(4,0,!0),e.setUint64(s,8,r+n),s.setUint32(16,1,!0),s=new DataView(i),s.setUint32(0,101010256,!0),s.setUint16(4,65535,!0),s.setUint16(6,65535,!0),s.setUint16(8,65535,!0),s.setUint16(10,65535,!0),s.setUint32(12,4294967295,!0),s.setUint32(16,4294967295,!0),s.setUint16(20,0,!0),new Blob([a,o,i])},e.setUint64=function(e,t,n){e.setUint32(t,4294967295&n,!0),e.setUint32(t+4,Math.floor(n/4294967296),!0)},e}();i.gc()},function(e,t,n){"use strict";function r(e,t,n,r,l,c){return i(this,void 0,void 0,function(){var t;return a(this,function(i){switch(i.label){case 0:return[4,o.decompose(e,n,function(e){return r(e)},function(e){return l(e)},c)];case 1:return t=i.sent(),[2,s.generate(t,n,function(e,t){return c(2,e,t)})]}})})}var i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,a){function o(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(o,s)}l((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,a&&(o=a[2&n[0]?"return":n[0]?"throw":"next"])&&!(o=o.call(a,n[1])).done)return o;switch(a=0,o&&(n=[0,o.value]),n[0]){case 0:case 1:o=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,a=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(o=l.trys,!(o=o.length>0&&o[o.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){l.label=n[1];break}if(6===n[0]&&l.label<o[1]){l.label=o[1],o=n;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(n);break}o[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],a=0}finally{i=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,a,o,s,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var o=n(18),s=n(24);t.default=r},function(e,t,n){"use strict";function r(e,t,n,r,i){return f.decompose(e,t,n,r,i)}var i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,a){function o(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(o,s)}l((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,a&&(o=a[2&n[0]?"return":n[0]?"throw":"next"])&&!(o=o.call(a,n[1])).done)return o;switch(a=0,o&&(n=[0,o.value]),n[0]){case 0:case 1:o=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,a=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(o=l.trys,!(o=o.length>0&&o[o.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){l.label=n[1];break}if(6===n[0]&&l.label<o[1]){l.label=o[1],o=n;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(n);break}o[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],a=0}finally{i=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,a,o,s,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var o=n(19),s=n(20),l=n(2),c=n(22),u=n(3),h=n(23),f=function(){function e(e,t,n,r){this.tileSize=e,this.patternSet=t,this.renderFunc=n,this.renderSoloFunc=r,this.slicer=new s.Slicer(this.tileSize),this.hashesMap=new Map,this.chipMap=new Map,this.width=NaN,this.height=NaN,this.numTiles=NaN}return e.decompose=function(t,n,r,o,s){return i(this,void 0,void 0,function(){var i,l,c,u,h;return a(this,function(a){switch(a.label){case 0:return i=new e(t,n,r,o),[4,i.buildAreaMap(function(e,t){return s(0,e,t)})];case 1:return l=a.sent(),[4,i.buildHashes(l,function(e,t){return s(1,e,t)})];case 2:return c=a.sent(),u=c[0],h=c[1],[4,new d(i.width,i.height,i.tileSize,i.chipMap,h,u)];case 3:return[2,a.sent()]}})})},e.prototype.render=function(e,t,n){return i(this,void 0,void 0,function(){var r,i,o,s,l,c,u,h,f,d=this;return a(this,function(a){switch(a.label){case 0:return[4,this.renderFunc(t)];case 1:return r=a.sent(),[4,this.slicer.slice(r)];case 2:for(i=a.sent(),o=i[0],s=i[1],l=new Uint32Array(o,4),c=this.hashesMap.get(e),c||(c=new Map,this.hashesMap.set(e,c)),u=0,h=n;u<h.length;u++)f=h[u],c.set(f,l[f]);return s.forEach(function(e,t){var n=d.chipMap.get(t);if(!n)return void d.chipMap.set(t,e);var r=new Uint32Array(e),i=new Uint32Array(n);i[0]>r[0]&&(i[0]=r[0])}),[2]}})})},e.prototype.renderSolo=function(e){return this.renderSoloFunc(e)},e.prototype.buildAreaMap=function(e){return i(this,void 0,void 0,function(){var t,n,r,i,s,u,h,f,d=this;return a(this,function(a){switch(a.label){case 0:return t=this.patternSet.map(function(e){return e.length}).reduce(function(e,t){return e+t}),n=0,[4,this.renderSolo(this.patternSet.map(function(){return-1}))];case 1:return r=a.sent(),this.width=r.width,this.height=r.height,i=this.tileSize,this.numTiles=((r.width+i-1)/i|0)*((r.height+i-1)/i|0),s=new o.default(i),u=new Map,u.set(0,new l.BitArray(this.numTiles).buffer.buffer),h=this.patternSet,f=[],h.forEach(function(r,i){for(var a=0;a<r.length;++a)!function(r){var a=h.map(function(e,t){return t!==i?-1:r});f.push(d.renderSolo(a).then(function(e){return s.generate(e)}).then(function(e){return u.set(c.toIndexIncludingNone(a,h),e.buffer.buffer)}).then(function(){return e(++n,t)}))}(a)}),[4,Promise.all(f)];case 2:return a.sent(),[2,u]}})})},e.prototype.buildHashes=function(e,t){return i(this,void 0,void 0,function(){var n,r,i,o,s,f,d,p,v,g,m,w,y,b,x=this;return a(this,function(k){switch(k.label){case 0:return[4,h.default.create("prima-hashes",!0)];case 1:n=k.sent(),r=n.bulkWriter(104857600/(4*(this.numTiles+1))|0),i=this.patternSet,o=this.hashesMap,s=c.number(i),f=new Uint32Array(s),d=0,p=0,v=0,g=!1,m=0,w=function(){var h,w,b,k,S,A,E,_,L,M,C,U,j,z,T;return a(this,function(a){switch(a.label){case 0:return d>=s?(y.hashesMap.clear(),[4,r.flush()]):[3,2];case 1:return a.sent(),[2,{value:[n,f]}];case 2:for(h=c.fromIndex(d,i),w=h.map(function(t,n){var r=c.toIndexIncludingNone(h.map(function(e,r){return n===r?t:-1}),i),a=e.get(r);if(!a)throw new Error("#"+r+" AreaMap not found.");return new Uint32Array(a)}),b=y.numTiles,k=new Map,S=new Uint32Array(b+1),A=w.length,E=0;E<b;++E){for(_=new Array(A),L=0;L<A;++L)_[L]=l.get(w[L],E)?h[L]:-1;M=c.toIndexIncludingNone(_,i),C=o.get(M),C&&void 0!==(U=C.get(E))?S[E+1]=U:(j=k.get(M),j?j[1].push(E):k.set(M,[_,[E]]))}return k.size>0?(z=[],k.forEach(function(e,t){var n=e[0],r=e[1];return z.push(x.render(t,n,r))}),g=!0,[4,Promise.all(z)]):[3,4];case 3:return a.sent(),[2,"continue"];case 4:return S[0]=u.calcHash(new Uint32Array(S.buffer,4)),f[d]=S[0],g?++v:++p,g=!1,[4,r.set(d,S.buffer)];case 5:return a.sent(),(++d,(T=Date.now())-m>400)?(m=T,[4,t(d,s)]):[3,7];case 6:a.sent(),a.label=7;case 7:return[2]}})},y=this,k.label=2;case 2:return[5,w()];case 3:if("object"==typeof(b=k.sent()))return[2,b.value];k.label=4;case 4:return[3,2];case 5:return[2]}})})},e}();t.decompose=r;var d=function(){function e(e,t,n,r,i,a){if(this.width=e,this.height=t,this.tileSize=n,this.chipMap=r,this.patternDiffHashes=i,this.abstore=a,e<=0||t<=0)throw new Error("invalid image size: "+e+"x"+t)}return Object.defineProperty(e.prototype,"length",{get:function(){return this.patternDiffHashes.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"memory",{get:function(){var e=this.tileSize;return this.chipMap.size*(4+e*e*4+8)+this.patternDiffHashes.length*(((this.width+e-1)/e|0)*((this.height+e-1)/e|0)*4+4+8)},enumerable:!0,configurable:!0}),e.prototype.getPatternHashes=function(e){return i(this,void 0,void 0,function(){var t;return a(this,function(n){switch(n.label){case 0:return[4,this.abstore.get(e)];case 1:return t=n.sent(),[2,new Uint32Array(t,4)]}})})},e.prototype.popPatternHashes=function(e){return i(this,void 0,void 0,function(){var t;return a(this,function(n){switch(n.label){case 0:return[4,this.abstore.pop(e)];case 1:return t=n.sent(),[2,new Uint32Array(t,4)]}})})},e.prototype.render=function(e){return i(this,void 0,void 0,function(){var t,n,r,i,o,s,l,c,u,h;return a(this,function(a){switch(a.label){case 0:return[4,this.abstore.get(e)];case 1:if(t=a.sent(),n=new Uint32Array(t,4),r=this.width,i=this.height,o=this.tileSize,s=document.createElement("canvas"),s.width=r,s.height=i,!((l=s.getContext("2d"))instanceof CanvasRenderingContext2D))throw new Error("could not get CanvasRenderingContext2D");for(c=0,u=0;c<i;c+=o)for(h=0;h<r;h+=o)l.putImageData(this.getChipImage(n[u++]),h,c);return[2,s]}})})},e.prototype.getChipImage=function(e){var t=this.chipMap.get(e);if(!t)throw new Error("chip #"+("00000000"+e.toString(16)).slice(-8)+" is not found");for(var n=new ImageData(this.tileSize,this.tileSize),r=new Uint8Array(t,4),i=new Uint8Array(n.data.buffer),a=r.length,o=0;o<a;++o)i[o]=r[o];return n},e.prototype.getChipIndices=function(){var e=this.chipMap,t=new Uint32Array(e.size),n=0;e.forEach(function(e,r){return t[n++]=r}),t.sort(function(t,n){var r=new Uint32Array(e.get(t))[0],i=new Uint32Array(e.get(n))[0];return r!==i?r<i?-1:1:t===n?0:t<n?-1:1});for(var r=new Map,i=t.length,a=0;a<i;++a)r.set(t[a],a);return[t,r]},e.prototype.getPatternIndices=function(){for(var e=this.patternDiffHashes,t=e.length,n=new Uint32Array(t),r=0;r<t;++r)n[r]=r;var i=u.getComparer(e[0]);return n.sort(function(t,n){var r=e[t],a=e[n],o=i(r,a);return 0!==o?o:r<a?-1:1}),n},e}();t.DecomposedImage=d},function(e,t,n){"use strict";function r(e,t,n){if(t===e.width&&n===e.height&&e instanceof HTMLCanvasElement){var r=e.getContext("2d");if(!(r instanceof CanvasRenderingContext2D))throw new Error("could not get CanvasRenderingContext2D");return r.getImageData(0,0,t,n)}var i=document.createElement("canvas");i.width=t,i.height=n;var a=i.getContext("2d");if(!(a instanceof CanvasRenderingContext2D))throw new Error("could not get CanvasRenderingContext2D");return a.drawImage(e,0,0),a.getImageData(0,0,i.width,i.height)}Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),a=n(2),o=function(){function e(t){this.tileSize=t,this.worker=new i.PromiseWorker(e.createWorkerURL())}return e.prototype.generate=function(e){var t=this.tileSize,n=((e.width+t-1)/t|0)*t,i=((e.height+t-1)/t|0)*t,o=r(e,n,i);return this.worker.postMessage({image:o.data.buffer,width:n,height:i,tileSize:t},[o.data.buffer]).then(function(e){return new a.BitArray(e.buffer,e.length)})},Object.defineProperty(e.prototype,"tasks",{get:function(){return this.worker.waits},enumerable:!0,configurable:!0}),e._findRegion=function(e,t,n,r){for(var i,a,o,s=new Uint8Array(e),l=t/r|0,c=n/r|0,u=l*c,h=new Uint32Array(u+31>>>5),f=0;f<c;++f)for(var d=f*r,p=0;p<l;++p)e:for(var v=0;v<r;++v)for(var g=4*((d+v)*t+p*r),m=0;m<r;++m,g+=4)if(s[g+3]>0){i=f*l+p,a=i>>>5,o=i-(a<<5),h[a]|=1<<o;break e}return[h.buffer,u]},e.createWorkerURL=function(){return e.workerURL?e.workerURL:(e.workerURL=URL.createObjectURL(new Blob(["\n'use strict';\nvar findRegion = "+e._findRegion.toString()+";\nonmessage = function(e){\n    var d = e.data[1];\n    var ret = findRegion(d.image, d.width, d.height, d.tileSize);\n    postMessage({buffer: ret[0], length: ret[1]}, [ret[0]]);\n};"],{type:"text/javascript"})),e.workerURL)},e}();t.default=o},function(e,t,n){"use strict";function r(e,t,n){if(t===e.width&&n===e.height&&e instanceof HTMLCanvasElement){var r=e.getContext("2d");if(!(r instanceof CanvasRenderingContext2D))throw new Error("could not get CanvasRenderingContext2D");return r.getImageData(0,0,t,n)}var i=document.createElement("canvas");i.width=t,i.height=n;var a=i.getContext("2d");if(!(a instanceof CanvasRenderingContext2D))throw new Error("could not get CanvasRenderingContext2D");return a.drawImage(e,0,0),a.getImageData(0,0,i.width,i.height)}Object.defineProperty(t,"__esModule",{value:!0});var i=n(21),a=n(3),o=n(1),s=function(){function e(t){this.tileSize=t,this.worker=new o.PromiseWorker(e.createWorkerURL())}return e.prototype.slice=function(e){var t=this.tileSize,n=((e.width+t-1)/t|0)*t,i=((e.height+t-1)/t|0)*t,a=r(e,n,i);return this.worker.postMessage({imageData:a.data.buffer,width:n,height:i,tileSize:t},[a.data.buffer])},Object.defineProperty(e.prototype,"tasks",{get:function(){return this.worker.waits},enumerable:!0,configurable:!0}),e._slice=function(e,t,n,r,i,a,o){var s=[],l=new Map,c=new Uint8Array(e),u=t/r|0,h=n/r|0,f=new Uint32Array(1+u*h),d=new ArrayBuffer(4+4*r*r),p=new Uint8Array(d,4);l.set(i(p,a),d.slice(0));for(var v=0;v<h;++v)for(var g=v*r,m=0;m<u;++m){for(var w=0;w<r;++w)for(var y=4*((g+w)*t+m*r),b=w*r*4,x=0;x<r;++x)p[b++]=c[y++],p[b++]=c[y++],p[b++]=c[y++],p[b++]=c[y++];var k=i(p,a),S=v*u+m;if(!l.has(k)){var A=d.slice(0);new Uint32Array(A)[0]=S+1,s.push(A),l.set(k,A)}f[S+1]=k}return f[0]=o(new Uint32Array(f.buffer,4)),s.push(f.buffer),[f.buffer,l,s]},e.createWorkerURL=function(){return e.workerURL?e.workerURL:(e.workerURL=URL.createObjectURL(new Blob(["\n'use strict';\nvar crcTable = new Uint32Array("+JSON.stringify(Array.from(new Int32Array(i.crcTable.buffer)))+");\nvar crc32 = "+i.crc32.toString()+";\nvar calcHash = "+a.calcHash.toString()+";\nvar slice = "+e._slice.toString()+";\nonmessage = function(e){\n    var d = e.data[1];\n    var ret = slice(d.imageData, d.width, d.height, d.tileSize, crc32, crcTable, calcHash);\n    postMessage([ret[0], ret[1]], ret[2]);\n};"],{type:"text/javascript"})),e.workerURL)},e}();t.Slicer=s},function(e,t,n){"use strict";function r(e,n){n||(n=t.crcTable);for(var r=-1,i=0;i<e.length;i++)r=r>>>8^n[255&(r^e[i])];return(-1^r)>>>0}Object.defineProperty(t,"__esModule",{value:!0}),t.crcTable=new Uint32Array([0,1996959894,-301047508,-1727442502,124634137,1886057615,-379345611,-1637575261,249268274,2044508324,-522852066,-1747789432,162941995,2125561021,-407360249,-1866523247,498536548,1789927666,-205950648,-2067906082,450548861,1843258603,-187386543,-2083289657,325883990,1684777152,-43845254,-1973040660,335633487,1661365465,-99664541,-1928851979,997073096,1281953886,-715111964,-1570279054,1006888145,1258607687,-770865667,-1526024853,901097722,1119000684,-608450090,-1396901568,853044451,1172266101,-589951537,-1412350631,651767980,1373503546,-925412992,-1076862698,565507253,1454621731,-809855591,-1195530993,671266974,1594198024,-972236366,-1324619484,795835527,1483230225,-1050600021,-1234817731,1994146192,31158534,-1731059524,-271249366,1907459465,112637215,-1614814043,-390540237,2013776290,251722036,-1777751922,-519137256,2137656763,141376813,-1855689577,-429695999,1802195444,476864866,-2056965928,-228458418,1812370925,453092731,-2113342271,-183516073,1706088902,314042704,-1950435094,-54949764,1658658271,366619977,-1932296973,-69972891,1303535960,984961486,-1547960204,-725929758,1256170817,1037604311,-1529756563,-740887301,1131014506,879679996,-1385723834,-631195440,1141124467,855842277,-1442165665,-586318647,1342533948,654459306,-1106571248,-921952122,1466479909,544179635,-1184443383,-832445281,1591671054,702138776,-1328506846,-942167884,1504918807,783551873,-1212326853,-1061524307,-306674912,-1698712650,62317068,1957810842,-355121351,-1647151185,81470997,1943803523,-480048366,-1805370492,225274430,2053790376,-468791541,-1828061283,167816743,2097651377,-267414716,-2029476910,503444072,1762050814,-144550051,-2140837941,426522225,1852507879,-19653770,-1982649376,282753626,1742555852,-105259153,-1900089351,397917763,1622183637,-690576408,-1580100738,953729732,1340076626,-776247311,-1497606297,1068828381,1219638859,-670225446,-1358292148,906185462,1090812512,-547295293,-1469587627,829329135,1181335161,-882789492,-1134132454,628085408,1382605366,-871598187,-1156888829,570562233,1426400815,-977650754,-1296233688,733239954,1555261956,-1026031705,-1244606671,752459403,1541320221,-1687895376,-328994266,1969922972,40735498,-1677130071,-351390145,1913087877,83908371,-1782625662,-491226604,2075208622,213261112,-1831694693,-438977011,2094854071,198958881,-2032938284,-237706686,1759359992,534414190,-2118248755,-155638181,1873836001,414664567,-2012718362,-15766928,1711684554,285281116,-1889165569,-127750551,1634467795,376229701,-1609899400,-686959890,1308918612,956543938,-1486412191,-799009033,1231636301,1047427035,-1362007478,-640263460,1088359270,936918e3,-1447252397,-558129467,1202900863,817233897,-1111625188,-893730166,1404277552,615818150,-1160759803,-841546093,1423857449,601450431,-1285129682,-1000256840,1567103746,711928724,-1274298825,-1022587231,1510334235,755167117]),t.crc32=r},function(e,t,n){"use strict";function r(e){var t=e.length;if(0===t)return 0;for(var n=1,r=t-1;r>=0;--r)n*=e[r].length;if(n>Number.MAX_SAFE_INTEGER)throw new Error("too many patterns");return n}function i(e,t){for(var n=t.length,r=0,i=1,a=n-1;a>=0;--a){if(e[a]>=t[a].length)throw new Error("parts index out of range");r+=e[a]*i,i*=t[a].length}return r}function a(e,t){if(e>=r(t))throw new Error("pattern index out of range");for(var n=t.length,i=new Array(n),a=n-1,o=void 0,s=void 0;a>=0;--a)o=t[a].length,s=e/o|0,i[a]=e-s*o,e=s;return i}function o(e,t){for(var n=t.length,r=0,i=1,a=n-1,o=void 0,s=void 0;a>=0;--a){if(o=t[a].length+1,(s=e[a]+1)>=o)throw new Error("parts index out of range");r+=s*i,i*=o}return r}function s(e,t){if(e>=r(t))throw new Error("pattern index out of range");for(var n=t.length,i=new Array(n),a=n-1,o=void 0,s=void 0;a>=0;--a)o=t[a].length+1,s=e/o|0,i[a]=e-s*o-1,e=s;return i}Object.defineProperty(t,"__esModule",{value:!0}),t.number=r,t.toIndex=i,t.fromIndex=a,t.toIndexIncludingNone=o,t.fromIndexIncludingNone=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.deleteDatabase=function(e){return new Promise(function(t){var n=indexedDB.deleteDatabase(e);n.onerror=function(e){return t()},n.onsuccess=function(e){return t()}})},e.openDatabase=function(e){var t=this;return new Promise(function(n,r){var i=indexedDB.open(e,1);i.onerror=function(e){return r(e)},i.onsuccess=function(e){return i.result instanceof IDBDatabase?n(i.result):r(new Error("could not get IDBDatabase"))},i.onupgradeneeded=function(e){if(!(i.result instanceof IDBDatabase))return r(new Error("could not get IDBDatabase"));var n=i.result;try{n.deleteObjectStore(t.storeName)}catch(e){}n.createObjectStore(t.storeName)}})},e.transactionReadOnly=function(e){return e.transaction(this.storeName,"readonly")},e.transactionReadWrite=function(e){return e.transaction(this.storeName,"readwrite")},e.delete=function(e,t){var n=this;return new Promise(function(r,i){var a=e.objectStore(n.storeName).delete(t);a.onsuccess=function(e){return r()},a.onerror=function(e){return i(e)}})},e.set=function(e,t,n){var r=this;return new Promise(function(i,a){var o=e.objectStore(r.storeName).put(n,t);o.onsuccess=function(e){return i()},o.onerror=function(e){return a(e)}})},e.get=function(e,t){var n=this;return new Promise(function(r,i){var a=e.objectStore(n.storeName).get(t);a.onsuccess=function(e){return r(a.result)},a.onerror=function(e){return i(e)}})},e.clean=function(e){var t=this;return new Promise(function(n,r){var i=e.objectStore(t.storeName),a=i.openKeyCursor();a.onsuccess=function(e){if(!(a.result instanceof IDBCursor))return n();i.delete(a.result.key),a.result.continue()},a.onerror=function(e){return r(e)}})},e.storeName="file",e}(),i=function(){function e(e){var t=this;this.tx=e,this.get=function(e){return r.get(t.tx,e)}}return e}(),a=function(){function e(e){var t=this;this.tx=e,this.get=function(e){return r.get(t.tx,e)},this.set=function(e,n){return r.set(t.tx,e,n)},this.delete=function(e){return r.delete(t.tx,e)},this.pop=function(e){return t.get(e).then(function(n){return t.delete(e).then(function(){return n})})},this.clean=function(){return r.clean(t.tx)}}return e}(),o=function(){function e(e,t){this.abstore=e,this.bufferSize=t,this.buffer=[]}return e.prototype.set=function(e,t){return this.buffer.push([e,t]),this.buffer.length<this.bufferSize?Promise.resolve():this.flush()},e.prototype.flush=function(){var e=this.abstore.transactionReadWrite(),t=Promise.all(this.buffer.map(function(t){var n=t[0],r=t[1];return e.set(n,r)})).then(function(){});return this.buffer=[],t},e}(),s=function(){function e(e){var t=this;this.db=e,this.set=function(e,n){return t.transactionReadWrite().set(e,n)},this.delete=function(e){return t.transactionReadWrite().delete(e)},this.get=function(e){return t.transactionReadOnly().get(e)},this.pop=function(e){return t.transactionReadWrite().pop(e)},this.clean=function(){return t.transactionReadWrite().clean()},this.transactionReadOnly=function(){return new i(r.transactionReadOnly(t.db))},this.transactionReadWrite=function(){return new a(r.transactionReadWrite(t.db))},this.bulkWriter=function(e){return new o(t,e)}}return e.create=function(t,n){return(n?r.deleteDatabase(t):Promise.resolve()).then(function(){return r.openDatabase(t)}).then(function(t){return new e(t)})},e}();t.default=s},function(e,t,n){"use strict";function r(e,t){for(var n=t*e*e,r=64;r<=1024;r+=r)if(n<=r*r)return r;return 1024}function i(e,t,n){for(var i=4*e,a=[],o=t.length,s=0;o>0;){for(var l=r(e,o),c=new Uint8Array(l*l*4),u=l/e|0,h=Math.min(u*u,o),f=0;f<h;++f,++s)for(var d=f/u|0,p=f-d*u,v=new Uint8Array(n.get(t[s]),4),g=0,m=d*l*i,w=m+l*i;m<w;m+=4*l)for(var y=m+p*i,b=y+i;y<b;++y,++g)c[y]=v[g];a.push([c,l,l]),o-=h}return a}function a(e){for(var t=e.length,n=0,r=0,i=0,a=0,o=0;n<t;)e[n]-=r,r+=e[n++],e[n]-=i,i+=e[n++],e[n]-=a,a+=e[n++],e[n]-=o,o+=e[n++];return e}function o(e,t,n){return new Promise(function(r){var i=new l.default(1024*(e.width*e.height<16777216?1:4)*1024),a=e.patternDiffHashes.length,o=e.getPatternIndices(),s=new DataView(new ArrayBuffer(4*a)),c=0,u=0,h=function(){if(u>=a)return e.abstore.clean().then(function(){return r([s.buffer,i])});s.setUint32(4*o[u],u,!0),e.getPatternHashes(o[u]).then(function(e){var r=new Uint32Array(e.length);e.forEach(function(e,n){return r[n]=t.get(e)+1}),i.addInt32Array(r).then(function(){++u;var e=Date.now();return e-c>400?(c=e,n(u,a)):Promise.resolve()}).then(h)})};h()})}function s(e,t,n){var r=e.getChipIndices(),s=r[0],c=r[1];return o(e,c,n).then(function(n){var r=n[0],o=n[1];return Promise.all([Promise.resolve().then(function(){var t=new DataView(new ArrayBuffer(18));return t.setUint32(0,1095650884,!0),t.setUint32(4,10,!0),t.setUint32(8,e.width,!0),t.setUint32(12,e.height,!0),t.setUint16(16,e.tileSize,!0),[[t.buffer],t.byteLength]}),Promise.all(i(e.tileSize,s,e.chipMap).map(function(e){var t=e[0],n=e[1],r=e[2],i=new l.default(4194304);return i.addUint8Array(a(t)),i.finish().then(function(e){var t=e[0],i=e[1],a=new DataView(new ArrayBuffer(16));return a.setUint32(0,541543753,!0),a.setUint32(4,8+i,!0),a.setUint32(8,n,!0),a.setUint32(12,r,!0),t.unshift(a.buffer),[t,a.byteLength+i]})})),Promise.resolve().then(function(){var e=new Blob([JSON.stringify(t)],{type:"application/json; charset=utf-8"}),n=new DataView(new ArrayBuffer(8));return n.setUint32(0,1314018384,!0),n.setUint32(4,e.size,!0),[[n.buffer,e],n.byteLength+e.size]}),Promise.resolve().then(function(){var e=new DataView(new ArrayBuffer(8));return e.setUint32(0,1347241033,!0),e.setUint32(4,r.byteLength,!0),[[e.buffer,r],e.byteLength+r.byteLength]}),o.finish().then(function(e){var t=e[0],n=e[1],r=new l.default(4194304);return t.forEach(function(e){return r.addUint8Array(new Uint8Array(e))}),r.finish().then(function(e){var t=e[0],r=e[1],i=new DataView(new ArrayBuffer(12));return i.setUint32(0,1162627412,!0),i.setUint32(4,4+r,!0),i.setUint32(8,n,!0),t.unshift(i.buffer),[t,i.byteLength+r]})})]).then(function(e){var t=e[0],n=t[0],r=t[1],i=e[1],a=e[2],o=a[0],s=a[1],l=e[3],c=l[0],u=l[1],h=e[4],f=h[0],d=h[1],p=[],v=new DataView(new ArrayBuffer(8));return v.setUint32(0,1179011410,!0),v.setUint32(4,r+i.map(function(e){return e[1]}).reduce(function(e,t){return e+t})+s+u+d,!0),p.push(v.buffer),n.forEach(function(e){return p.push(e)}),i.forEach(function(e){return e[0].forEach(function(e){return p.push(e)})}),o.forEach(function(e){return p.push(e)}),c.forEach(function(e){return p.push(e)}),f.forEach(function(e){return p.push(e)}),new Blob(p,{type:"application/octet-binary"})})})}Object.defineProperty(t,"__esModule",{value:!0});var l=n(25);t.generate=s},function(e,t,n){"use strict";function r(e,t,n,r,i){for(var a=0;a<i;++a)e[n++]=t[r++]}function i(e,t,n,r,i){for(var a=new DataView(e.buffer),o=n+i;n<o;n+=4,++r)a.setInt32(n,t[r],!0)}function a(e,t,n){for(var r=0;r<n;++r)e[t++]=0}var o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,a){function o(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(o,s)}l((r=r.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,a&&(o=a[2&n[0]?"return":n[0]?"throw":"next"])&&!(o=o.call(a,n[1])).done)return o;switch(a=0,o&&(n=[0,o.value]),n[0]){case 0:case 1:o=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,a=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(o=l.trys,!(o=o.length>0&&o[o.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){l.label=n[1];break}if(6===n[0]&&l.label<o[1]){l.label=o[1],o=n;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(n);break}o[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],a=0}finally{i=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,a,o,s,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var l=n(1),c=n(26),u=function(){function e(){this.worker=new l.ThrottlePromiseWorker(e.createWorkerURL(),2,3)}return Object.defineProperty(e.prototype,"tasks",{get:function(){return this.worker.waits},enumerable:!0,configurable:!0}),e.prototype.compressHC=function(e){return this.worker.postMessage({buffer:e},[e])},e._compress=function(e,t,n){var r=n.compressBlockBound(e.byteLength);(!t||t.byteLength<r)&&(t=new Uint8Array(r));var i=n.compressBlockHC(new Uint8Array(e),t);return i>e.byteLength?[void 0,t]:[t.slice(0,i).buffer,t]},e.createWorkerURL=function(){return e.workerURL?e.workerURL:(e.workerURL=URL.createObjectURL(new Blob(["\n'use strict';\n"+c+"\nvar compBuffer = undefined;\nvar compress = "+e._compress.toString()+";\nonmessage = function(e){\n    var r = compress(e.data[1].buffer, compBuffer, LZ4);\n    if (r[0]) {\n        postMessage([r[0], true], [r[0]]);\n    } else {\n        postMessage([e.data[1].buffer, false], [e.data[1].buffer]);\n    }\n    compBuffer = r[1];\n};"],{type:"text/javascript"})),e.workerURL)},e}(),h=new u,f=function(){function e(e){if(this.bufferSize=e,this.buffers=[],this.buffer=new Uint8Array(this.bufferSize),this.used=0,1048576!==e&&4194304!==e)throw new Error("unsupported buffer size: "+e)}return e.prototype.compress=function(e){e&&a(this.buffer,e,this.buffer.length-e);var t=this.buffer.buffer;this.buffer=new Uint8Array(this.bufferSize),this.used=0;var n=h.compressHC(t);return this.buffers.push(n),n},e.prototype.addInt32Array=function(e){for(var t=[];;){if(this.bufferSize-this.used>=e.byteLength)return i(this.buffer,e,this.used,0,e.byteLength),this.used+=e.byteLength,Promise.all(t);var n=this.bufferSize-this.used;i(this.buffer,e,this.used,0,n),e=new Int32Array(e.buffer,e.byteOffset+n,e.byteLength-n>>2),t.push(this.compress())}},e.prototype.addUint8Array=function(e){for(var t=[];;){if(this.bufferSize-this.used>=e.byteLength)return r(this.buffer,e,this.used,0,e.byteLength),this.used+=e.byteLength,Promise.all(t);var n=this.bufferSize-this.used;r(this.buffer,e,this.used,0,n),e=new Uint8Array(e.buffer,e.byteOffset+n,e.byteLength-n),t.push(this.compress())}},e.prototype.finish=function(){return o(this,void 0,void 0,function(){var e,t,n,r,i,a,o,l,c,u,h;return s(this,function(s){switch(s.label){case 0:return 0!==this.used&&this.compress(this.used),[4,Promise.all(this.buffers)];case 1:switch(e=s.sent(),t=[],n=0,r=new ArrayBuffer(7),i=new DataView(r),i.setUint32(0,407708164,!0),this.bufferSize){case 1048576:i.setUint8(4,96),i.setUint8(5,96),i.setUint8(6,81);break;case 4194304:i.setUint8(4,96),i.setUint8(5,112),i.setUint8(6,115)}for(t.push(r),n+=r.byteLength,a=0,o=e;a<o.length;a++)l=o[a],c=l[0],u=l[1],h=new ArrayBuffer(4),new DataView(h).setUint32(0,c.byteLength|(u?0:2147483648),!0),t.push(h,c),n+=h.byteLength+c.byteLength;return t.push(new ArrayBuffer(4)),n+=4,[2,[t,n]]}})})},e}();t.default=f},function(e,t){e.exports='!function(r,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.LZ4=t():r.LZ4=t()}(this,function(){return function(r){function t(f){if(o[f])return o[f].exports;var e=o[f]={i:f,l:!1,exports:{}};return r[f].call(e.exports,e,e.exports,t),e.l=!0,e.exports}var o={};return t.m=r,t.c=o,t.d=function(r,o,f){t.o(r,o)||Object.defineProperty(r,o,{configurable:!1,enumerable:!0,get:f})},t.n=function(r){var o=r&&r.__esModule?function(){return r.default}:function(){return r};return t.d(o,"a",o),o},t.o=function(r,t){return Object.prototype.hasOwnProperty.call(r,t)},t.p="",t(t.s=0)}([function(r,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(r){for(var o in r)t.hasOwnProperty(o)||(t[o]=r[o])}(o(1))},function(r,t,o){"use strict";function f(r,t){var o=r>>>16&65535,f=65535&r,e=t>>>16&65535,i=65535&t;return f*i+(o*i+f*e<<16>>>0)|0}function e(r,t){return r[t+3]|r[t+2]<<8|r[t+1]<<16|r[t]<<24}function i(r,t,o,f,e){for(var i=0;i<e;++i)r[o++]=t[f++]}function n(r){var t=r.length;if(0===t)return 0;for(var o=0,f=0;;){var e=r[o]>>4,i=15&r[o];if(++o===t)throw w;if(e>0){if(15===e){for(;255===r[o];)if(e+=255,++o===t)throw w;if(e+=r[o],++o===t)throw w}if(f+=e,(o+=e)>=t)return f}if((o+=2)>=t)throw w;var n=r[o-2]|r[o-1]<<8;if(f-n<0||0===n)throw w;if(15===i){for(;255===r[o];)if(i+=255,++o===t)throw w;if(i+=r[o],++o===t)throw w}for(i+=4;i>=n;i-=n)f+=n;f+=i}}function u(r,t){var o=r.length,f=t.length;if(0===o)return 0;for(var e=0,n=0;;){var u=r[e]>>4,a=15&r[e];if(++e===o)throw w;if(u>0){if(15===u){for(;255===r[e];)if(u+=255,++e===o)throw w;if(u+=r[e],++e===o)throw w}if(f-n<u||e+u>o)throw l;if(i(t,r,n,e,u),n+=u,(e+=u)>=o)return n}if((e+=2)>=o)throw w;var h=r[e-2]|r[e-1]<<8;if(n-h<0||0===h)throw w;if(15===a){for(;255===r[e];)if(a+=255,++e===o)throw w;if(a+=r[e],++e===o)throw w}if(a+=4,f-n<=a)throw l;for(;a>=h;a-=h)i(t,t,n,n-h,h),n+=h;i(t,t,n,n-h,a),n+=a}}function a(r){return r+(r/255|0)+16}function h(r,t,o){var f=r.length-m,n=t.length;if(f<=0||0===n||o>=f)return 0;for(var u=0,a=0,h=new Uint32Array(g);u<o;){var c=j(e(r,u),x)>>>y;h[c]=++u}for(var w=u,p=1<<b;u<f-v;){var c=j(e(r,u),x)>>>y,d=h[c]-1;if(h[c]=u+1,d<0||u-d>>s>0||r[d]!==r[u]||r[d+1]!==r[u+1]||r[d+2]!==r[u+2]||r[d+3]!==r[u+3])u+=p>>b,++p;else{p=1<<b;var O=u-w,_=u-d;u+=v;for(var k=u;u<=f&&r[u]===r[u-_];)u++;if(k=u-k,t[a]=k<15?k:15,O<15)t[a]|=O<<4;else{if(t[a]|=240,++a===n)throw l;for(var B=O-15;B>=255;B-=255)if(t[a]=255,++a===n)throw l;t[a]=255&B}if(++a===n)throw l;if(a+O>=n)throw l;if(i(t,r,a,w,O),a+=O,w=u,(a+=2)>=n)throw l;if(t[a-2]=_,t[a-1]=_>>8,k>=15){for(k-=15;k>=255;k-=255)if(t[a]=255,++a===n)throw l;if(t[a]=k,++a===n)throw l}}}if(0===w)return 0;var M=r.length-w;if(M<15)t[a]=M<<4;else{if(t[a]=240,++a===n)throw l;for(M-=15;M>=255;M-=255)if(t[a]=255,++a===n)throw l;t[a]=M}if(++a===n)throw l;var P=r.length-w,U=a+P;if(U>n)throw l;return U>=f?0:(i(t,r,a,w,P),a+=P)}function c(r,t,o){var f=r.length-m,n=t.length;if(f<=0||0===n||o>=f)return 0;for(var u=0,a=0,h=new Uint32Array(g),c=new Uint32Array(p);u<o;){var w=j(e(r,u),x)>>>y;c[u&d]=h[w],h[w]=++u}for(var s=u;u<f-v;){for(var w=j(e(r,u),x)>>>y,b=0,O=0,_=h[w]-1;_>0&&_>u-p;_=c[_&d]-1)if(r[_+b]===r[u+b])for(var k=0;;++k)if(r[_+k]!==r[u+k]||u+k>f){b<k&&k>=v&&(b=k,O=u-_);break}if(c[u&d]=h[w],h[w]=u+1,0!==b){for(var B=u+1,k=u+b;B<k;){var M=j(e(r,B),x)>>>y;c[B&d]=h[M],h[M]=++B}var P=u-s;if(u+=b,b-=v,t[a]=b<15?b:15,P<15)t[a]|=P<<4;else{if(t[a]|=240,++a===n)throw l;for(var U=P-15;U>=255;U-=255)if(t[a]=255,++a===n)throw l;t[a]=255&U}if(++a===n)throw l;if(a+P>=n)throw l;if(i(t,r,a,s,P),a+=P,s=u,(a+=2)>=n)throw l;if(t[a-2]=O,t[a-1]=O>>8,b>=15){for(b-=15;b>=255;b-=255)if(t[a]=255,++a===n)throw l;if(t[a]=b,++a===n)throw l}}else++u}if(0===s)return 0;var A=r.length-s;if(A<15)t[a]=A<<4;else{if(t[a]=240,++a===n)throw l;for(A-=15;A>=255;A-=255)if(t[a]=255,++a===n)throw l;t[a]=A}if(++a===n)throw l;var L=r.length-s,E=a+L;if(E>n)throw l;return E>=f?0:(i(t,r,a,s,L),a+=L)}Object.defineProperty(t,"__esModule",{value:!0});var w=new Error("invalid source"),l=new Error("short buffer"),v=4,s=16,p=1<<s,d=p-1,g=65536,y=8*v-16,m=8+v,b=6,x=-1640531535,j=Math.imul?Math.imul:f;t.calcUncompressedLen=n,t.uncompressBlock=u,t.compressBlockBound=a,t.compressBlock=h,t.compressBlockHC=c}])});'}]);